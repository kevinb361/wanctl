# Batch Security Review: wanctl Steering Module
**Review Date:** 2026-01-08  
**Reviewer:** Claude Code (code-reviewer agent)  
**Scope:** All Python files in `/home/kevin/projects/wanctl/src/wanctl/steering/`  
**Context:** Production-critical network infrastructure (home network failover control)

---

## Executive Summary

Comprehensive security and reliability review of the wanctl steering module across 5 Python files (1,861 total lines of code). This system controls WAN routing decisions between ISPs, making it **production-critical infrastructure**.

### Overall Assessment

**Risk Level:** MEDIUM-HIGH  
**Production Readiness:** Requires hardening before extended production use  
**Code Quality:** Good (well-structured, documented, typed)  
**Critical Issues:** 5 must-fix security vulnerabilities  
**Reliability Issues:** 14 warnings that affect operational stability

### Summary Statistics

| Metric | Count |
|--------|-------|
| Total Files Reviewed | 5 |
| Total Lines of Code | 1,861 |
| Critical Issues (Security) | 5 |
| Warning Issues (Reliability) | 14 |
| Suggestions (Improvements) | 13 |
| Estimated Fix Time | 48-68 hours |

---

## Critical Issues Across All Files (Fix Immediately)

These are **security-critical vulnerabilities** that could lead to system compromise:

### 1. Command Injection via RouterOS Commands (daemon.py)
**Severity:** CRITICAL  
**Files:** daemon.py (lines 414, 447, 467)  
**Risk:** Arbitrary RouterOS command execution

**Description:**  
Mangle rule comments and queue names are interpolated into RouterOS commands without proper escaping. An attacker who can modify the YAML config can inject arbitrary RouterOS commands.

**Attack Example:**
```yaml
mangle_rule:
  comment: 'ADAPTIVE" ] ; /system reset-configuration ; #'
```

**Impact:** Full RouterOS compromise - config wipe, routing changes, credential exposure

**Fix Priority:** #1 - Fix immediately before any further production use

**Estimated Effort:** 4-6 hours (add validation regex, escape special chars, update config schema)

---

### 2. Command Injection via Queue Names (cake_stats.py)
**Severity:** CRITICAL  
**Files:** cake_stats.py (lines 62, 158, 170)  
**Risk:** Arbitrary RouterOS command execution

**Description:**  
CAKE queue names from config are interpolated into RouterOS commands without validation.

**Attack Example:**
```yaml
cake_queues:
  primary_download: 'WAN-Download-X"] ; /system reset-configuration ; #'
```

**Impact:** Same as #1 - full RouterOS compromise

**Fix Priority:** #1 (same batch as mangle rule comment fix)

**Estimated Effort:** 2 hours (add queue name validation)

---

### 3. Subprocess Command Injection via Ping Host (daemon.py)
**Severity:** CRITICAL  
**Files:** daemon.py (lines 509-544)  
**Risk:** Arbitrary command execution as daemon user

**Description:**  
Ping host from config is passed to subprocess without validation. While `subprocess.run()` with list args is safer than shell=True, host value is not validated.

**Attack Example:**
```yaml
measurement:
  ping_host: '8.8.8.8; rm -rf /'
```

**Impact:** Arbitrary command execution as daemon user (likely root)

**Fix Priority:** #2 - Critical but requires config modification

**Estimated Effort:** 2 hours (add IP/hostname validation using socket.inet_pton)

---

### 4. Unvalidated External Baseline RTT (daemon.py)
**Severity:** MEDIUM-HIGH  
**Files:** daemon.py (lines 558-590)  
**Risk:** Malicious baseline causes incorrect steering decisions

**Description:**  
Baseline RTT loaded from external state file (autorate) has overly permissive sanity bounds (5-100ms). A compromised autorate process can manipulate steering decisions.

**Attack Example:**
- Attacker modifies `/var/lib/wanctl/spectrum_state.json`
- Sets `baseline_rtt: 5.0` (when actual is 30ms)
- Steering calculates delta = 30 - 5 = 25ms (appears congested)
- Unnecessary steering activates

**Impact:** Denial of service (incorrect steering), potential ISP cost if alternate WAN is metered

**Fix Priority:** #3 - Tighten after monitoring baselines in production

**Estimated Effort:** 2 hours (tighten bounds, add baseline change rate tracking)

---

### 5. No Bounds Checking on EWMA Alpha (congestion_assessment.py)
**Severity:** MEDIUM  
**Files:** congestion_assessment.py (line 114)  
**Risk:** Invalid alpha causes erratic smoothing

**Description:**  
EWMA smoothing function doesn't validate alpha is in [0, 1]. Invalid values cause oscillation or unbounded growth.

**Attack Example:**
```yaml
thresholds:
  rtt_ewma_alpha: 2.0  # Invalid
```

**Impact:** Erratic congestion assessment, steering flapping, system instability

**Fix Priority:** #4 - Low risk if config is validated on load

**Estimated Effort:** 30 minutes (add bounds check)

---

## Warning Issues Across All Files (Reliability)

These issues affect **operational stability** but aren't security-critical:

### Daemon Reliability (daemon.py)

1. **W1: No Timeout on RouterOS Commands** (lines 408-482)
   - Risk: Daemon hangs indefinitely on network issues
   - Fix: Add timeout parameter to all `run_cmd()` calls
   - Effort: 30 minutes

2. **W2: State File Corruption Not Handled** (lines 254-264)
   - Risk: Daemon silently resets on corrupted state
   - Fix: Add backup state files, alert on corruption
   - Effort: 2 hours

3. **W3: Race Condition in State Save** (line 345)
   - Risk: Concurrent writes corrupt state
   - Fix: Add file locking (fcntl)
   - Effort: 1 hour

4. **W4: Unbounded History Growth** (lines 352-361)
   - Risk: Memory exhaustion on long-running daemon
   - Fix: Use collections.deque with maxlen
   - Effort: 1 hour

5. **W5: No Graceful Shutdown Handler** (lines 975-1043)
   - Risk: Incomplete state saves on SIGTERM
   - Fix: Add signal handlers for SIGTERM
   - Effort: 1 hour

6. **W6: Steering Rule Verification Race Condition** (lines 454-482)
   - Risk: False verification due to RouterOS processing delay
   - Fix: Add retry with exponential backoff
   - Effort: 2 hours

7. **W7: Ping Failure Causes Cycle Abort** (lines 904-906)
   - Risk: Single ping failure stops all steering decisions
   - Fix: Add retry, use last known RTT as fallback
   - Effort: 2 hours

8. **W8: CAKE Stats Read Failure Not Differentiated** (lines 887-890)
   - Risk: Silent failures mask RouterOS connectivity issues
   - Fix: Track consecutive failures, alert on sustained outage
   - Effort: 1 hour

### CAKE Stats Reliability (cake_stats.py)

9. **W9: No Timeout on RouterOS Commands** (lines 63, 159, 171)
   - Risk: Reader hangs on network failure
   - Fix: Add timeout parameter
   - Effort: 30 minutes

10. **W10: JSON Parsing Without Validation** (lines 74-92)
    - Risk: Malformed JSON crashes reader
    - Fix: Add try/except around json.loads()
    - Effort: 1 hour

11. **W11: Counter Reset Race Condition** (daemon.py lines 882-884)
    - Risk: Lost drop events between reset and read
    - Fix: Use delta tracking only (no resets)
    - Effort: 2 hours

### Phase 2B Reliability (steering_confidence.py)

12. **W12: Flap Detection Window Unbounded** (lines 397-403)
    - Risk: Memory growth on long-running systems
    - Fix: Prune before append or use deque
    - Effort: 1 hour

13. **W13: Time-Based Logic Without Clock Skew Protection** (lines 420-430)
    - Risk: System clock changes break penalty timer
    - Fix: Use time.monotonic() instead of time.time()
    - Effort: 2 hours

14. **W14: EWMA Alpha Not Validated** (congestion_assessment.py line 114)
    - Risk: Invalid alpha causes nonsensical smoothing
    - Fix: Add bounds check (0 <= alpha <= 1)
    - Effort: 30 minutes

---

## Cross-File Patterns (Systemic Issues)

These issues appear in multiple files and indicate systemic patterns:

### 1. Command Injection Pattern
**Affected Files:** daemon.py, cake_stats.py  
**Pattern:** RouterOS commands constructed from config without validation  
**Root Cause:** Missing input validation in config loading  
**Fix:** Centralized validation in config_base.py

### 2. Missing Timeouts Pattern
**Affected Files:** daemon.py, cake_stats.py  
**Pattern:** Network operations without timeout parameters  
**Root Cause:** Assumes RouterOS is always responsive  
**Fix:** Add default timeout config field, require timeout on all run_cmd()

### 3. Silent Failure Pattern
**Affected Files:** daemon.py (state load, CAKE stats), cake_stats.py (JSON parse)  
**Pattern:** Errors logged but execution continues with default values  
**Root Cause:** Fail-soft approach without alerting  
**Fix:** Add failure counters, alert on sustained failures

### 4. Unbounded Growth Pattern
**Affected Files:** daemon.py (histories), steering_confidence.py (flap window)  
**Pattern:** Append to list, trim after (not before)  
**Root Cause:** Manual list management instead of bounded collections  
**Fix:** Use collections.deque with maxlen throughout

---

## Suggestions (Improvements)

Non-critical improvements for long-term maintainability:

### Configuration & Tunability
- **S1:** Magic numbers in code instead of config (daemon.py baseline bounds)
- **S2:** ConfidenceWeights hardcoded (steering_confidence.py weights)

### Error Handling & Logging
- **S3:** Inconsistent error handling between legacy and CAKE-aware modes (daemon.py)
- **S4:** State machine logging too verbose at INFO level (daemon.py)
- **S5:** ImportError on Phase 2B not logged (__init__.py)

### Observability & Debugging
- **S6:** Transition history lacks context (daemon.py - no RTT/drops/queue in transitions)
- **S7:** No health check endpoint (daemon.py)
- **S8:** DryRunLogger could write to file (steering_confidence.py)

### Code Quality
- **S9:** StateThresholds validation uses assert (congestion_assessment.py)
- **S10:** assess_congestion_state() could return confidence score (congestion_assessment.py)
- **S11:** Regex parsing is fragile (cake_stats.py SSH output)
- **S12:** Delta tracking state not persisted (cake_stats.py restart issue)
- **S13:** compute_confidence() lacks unit tests (steering_confidence.py)

---

## Recommended Fix Order (Priority-Ranked)

Based on risk, impact, and dependencies:

### Phase 1: Security Hardening (Week 1)
1. **C1 + C2:** Command injection fixes (daemon.py + cake_stats.py)
   - Add validate_comment(), validate_queue_name() in config_base.py
   - Regex: `^[A-Za-z0-9:_ -]+$` (no special chars)
   - Effort: 4-6 hours

2. **C3:** Ping host validation (daemon.py)
   - Add validate_ping_host() using socket.inet_pton()
   - Effort: 2 hours

3. **C4:** Baseline RTT validation (daemon.py)
   - Tighten bounds (10-60ms)
   - Add baseline change rate tracking
   - Effort: 2 hours

4. **C5:** EWMA alpha validation (congestion_assessment.py)
   - Add bounds check (0 <= alpha <= 1)
   - Effort: 30 minutes

**Phase 1 Total:** 8-10 hours

### Phase 2: Operational Reliability (Week 2)
5. **W1 + W9:** Add timeouts to all RouterOS commands
   - daemon.py: 8 call sites
   - cake_stats.py: 3 call sites
   - Effort: 1 hour

6. **W6:** Steering rule verification retry (daemon.py)
   - Add exponential backoff
   - Effort: 2 hours

7. **W7:** Ping failure retry and fallback (daemon.py)
   - Effort: 2 hours

8. **W11:** Remove counter reset, use delta tracking only (cake_stats.py)
   - Effort: 2 hours

9. **W2:** State corruption handling (daemon.py)
   - Add backup state files
   - Effort: 2 hours

10. **W5:** Graceful shutdown (daemon.py)
    - Add SIGTERM handler
    - Effort: 1 hour

**Phase 2 Total:** 10 hours

### Phase 3: Robustness (Week 3)
11. **W3:** State save file locking (daemon.py)
12. **W4:** Use deque for histories (daemon.py)
13. **W8:** CAKE stats failure tracking (daemon.py)
14. **W10:** JSON parsing error handling (cake_stats.py)

**Phase 3 Total:** 5-6 hours

### Phase 4: Phase 2B Readiness (Future)
15. **W12-W13:** Phase 2B timer improvements (steering_confidence.py)
    - Only if Phase 2B deployment planned

**Phase 4 Total:** 3 hours

### Phase 5: Long-Term Improvements (Backlog)
16. **S1-S13:** Suggestions (config tunability, observability, tests)

**Phase 5 Total:** 15-20 hours

---

## Effort Estimates by File

| File | Critical | Warnings | Suggestions | Total Effort |
|------|----------|----------|-------------|--------------|
| daemon.py | 8-10 hrs | 14 hrs | 4 hrs | 26-28 hrs |
| cake_stats.py | 2 hrs | 3.5 hrs | 2 hrs | 7.5 hrs |
| congestion_assessment.py | 0.5 hrs | 0 | 3 hrs | 3.5 hrs |
| steering_confidence.py | 0 | 3 hrs | 6 hrs | 9 hrs |
| __init__.py | 0 | 0 | 1.5 hrs | 1.5 hrs |
| **TOTAL** | **10.5-12.5 hrs** | **20.5 hrs** | **16.5 hrs** | **47.5-50 hrs** |

---

## Testing Recommendations

### Critical Path Testing (Before Production)
1. **Command injection tests:** Malicious config values
2. **Timeout tests:** RouterOS unreachable scenarios
3. **State corruption tests:** Malformed JSON, missing files
4. **Concurrent execution tests:** Lock file robustness
5. **Long-running stability:** 7-day soak test

### Unit Tests (Recommended)
- RouterOS command parsing (various output formats)
- Ping output parsing (malformed input)
- EWMA edge cases (alpha=0, alpha=1, current=0)
- Congestion assessment boundary conditions
- State validation with corrupt data

### Integration Tests
- Steering enable/disable with mocked RouterOS
- State persistence across restarts
- Baseline RTT changes during operation
- CAKE stats unavailable scenarios
- Network partition recovery

### Stress Tests
- Rapid congestion changes (flapping)
- Sustained RouterOS unavailability
- High-frequency steering toggles
- Memory stability over days

**Testing Effort:** 16-24 hours

---

## Deployment Considerations

### Security Hardening Checklist
- [ ] Run daemon as non-root user (use capabilities for ping)
- [ ] Restrict state file permissions (600, owner-only)
- [ ] Restrict config file permissions (640, root:wanctl)
- [ ] Use SELinux/AppArmor profile
- [ ] Enable systemd service hardening:
  ```
  [Service]
  PrivateTmp=yes
  ProtectSystem=strict
  ProtectHome=yes
  NoNewPrivileges=yes
  ReadWritePaths=/var/lib/wanctl /var/log/wanctl
  ```

### Monitoring & Alerting
- [ ] Alert on state transitions (especially rapid flapping)
- [ ] Monitor cycle execution time (should be <1s)
- [ ] Track steering enable/disable ratio
- [ ] Alert on baseline RTT jumps (>10ms)
- [ ] Monitor CAKE stats read failures
- [ ] Track ping failure rate

### Operational Procedures
- [ ] Document state file corruption recovery
- [ ] Add --status command (check without modifying)
- [ ] Config validation on startup (don't wait for runtime)
- [ ] Dry-run mode for testing config changes
- [ ] Rollback procedure (revert to last known good config)

---

## Architecture Review

### Strengths
1. **Clean separation of concerns:** State, RouterOS, RTT, CAKE stats all separate
2. **Good documentation:** Comprehensive docstrings and comments
3. **Type hints:** Fully typed for static analysis
4. **Config-driven:** Supports generic WANs (not hardcoded)
5. **Atomic writes:** State persistence uses temp file + rename
6. **Lock file:** Prevents concurrent execution
7. **Phase 2B design:** Well-thought-out confidence scoring and timers

### Weaknesses
1. **Command injection vulnerabilities:** Pervasive pattern across RouterOS interaction
2. **Missing timeouts:** Network operations assume success
3. **Silent failures:** Errors logged but execution continues
4. **No alerting:** Operational issues not surfaced to operator
5. **Tight coupling:** SteeringDaemon has 6 dependencies
6. **God class:** SteeringDaemon does too much (state + CAKE + RTT + router)
7. **Phase 2B untested:** Complex state machine never run in production

---

## Risk Assessment by File

| File | Security Risk | Reliability Risk | Overall Risk |
|------|---------------|------------------|--------------|
| daemon.py | HIGH | MEDIUM-HIGH | HIGH |
| cake_stats.py | MEDIUM-HIGH | MEDIUM | MEDIUM-HIGH |
| congestion_assessment.py | LOW | LOW | LOW |
| steering_confidence.py | NONE (unused) | N/A | LOW |
| __init__.py | NONE | NONE | NONE |
| **Overall Module** | **HIGH** | **MEDIUM** | **MEDIUM-HIGH** |

---

## Comparison with Previous Review

**Previous Review:** steering_daemon.2026-01-08.md (focus: daemon.py only)  
**Current Review:** Comprehensive batch review (all 5 files)

### New Findings
- **Command injection in cake_stats.py:** Not caught in previous review
- **EWMA validation missing:** congestion_assessment.py not previously reviewed
- **Phase 2B timer issues:** steering_confidence.py not previously reviewed
- **Cross-file patterns:** Identified systemic command injection pattern

### Confirmed Findings
- Command injection in daemon.py (now rated CRITICAL)
- Missing timeouts (now found in multiple files)
- State corruption handling (expanded with backup recommendations)

---

## Conclusions & Recommendations

### Overall Assessment
The wanctl steering module is **well-designed but has significant security and reliability gaps**. The code quality is good (structured, documented, typed), but the **command injection vulnerabilities are serious** and must be fixed before extended production use.

### Critical Path (Minimum for Production)
1. Fix command injection (C1-C3): 6-8 hours
2. Add RouterOS timeouts (W1, W9): 1 hour
3. Add retry logic (W6, W7): 4 hours
4. Test for 7 days in production
5. **Total minimum effort:** 11-13 hours + 1 week validation

### Recommended Path (Full Hardening)
1. Phase 1 (Security): 8-10 hours
2. Phase 2 (Reliability): 10 hours
3. Phase 3 (Robustness): 5-6 hours
4. Testing: 16-24 hours
5. **Total recommended effort:** 39-50 hours

### Risk Summary
**Pre-Fix Risk:** MEDIUM-HIGH  
- Attack surface limited (requires config modification)
- Impact severe (full RouterOS compromise)
- No public exposure (internal network only)

**Post-Fix Risk:** LOW-MEDIUM  
- Security vulnerabilities eliminated
- Reliability improved significantly
- Operational resilience added

### Final Recommendation
**Do not extend production use without fixing C1-C3.** The command injection vulnerabilities are exploitable if an attacker gains write access to config files. While the attack surface is limited, the impact is severe.

**Minimum acceptable state:**
- Fix C1-C3 (command injection)
- Fix W1 + W9 (timeouts)
- Fix W6 + W7 (retry logic)
- Run for 1 week with monitoring

**Production-ready state:**
- Complete Phase 1 + Phase 2 fixes
- Add monitoring and alerting
- Document operational procedures
- Run for 30 days with incident response plan

---

## Individual Review Files

Detailed per-file reviews available at:
- `/home/kevin/.claude/reviews/wanctl/daemon.2026-01-08.md`
- `/home/kevin/.claude/reviews/wanctl/congestion_assessment.2026-01-08.md`
- `/home/kevin/.claude/reviews/wanctl/cake_stats.2026-01-08.md`
- `/home/kevin/.claude/reviews/wanctl/steering_confidence.2026-01-08.md`
- `/home/kevin/.claude/reviews/wanctl/__init__.2026-01-08.md`

---

**Review Completed:** 2026-01-08  
**Next Review Recommended:** After Phase 1-2 fixes (2-3 weeks)
