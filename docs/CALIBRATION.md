# Calibration Guide

This guide explains how to use wanctl's calibration tool to discover optimal CAKE bandwidth settings for your connection.

## Overview

The calibration tool uses the **Flent/LibreQoS methodology**: instead of measuring maximum throughput with massive bufferbloat, it finds the maximum throughput that maintains acceptable latency.

**Key insight:** Your optimal shaped rate is NOT your maximum speed. It's the highest speed where latency stays under control.

## Quick Start

```bash
# Interactive wizard
./scripts/calibrate.sh

# Or with preset values
./scripts/calibrate.sh --wan-name wan1 --router 192.168.1.1

# Python module directly
python3 -m cake.calibrate --wan-name wan1 --router 192.168.1.1
```

## What It Does

1. **Tests connectivity** - Verifies SSH access to your router
2. **Measures baseline RTT** - Your idle latency (ping without load)
3. **Measures raw throughput** - Maximum unshaped speed (with netperf)
4. **Binary searches for optimal rates** - Finds max speed with <10ms bloat
5. **Generates config** - Creates a wanctl YAML config with discovered values

## Prerequisites

- **SSH access** to your Mikrotik router
- **netperf** installed (`apt install netperf`)
- **CAKE queues** configured on RouterOS

### Install netperf

```bash
# Debian/Ubuntu
sudo apt install netperf

# The default public server is netperf.bufferbloat.net
# Alternative: flent-fremont.bufferbloat.net
```

## Interactive Mode

Running `./scripts/calibrate.sh` without arguments starts an interactive wizard:

```
========================================
wanctl Calibration Wizard
========================================

This wizard will help you discover optimal CAKE settings for your connection.
It will:
  1. Test connectivity to your router
  2. Measure your baseline RTT (idle latency)
  3. Measure raw throughput (may cause latency spikes)
  4. Binary search for optimal shaped rates
  5. Generate a configuration file

Ready to begin? [Y/n]:
```

## Command Line Options

```
./scripts/calibrate.sh [OPTIONS]

Options:
    --wan-name NAME         WAN identifier (e.g., wan1, cable, fiber)
    --router HOST           Router IP or hostname
    --user USER             SSH username for router (default: admin)
    --ssh-key PATH          Path to SSH private key
    --netperf-host HOST     Netperf server (default: netperf.bufferbloat.net)
    --ping-host HOST        RTT measurement host (default: 1.1.1.1)
    --target-bloat MS       Target bloat in ms (default: 10)
    --output-dir DIR        Config output directory (default: /etc/wanctl)
    --skip-binary-search    Skip binary search, measure raw only
    --non-interactive       Skip interactive prompts
```

## Examples

### Basic Calibration

```bash
# Interactive wizard
./scripts/calibrate.sh

# Calibrate primary WAN
./scripts/calibrate.sh --wan-name wan1 --router 192.168.1.1

# Calibrate with SSH key
./scripts/calibrate.sh --wan-name wan1 --router 192.168.1.1 \
    --ssh-key ~/.ssh/mikrotik_key
```

### Quick Calibration (No Binary Search)

```bash
# Skip binary search - faster but less accurate
./scripts/calibrate.sh --wan-name wan1 --router 192.168.1.1 \
    --skip-binary-search
```

### Custom Netperf Server

```bash
# Use a different netperf server
./scripts/calibrate.sh --wan-name wan1 --router 192.168.1.1 \
    --netperf-host netperf.example.com
```

### Stricter Latency Target

```bash
# Target 5ms bloat for gaming/VoIP
./scripts/calibrate.sh --wan-name wan1 --router 192.168.1.1 \
    --target-bloat 5
```

## Understanding Results

```
========================================
Results Summary
========================================

    Baseline RTT: 24.0 ms
    Raw download: 940.0 Mbps
    Raw upload: 38.0 Mbps
    Optimal download: 820.0 Mbps (bloat: 8.5ms)
    Optimal upload: 32.0 Mbps (bloat: 7.2ms)
    Suggested floor (download): 164.0 Mbps
    Suggested floor (upload): 6.4 Mbps
```

- **Baseline RTT**: Your idle latency (lower is better)
- **Raw throughput**: Maximum speed without shaping (causes bufferbloat)
- **Optimal rates**: Maximum speed that maintains target bloat
- **Floor**: Emergency minimum (20% of optimal)

## Connection Type Detection

The tool estimates your connection type based on baseline RTT:

| Baseline RTT | Connection Type | Notes |
|-------------|-----------------|-------|
| < 15ms | Fiber | Very stable, tight thresholds |
| 15-35ms | Cable (DOCSIS) | Variable latency, median-of-three helpful |
| > 35ms | DSL | Higher baseline, conservative settings |

## Generated Config

The calibration tool generates a complete wanctl config at `/etc/wanctl/<wan_name>.yaml`:

```yaml
# wanctl Configuration - wan1
#
# Auto-generated by calibration tool on 2025-01-07T10:30:00
#
# Detected connection type: cable
# Baseline RTT: 24.0ms
# Raw download: 940.0 Mbps
# Raw upload: 38.0 Mbps
# Optimal download: 820.0 Mbps (bloat: 8.5ms)
# Optimal upload: 32.0 Mbps (bloat: 7.2ms)

wan_name: wan1
router:
  type: routeros
  host: 192.168.1.1
  user: admin
  ssh_key: /etc/wanctl/ssh/router.key
queues:
  download: WAN-Download-Wan1
  upload: WAN-Upload-Wan1
continuous_monitoring:
  enabled: true
  baseline_rtt_initial: 24.0
  download:
    floor_green_mbps: 492
    floor_yellow_mbps: 328
    floor_soft_red_mbps: 246
    floor_red_mbps: 164
    ceiling_mbps: 861
    step_up_mbps: 8
    factor_down: 0.85
  upload:
    floor_mbps: 6
    ceiling_mbps: 34
    step_up_mbps: 1
    factor_down: 0.90
  thresholds:
    target_bloat_ms: 12
    warn_bloat_ms: 36
    hard_red_bloat_ms: 72
    alpha_baseline: 0.02
    alpha_load: 0.20
```

**IMPORTANT:** Review and customize the generated config:
- Update queue names to match your RouterOS configuration
- Adjust floors if needed for your use case
- Copy your SSH key to `/etc/wanctl/ssh/router.key`

## Troubleshooting

### SSH Connection Failed

```
[x] SSH connection failed!
```

Check:
- Router IP/hostname is correct
- SSH is enabled on router (`/ip service enable ssh`)
- SSH key is properly configured
- User has admin privileges on router

### Netperf Server Not Reachable

```
[!] Netperf server not reachable - will measure RTT only
```

Options:
- Try a different netperf server (`--netperf-host`)
- Run your own netperf server
- Use `--skip-binary-search` for RTT-only calibration

### Zero Throughput

If netperf reports 0 Mbps:
- Check firewall rules (ports 12865-12866 TCP)
- Try a different netperf server
- Verify network connectivity

## Re-Calibration

Re-run calibration when:
- Your ISP changes your provisioned speeds
- You change your network configuration
- You experience persistent bufferbloat
- After major RouterOS upgrades

## Next Steps

After calibration:

1. Review the generated config
2. Update queue names to match your RouterOS setup
3. Copy SSH key: `sudo cp ~/.ssh/router_key /etc/wanctl/ssh/router.key`
4. Enable the service: `sudo systemctl enable --now wanctl@wan1.timer`
5. Monitor: `journalctl -u wanctl@wan1 -f`
