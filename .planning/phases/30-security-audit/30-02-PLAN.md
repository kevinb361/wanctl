---
phase: 30-security-audit
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - Makefile
  - pyproject.toml
  - .planning/phases/30-security-audit/30-AUDIT-REPORT.md
autonomous: true

must_haves:
  truths:
    - "make security runs all four security scans"
    - "All scans pass or issues are documented/fixed"
    - "Audit report exists with findings summary"
    - "Transitive dependency tree is documented"
  artifacts:
    - path: "Makefile"
      provides: "Security scan targets"
      contains: "security:"
    - path: ".planning/phases/30-security-audit/30-AUDIT-REPORT.md"
      provides: "Security audit findings"
      contains: "Dependency Vulnerabilities"
  key_links:
    - from: "Makefile"
      to: ".venv/bin/pip-audit"
      via: "security-deps target"
      pattern: "pip-audit"
    - from: "Makefile"
      to: ".venv/bin/bandit"
      via: "security-code target"
      pattern: "bandit"
---

<objective>
Add Makefile security targets, run all scans, fix issues, and produce audit report.

Purpose: Complete the security audit by running scans, addressing findings, documenting results, and establishing ongoing scanning capability.
Output: Updated Makefile with security targets, fixed code if needed, comprehensive audit report.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/30-security-audit/30-CONTEXT.md
@.planning/phases/30-security-audit/30-RESEARCH.md
@.planning/phases/30-security-audit/30-01-SUMMARY.md
@Makefile
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add security targets to Makefile</name>
  <files>Makefile</files>
  <action>
Add security scanning targets to Makefile:

```makefile
.PHONY: security security-deps security-code security-secrets security-licenses

# Run all security scans
security: security-deps security-code security-secrets security-licenses
	@echo "All security checks passed"

# Dependency vulnerability scan (pip-audit)
security-deps:
	@echo "Scanning dependencies for vulnerabilities..."
	.venv/bin/pip-audit

# Static security analysis (bandit)
security-code:
	@echo "Running static security analysis..."
	.venv/bin/bandit -r src/ -c pyproject.toml

# Secret detection (detect-secrets)
security-secrets:
	@echo "Checking for secrets..."
	.venv/bin/detect-secrets scan --baseline .secrets.baseline

# License compliance (pip-licenses)
security-licenses:
	@echo "Checking license compliance..."
	.venv/bin/pip-licenses --fail-on="GPL;AGPL;LGPL" --partial-match
```

Add `security` to the .PHONY line at the top of Makefile.

Do NOT add security to the `ci` target yet - decide after measuring scan duration.
  </action>
  <verify>
Run `make security-deps` - should complete (may find issues, that's OK for this task)
  </verify>
  <done>Makefile has security, security-deps, security-code, security-secrets, security-licenses targets</done>
</task>

<task type="auto">
  <name>Task 2: Run scans and fix issues</name>
  <files>pyproject.toml (if deps need updating), src/**/*.py (if nosec needed)</files>
  <action>
Run each scan and address findings:

1. **Dependency scan** (`make security-deps`):
   - If vulnerabilities found: Update affected packages in pyproject.toml
   - Run `uv lock --upgrade-package <pkg>` for each vulnerable package
   - Re-run scan until clean or document unfixable as acceptable risk

2. **Static analysis** (`make security-code`):
   - Fix genuine issues in code
   - For false positives: Add `# nosec BXXX - <justification>` with specific rule ID
   - Per CONTEXT.md: All findings block, so all must be addressed

3. **Secret detection** (`make security-secrets`):
   - Should pass if baseline created correctly in 30-01
   - If new secrets detected: Remove or add `# pragma: allowlist secret` with justification

4. **License compliance** (`make security-licenses`):
   - If GPL/AGPL/LGPL found: Evaluate if truly copyleft, may be dual-licensed
   - Document any acceptable exceptions in audit report

Measure total scan duration: `time make security`
If <30 seconds: Add `security` to `ci` target dependencies
If >=30 seconds: Keep security as separate target, document in audit report
  </action>
  <verify>
Run `make security` - all four scans should pass (exit 0)
  </verify>
  <done>All security scans pass, any issues fixed or documented</done>
</task>

<task type="auto">
  <name>Task 3: Create audit report</name>
  <files>.planning/phases/30-security-audit/30-AUDIT-REPORT.md</files>
  <action>
Create comprehensive audit report with:

1. **Executive Summary**: Clean/issues found, scan date, tool versions

2. **Dependency Vulnerabilities** (SEC-01, SEC-03):
   - List all packages scanned
   - Note any CVEs found and remediation
   - Or "No vulnerabilities found" if clean

3. **Static Security Analysis**:
   - Bandit findings summary
   - Any nosec suppressions with justifications

4. **Secret Detection**:
   - Baseline status
   - Any allowlisted items with justifications

5. **License Compliance**:
   - All package licenses listed
   - Confirmation no copyleft violations

6. **Transitive Dependency Tree** (SEC-05):
   - Run `uv tree` and include output
   - Note any concerning deep dependencies

7. **CI Integration** (SEC-04):
   - Document whether `make security` is in `make ci`
   - If not, document why (scan duration) and recommend usage

8. **Recommendations**:
   - Any future actions (upgrade monitoring, etc.)

Use the pip-licenses output for license table. Use uv tree for dependency tree.
  </action>
  <verify>
`test -f .planning/phases/30-security-audit/30-AUDIT-REPORT.md` returns 0
  </verify>
  <done>Comprehensive audit report exists documenting all scan results and transitive dependencies</done>
</task>

</tasks>

<verification>
```bash
# Security targets work
make security

# Audit report exists
test -f .planning/phases/30-security-audit/30-AUDIT-REPORT.md && echo "Audit report: OK"

# CI integration documented (check if security in ci target or documented why not)
grep -q "security" Makefile && echo "Security targets: OK"
```
</verification>

<success_criteria>
- `make security` runs all four scans successfully (exit 0)
- Any vulnerabilities fixed or documented as acceptable risk
- Audit report covers all SEC-01 through SEC-05 requirements
- Transitive dependency tree documented
- CI integration decision made and documented
</success_criteria>

<output>
After completion, create `.planning/phases/30-security-audit/30-02-SUMMARY.md`
</output>
