---
phase: 31-coverage-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - Makefile
  - README.md
autonomous: true

must_haves:
  truths:
    - "`make ci` exits non-zero when test coverage is below 90%"
    - "Coverage threshold is enforced via fail_under=90 in pyproject.toml"
    - "README badge displays 90% threshold"
  artifacts:
    - path: "pyproject.toml"
      provides: "Coverage threshold configuration"
      contains: "fail_under = 90"
    - path: "Makefile"
      provides: "CI target with coverage enforcement"
      contains: "coverage-check"
    - path: "README.md"
      provides: "Coverage badge"
      contains: "coverage-90%25_threshold"
  key_links:
    - from: "Makefile"
      to: "pyproject.toml"
      via: "pytest reads fail_under from [tool.coverage.report]"
      pattern: "fail_under"
    - from: "Makefile ci target"
      to: "coverage-check target"
      via: "ci depends on coverage-check"
      pattern: "ci:.*coverage-check"
---

<objective>
Configure coverage threshold enforcement and update CI to fail when coverage drops below 90%.

Purpose: Establish infrastructure for coverage enforcement before adding tests in subsequent phases. CI will fail initially (current coverage is 45.7%) - this is expected and correct.
Output: pyproject.toml with fail_under, Makefile with coverage-check target, README with threshold badge
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-coverage-infrastructure/31-RESEARCH.md
@pyproject.toml
@Makefile
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure coverage threshold and CI target</name>
  <files>pyproject.toml, Makefile</files>
  <action>
1. In pyproject.toml, add `fail_under = 90` to the existing `[tool.coverage.report]` section:
```toml
[tool.coverage.report]
show_missing = true
skip_empty = true
precision = 1
fail_under = 90
```

2. In Makefile, add a new `coverage-check` target (keeps `test` fast for local dev):
```makefile
# Run tests with coverage enforcement (used by CI)
coverage-check:
	.venv/bin/pytest tests/ --cov=src --cov-report=term-missing --cov-fail-under=90
```

3. Update the `ci` target to use `coverage-check` instead of `test`:
```makefile
# All CI checks (lint, type, coverage)
ci: lint type coverage-check
```

Rationale: Option B from research - keep `test` fast for rapid iteration, add separate `coverage-check` for enforcement. The `--cov-fail-under=90` on command line provides explicit enforcement in addition to pyproject.toml config.
  </action>
  <verify>
- `grep "fail_under = 90" pyproject.toml` returns the line
- `grep "coverage-check:" Makefile` returns the target
- `grep "ci: lint type coverage-check" Makefile` returns the updated ci target
- `.venv/bin/pytest tests/ --cov=src --cov-fail-under=90` exits with code 2 (coverage below threshold) - this confirms enforcement is working
  </verify>
  <done>
- pyproject.toml has fail_under = 90 in [tool.coverage.report]
- Makefile has coverage-check target with --cov-fail-under=90
- ci target includes coverage-check
- Running coverage check correctly fails (expected - current coverage is 45.7%)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update README coverage badge</name>
  <files>README.md</files>
  <action>
Update the coverage badge in README.md line 4 to show the 90% threshold:

Change from:
```markdown
[![Coverage](https://img.shields.io/badge/coverage-72%25-yellowgreen)](coverage-report/index.html)
```

To:
```markdown
[![Coverage](https://img.shields.io/badge/coverage-90%25_threshold-brightgreen)](coverage-report/index.html)
```

This badge indicates the CI enforcement threshold, not current actual coverage. Using `brightgreen` color to indicate the target/goal.
  </action>
  <verify>
- `grep "coverage-90%25_threshold" README.md` returns the badge line
- Badge shows "90% threshold" text (visual check in rendered markdown)
  </verify>
  <done>
- README badge displays "90% threshold" with brightgreen color
- Badge links to coverage-report/index.html (unchanged)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Verify pyproject.toml config:
```bash
grep -A5 "\[tool.coverage.report\]" pyproject.toml | grep fail_under
```
Expected: `fail_under = 90`

2. Verify Makefile targets:
```bash
grep -E "^coverage-check:|^ci:" Makefile
```
Expected: Both targets present, ci includes coverage-check

3. Verify README badge:
```bash
grep "coverage-90" README.md
```
Expected: Badge line with 90% threshold

4. Verify enforcement works (expected to fail):
```bash
make coverage-check || echo "Expected failure - coverage below 90%"
```
Expected: Exit code 2 with "FAIL Required test coverage of 90% not reached"

5. Verify make ci fails (expected):
```bash
make ci || echo "Expected failure - coverage below 90%"
```
Expected: CI fails on coverage-check step
</verification>

<success_criteria>
- [ ] `fail_under = 90` present in pyproject.toml [tool.coverage.report]
- [ ] `make coverage-check` target exists and enforces 90% threshold
- [ ] `make ci` exits non-zero due to coverage below 90% (expected)
- [ ] README badge shows "90% threshold"
- [ ] All changes committed
</success_criteria>

<output>
After completion, create `.planning/phases/31-coverage-infrastructure/31-01-SUMMARY.md`
</output>
