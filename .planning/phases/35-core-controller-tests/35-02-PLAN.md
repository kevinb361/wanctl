---
phase: 35-core-controller-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_queue_controller.py
autonomous: true

must_haves:
  truths:
    - "QueueController.adjust() 3-state zones tested (GREEN, YELLOW, RED)"
    - "QueueController.adjust_4state() 4-state zones tested (GREEN, YELLOW, SOFT_RED, RED)"
    - "Hysteresis counters tested (green_streak, red_streak, soft_red_streak)"
    - "Rate bounds enforced (floor, ceiling clamping)"
    - "Baseline freeze invariant tested (delta >= threshold freezes baseline)"
  artifacts:
    - path: "tests/test_queue_controller.py"
      provides: "Control loop state transition tests"
      min_lines: 300
  key_links:
    - from: "tests/test_queue_controller.py"
      to: "src/wanctl/autorate_continuous.py"
      via: "import and test QueueController class"
      pattern: "from wanctl.autorate_continuous import QueueController"
---

<objective>
Comprehensive state transition tests for QueueController.adjust() (3-state) and QueueController.adjust_4state() (4-state) methods.

Purpose: Coverage target lines 611-760 (QueueController class). Critical algorithms for bandwidth rate adjustments based on RTT delta zones.

Output: Test file with parametrized tests for all zone classifications, rate adjustments, and hysteresis counters.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-core-controller-tests/35-CONTEXT.md

@src/wanctl/autorate_continuous.py
@tests/test_wan_controller.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test file with imports and fixtures</name>
  <files>tests/test_queue_controller.py</files>
  <action>
Create test file with required imports and shared fixtures:

**Imports:**
- pytest, pytest.mark.parametrize
- QueueController from wanctl.autorate_continuous

**Fixtures:**
- controller_3state: QueueController with typical 3-state config (upload)
- controller_4state: QueueController with 4-state config (floor_soft_red set, download)

Standard config values from test_wan_controller.py mock_config fixture.
  </action>
  <verify>
.venv/bin/pytest tests/test_queue_controller.py --collect-only
  </verify>
  <done>
- tests/test_queue_controller.py exists with imports and fixtures
- pytest can collect the module
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement TestAdjust3StateZoneClassification class</name>
  <files>tests/test_queue_controller.py</files>
  <action>
Add TestAdjust3StateZoneClassification class with parametrized tests:

```python
@pytest.mark.parametrize("delta,expected_zone", [
    (5.0, "GREEN"),   # delta <= 15
    (15.0, "GREEN"),  # delta == target (boundary)
    (20.0, "YELLOW"), # 15 < delta <= 45
    (45.0, "YELLOW"), # delta == warn (boundary)
    (50.0, "RED"),    # delta > 45
    (100.0, "RED"),   # delta >> warn
])
def test_zone_classification(delta, expected_zone):
    # baseline=25, load_rtt=baseline+delta, target=15, warn=45
```

Additional boundary tests:
- test_zero_delta_is_green: delta=0 is definitely GREEN
- test_negative_delta_is_green: Negative delta (load < baseline) is GREEN
  </action>
  <verify>
.venv/bin/pytest tests/test_queue_controller.py::TestAdjust3StateZoneClassification -v
  </verify>
  <done>
- TestAdjust3StateZoneClassification has 8+ parametrized test cases
- All zone boundaries verified
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement TestAdjust3StateRateAdjustments class</name>
  <files>tests/test_queue_controller.py</files>
  <action>
Add TestAdjust3StateRateAdjustments class with tests:

- test_red_immediate_decay: Single RED sample applies factor_down immediately
- test_green_requires_sustained_cycles: 4 GREEN cycles = hold, 5th = step up
- test_yellow_applies_gentle_decay: factor_down_yellow applied in YELLOW
- test_rate_clamped_at_floor: Rate never below floor_red_bps
- test_rate_clamped_at_ceiling: Rate never above ceiling_bps
- test_green_streak_reset_by_yellow: YELLOW resets green_streak to 0
- test_green_streak_reset_by_red: RED resets green_streak to 0
  </action>
  <verify>
.venv/bin/pytest tests/test_queue_controller.py::TestAdjust3StateRateAdjustments -v
  </verify>
  <done>
- TestAdjust3StateRateAdjustments has 7 passing tests
- Rate adjustment logic verified for 3-state
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement TestAdjust4StateZoneClassification class</name>
  <files>tests/test_queue_controller.py</files>
  <action>
Add TestAdjust4StateZoneClassification class with parametrized tests:

```python
@pytest.mark.parametrize("delta,expected_zone", [
    (5.0, "GREEN"),     # delta <= 15
    (20.0, "YELLOW"),   # 15 < delta <= 45
    (50.0, "SOFT_RED"), # 45 < delta <= 80 (after sustain)
    (100.0, "RED"),     # delta > 80
])
def test_4state_zone_classification(delta, expected_zone):
    # May need multiple cycles for SOFT_RED due to sustain requirement
```

Additional tests:
- test_soft_red_requires_sustain: First SOFT_RED delta returns YELLOW
- test_soft_red_sustained_returns_soft_red: After soft_red_required cycles, returns SOFT_RED
  </action>
  <verify>
.venv/bin/pytest tests/test_queue_controller.py::TestAdjust4StateZoneClassification -v
  </verify>
  <done>
- TestAdjust4StateZoneClassification has 6+ test cases
- 4-state zone boundaries verified including SOFT_RED sustain
  </done>
</task>

<task type="auto">
  <name>Task 5: Implement TestAdjust4StateRateAdjustments class</name>
  <files>tests/test_queue_controller.py</files>
  <action>
Add TestAdjust4StateRateAdjustments class with tests:

- test_red_immediate_decay: RED applies factor_down immediately
- test_soft_red_clamps_to_floor_and_holds: SOFT_RED sets floor, no repeated decay
- test_soft_red_no_decay_on_subsequent_cycles: Multiple SOFT_RED cycles don't decay further
- test_yellow_uses_state_appropriate_floor: floor_yellow_bps used in YELLOW
- test_green_uses_floor_green: floor_green_bps used in GREEN step-up
  </action>
  <verify>
.venv/bin/pytest tests/test_queue_controller.py::TestAdjust4StateRateAdjustments -v
  </verify>
  <done>
- TestAdjust4StateRateAdjustments has 5 passing tests
- Rate adjustment logic verified for 4-state
  </done>
</task>

<task type="auto">
  <name>Task 6: Implement TestHysteresisCounters class</name>
  <files>tests/test_queue_controller.py</files>
  <action>
Add TestHysteresisCounters class with tests:

- test_green_streak_increments_in_green: Each GREEN cycle increments counter
- test_green_streak_reset_on_zone_change: Any non-GREEN zone resets counter
- test_soft_red_streak_increments_in_soft_red: SOFT_RED delta increments counter
- test_soft_red_streak_reset_on_zone_change: Any other zone resets counter
- test_red_streak_increments_in_red: RED delta increments counter
- test_red_streak_reset_on_zone_change: Any non-RED zone resets counter
- test_counters_isolated_between_instances: Different controllers have independent counters
  </action>
  <verify>
.venv/bin/pytest tests/test_queue_controller.py::TestHysteresisCounters -v
  </verify>
  <done>
- TestHysteresisCounters has 7 passing tests
- All hysteresis counters verified
  </done>
</task>

<task type="auto">
  <name>Task 7: Implement TestStateTransitionSequences class</name>
  <files>tests/test_queue_controller.py</files>
  <action>
Add TestStateTransitionSequences class with integration-style tests:

- test_green_to_yellow_to_red_to_recovery: Full degradation and recovery sequence
- test_red_recovery_requires_sustained_green: After RED, must sustain GREEN for step-up
- test_soft_red_to_red_transition: SOFT_RED->RED if delta exceeds hard_red_threshold
- test_soft_red_recovery_to_yellow_to_green: Recovery path from SOFT_RED

Each test should log the sequence of (zone, rate) tuples for debugging.
  </action>
  <verify>
.venv/bin/pytest tests/test_queue_controller.py::TestStateTransitionSequences -v
  </verify>
  <done>
- TestStateTransitionSequences has 4 passing tests
- Full transition sequences verified
  </done>
</task>

<task type="auto">
  <name>Task 8: Implement TestBaselineFreezeInvariant class</name>
  <files>tests/test_queue_controller.py</files>
  <action>
Add TestBaselineFreezeInvariant class - CRITICAL safety invariant from CLAUDE.md:

- test_baseline_freeze_under_load: 100 cycles with high RTT, baseline unchanged
- test_baseline_updates_when_idle: Low delta allows baseline EWMA update
- test_delta_threshold_boundary: Exactly threshold value freezes (>= not >)

This tests _update_baseline_if_idle via update_ewma indirectly.
  </action>
  <verify>
.venv/bin/pytest tests/test_queue_controller.py::TestBaselineFreezeInvariant -v
  </verify>
  <done>
- TestBaselineFreezeInvariant has 3 passing tests
- Baseline freeze invariant explicitly verified
  </done>
</task>

</tasks>

<verification>
```bash
# Run all queue controller tests
.venv/bin/pytest tests/test_queue_controller.py -v

# Verify coverage improvement for lines 611-760
.venv/bin/pytest tests/test_queue_controller.py --cov=wanctl.autorate_continuous --cov-report=term-missing | grep -A20 "autorate_continuous"
```
</verification>

<success_criteria>
- [ ] tests/test_queue_controller.py created with 40+ test methods
- [ ] All 3-state zones tested (GREEN, YELLOW, RED)
- [ ] All 4-state zones tested (GREEN, YELLOW, SOFT_RED, RED)
- [ ] Hysteresis counters tested (green_streak, red_streak, soft_red_streak)
- [ ] Rate bounds enforced (floor, ceiling)
- [ ] Baseline freeze invariant tested explicitly
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/35-core-controller-tests/35-02-SUMMARY.md`
</output>
