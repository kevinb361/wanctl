---
phase: 35-core-controller-tests
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_autorate_config.py
  - tests/test_wan_controller.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Config alpha_baseline/alpha_load fallback paths tested"
    - "Median-of-three RTT edge cases (2 hosts, 1 host, all fail) tested"
    - "Baseline RTT bounds rejection tested"
  artifacts:
    - path: "tests/test_autorate_config.py"
      provides: "Config alpha fallback tests"
      contains: "alpha_baseline.*fallback|alpha_load.*fallback"
    - path: "tests/test_wan_controller.py"
      provides: "Median-of-three and baseline bounds tests"
      contains: "median.*two|median.*one|bounds"
  key_links:
    - from: "tests/test_autorate_config.py"
      to: "wanctl.autorate_continuous.Config"
      via: "Config class instantiation with alpha params"
      pattern: "Config\\("
---

<objective>
Cover config alpha fallbacks, median-of-three RTT edge cases, and baseline bounds rejection.

Purpose: Close coverage gaps in lines 364-386 (config), 890-910 (median RTT), 956-960 (baseline bounds)
Output: Extended tests in test_autorate_config.py and test_wan_controller.py (~35 lines covered)
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/35-core-controller-tests/35-VERIFICATION.md

# Source code for uncovered lines
@src/wanctl/autorate_continuous.py (lines 357-386: alpha config, lines 881-910: measure_rtt, lines 925-960: baseline update)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Config alpha fallback tests</name>
  <files>tests/test_autorate_config.py</files>
  <action>
Add tests for Config class alpha parameter fallback paths:

1. Test `alpha_baseline` raw value (no time_constant):
   - Create config YAML with `alpha_baseline: 0.0005` but NO `baseline_time_constant_sec`
   - Verify Config.alpha_baseline equals raw value
   - Covers lines 364-367

2. Test `alpha_load` raw value with warning:
   - Create config YAML with `alpha_load: 0.001` but NO `load_time_constant_sec`
   - Verify Config.alpha_load equals raw value
   - Mock logger and verify warning logged for slow time constant (>5s)
   - Covers lines 376-386

3. Test missing both alpha params raises ValueError:
   - Create config with neither alpha_baseline nor baseline_time_constant_sec
   - Verify ValueError with "must specify either" message

Existing patterns in test_autorate_config.py: use tmp_path for config files, yaml.safe_dump for config content.
  </action>
  <verify>pytest tests/test_autorate_config.py -v -k "alpha" passes</verify>
  <done>Lines 364-367 and 376-386 covered by alpha fallback tests</done>
</task>

<task type="auto">
  <name>Task 2: Median-of-three RTT edge case tests</name>
  <files>tests/test_wan_controller.py</files>
  <action>
Add tests for WANController.measure_rtt() median-of-three edge cases:

1. Test 2 hosts return RTT (partial success):
   - Mock rtt_measurement.ping_hosts_concurrent to return [10.0, 15.0] (2 values)
   - Set use_median_of_three=True, ping_hosts=["a", "b", "c"]
   - Verify median(10.0, 15.0) = 12.5ms returned
   - Covers lines 897-902

2. Test 1 host returns RTT (minimal success):
   - Mock ping_hosts_concurrent to return [10.0] (1 value)
   - Verify single RTT value returned directly
   - Covers lines 903-904

3. Test all hosts fail (return empty):
   - Mock ping_hosts_concurrent to return []
   - Verify None returned and warning logged
   - Covers lines 905-907

4. Test single host ping path (use_median_of_three=False):
   - Set use_median_of_three=False
   - Verify ping_host called instead of ping_hosts_concurrent
   - Covers lines 908-910

Use controller_with_mocks fixture pattern from test_autorate_error_recovery.py.
  </action>
  <verify>pytest tests/test_wan_controller.py -v -k "median" passes</verify>
  <done>Lines 890-910 covered by median-of-three edge case tests</done>
</task>

<task type="auto">
  <name>Task 3: Baseline RTT bounds rejection tests</name>
  <files>tests/test_wan_controller.py</files>
  <action>
Add tests for WANController._update_baseline_if_idle() bounds rejection:

1. Test baseline RTT below min bound (rejected):
   - Set baseline_rtt_min=5.0, current baseline=10.0
   - Call _update_baseline_if_idle with measured_rtt that would result in new_baseline < 5.0
   - Verify baseline NOT updated
   - Verify warning logged with "outside bounds" message
   - Covers lines 956-960

2. Test baseline RTT above max bound (rejected):
   - Set baseline_rtt_max=100.0
   - Call _update_baseline_if_idle with measured_rtt that would result in new_baseline > 100.0
   - Verify baseline NOT updated
   - Verify warning logged

3. Test baseline RTT within bounds (accepted):
   - Verify normal baseline update when new_baseline is within bounds
   - Confirm delta < threshold allows update

Calculate what measured_rtt values will produce out-of-bounds results:
new_baseline = (1 - alpha) * baseline + alpha * measured
For new_baseline < min: measured = (min - (1-alpha)*baseline) / alpha
  </action>
  <verify>pytest tests/test_wan_controller.py -v -k "bounds" passes</verify>
  <done>Lines 956-960 covered by baseline bounds rejection tests</done>
</task>

</tasks>

<verification>
```bash
# Run all new tests
pytest tests/test_autorate_config.py tests/test_wan_controller.py -v -k "alpha or median or bounds"

# Verify coverage improvement
pytest tests/ --cov=wanctl.autorate_continuous --cov-report=term-missing -q 2>&1 | grep "autorate_continuous"
# Expect: lines 364-386, 890-910, 956-960 no longer in missing list
```
</verification>

<success_criteria>
- Lines 364-367 (alpha_baseline fallback) covered
- Lines 376-386 (alpha_load fallback + warning) covered
- Lines 890-910 (median-of-three edge cases) covered
- Lines 956-960 (baseline bounds rejection) covered
- All tests pass with `pytest -v`
- Coverage improved by ~35 lines (73.6% -> ~78%)
</success_criteria>

<output>
After completion, create `.planning/phases/35-core-controller-tests/35-04-SUMMARY.md`
</output>
