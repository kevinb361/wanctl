---
phase: 36-steering-daemon-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_steering_daemon.py
autonomous: true

must_haves:
  truths:
    - "RouterOSController.get_rule_status parses MikroTik output correctly (enabled/disabled/not-found/error)"
    - "RouterOSController.enable_steering and disable_steering handle success and failure paths"
    - "BaselineLoader.load_baseline_rtt handles missing file, valid bounds, out-of-bounds, and JSON errors"
    - "SteeringConfig loads YAML and validates all threshold parameters"
  artifacts:
    - path: "tests/test_steering_daemon.py"
      provides: "TestRouterOSController, TestBaselineLoader, TestSteeringConfig classes"
      contains: "class TestRouterOSController"
  key_links:
    - from: "tests/test_steering_daemon.py"
      to: "wanctl.steering.daemon"
      via: "pytest imports"
      pattern: "from wanctl.steering.daemon import"
---

<objective>
Test RouterOSController, BaselineLoader, and SteeringConfig classes to achieve coverage for lines 152-536 and 552-596.

Purpose: Cover foundational steering daemon classes that parse MikroTik output, load baseline RTT from state files, and validate configuration.
Output: Three new test classes (TestRouterOSController, TestBaselineLoader, TestSteeringConfig) with ~30 tests.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-steering-daemon-tests/36-CONTEXT.md
@.planning/phases/36-steering-daemon-tests/36-RESEARCH.md
@src/wanctl/steering/daemon.py
@tests/test_steering_daemon.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TestRouterOSController tests</name>
  <files>tests/test_steering_daemon.py</files>
  <action>
Add TestRouterOSController class testing:

1. **get_rule_status() parsing:**
   - Enabled rule: output contains "ADAPTIVE" and ";;;" without "X" flag
   - Disabled rule: output contains " X " or "\tX\t" in prefix before ";;;"
   - Rule not found: output doesn't contain "ADAPTIVE" keyword
   - Command failure: run_cmd returns non-zero exit code

2. **enable_steering():**
   - Success: run_cmd returns 0, verify_with_retry returns True
   - Command failure: run_cmd returns non-zero, returns False
   - Verification failure: verify_with_retry returns False after retries

3. **disable_steering():**
   - Same paths as enable_steering but expects rule disabled

Mock pattern:
```python
@pytest.fixture
def mock_router_client(self):
    client = MagicMock()
    client.run_cmd.return_value = (0, " 4    ;;; ADAPTIVE-STEER mark-routing=LATENCY_SENSITIVE", "")
    return client

def test_get_rule_status_enabled(self, mock_config, mock_logger, mock_router_client):
    with patch("wanctl.steering.daemon.get_router_client_with_failover", return_value=mock_router_client):
        controller = RouterOSController(mock_config, mock_logger)
        assert controller.get_rule_status() is True
```

Test all MikroTik output variations:
- `" 4    ;;; ADAPTIVE-STEER..."` (enabled, spaces)
- `" 4 X  ;;; ADAPTIVE-STEER..."` (disabled, X flag)
- `"\t4\tX\t;;; ADAPTIVE-STEER..."` (disabled, tabs)
- Output without "ADAPTIVE" (not found)
  </action>
  <verify>`.venv/bin/pytest tests/test_steering_daemon.py::TestRouterOSController -v` passes</verify>
  <done>RouterOSController has 100% coverage for get_rule_status, enable_steering, disable_steering</done>
</task>

<task type="auto">
  <name>Task 2: Add TestBaselineLoader and TestSteeringConfig tests</name>
  <files>tests/test_steering_daemon.py</files>
  <action>
Add TestBaselineLoader class testing:

1. **load_baseline_rtt():**
   - File not found: returns None, logs warning
   - Valid baseline within bounds: returns float value
   - Baseline below min bound: returns None, logs warning about possible compromise
   - Baseline above max bound: returns None, logs warning
   - JSON missing "ewma" key: returns None, logs warning
   - JSON missing "baseline_rtt" in ewma: returns None
   - JSON parse error: returns None, logs error
   - Non-numeric baseline_rtt: returns None, logs error

Use tmp_path fixture for real file I/O:
```python
def test_baseline_within_bounds(self, tmp_path, mock_config, mock_logger):
    state_file = tmp_path / "spectrum_state.json"
    state_file.write_text('{"ewma": {"baseline_rtt": 25.0}}')
    mock_config.primary_state_file = state_file
    mock_config.baseline_rtt_min = 10.0
    mock_config.baseline_rtt_max = 60.0

    loader = BaselineLoader(mock_config, mock_logger)
    result = loader.load_baseline_rtt()

    assert result == 25.0
```

Add TestSteeringConfig class testing config loading and validation:
- Valid YAML config loads successfully
- Invalid YAML syntax returns error
- Missing required fields fail validation
- Default threshold values applied when not specified
- State names derived from primary_wan (e.g., "spectrum" -> "SPECTRUM_GOOD", "SPECTRUM_DEGRADED")
- EWMA alpha validation (0 < alpha <= 1)
- Numeric bounds validation (positive thresholds)
  </action>
  <verify>`.venv/bin/pytest tests/test_steering_daemon.py::TestBaselineLoader tests/test_steering_daemon.py::TestSteeringConfig -v` passes</verify>
  <done>BaselineLoader and SteeringConfig have 90%+ coverage for all load/validation paths</done>
</task>

</tasks>

<verification>
Run coverage check:
```bash
.venv/bin/pytest tests/test_steering_daemon.py --cov=wanctl.steering.daemon --cov-report=term-missing 2>&1 | grep -E "^src/wanctl/steering/daemon.py|Missing"
```

Verify lines 441-536 (RouterOSController) and 552-596 (BaselineLoader) no longer appear in Missing column.
</verification>

<success_criteria>
1. TestRouterOSController class with ~12 tests for rule parsing and enable/disable paths
2. TestBaselineLoader class with ~8 tests for file I/O and bounds checking
3. TestSteeringConfig class with ~10 tests for config loading and validation
4. Coverage for daemon.py increases from 44% to ~60%+
5. All 66 existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/36-steering-daemon-tests/36-01-SUMMARY.md`
</output>
