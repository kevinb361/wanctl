---
phase: 24-wire-integration-gaps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wanctl/autorate_continuous.py
  - src/wanctl/steering/daemon.py
  - src/wanctl/steering/cake_stats.py
  - scripts/deploy.sh
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "REST API failure triggers automatic SSH fallback in production daemon"
    - "Steering daemon continues operating when REST API is unavailable"
    - "CAKE stats reader falls back to SSH on REST failure"
    - "Deployment validates config/connectivity before daemon starts"
  artifacts:
    - path: "src/wanctl/autorate_continuous.py"
      provides: "Failover-enabled router client"
      contains: "get_router_client_with_failover"
    - path: "src/wanctl/steering/daemon.py"
      provides: "Failover-enabled router client"
      contains: "get_router_client_with_failover"
    - path: "src/wanctl/steering/cake_stats.py"
      provides: "Failover-enabled router client"
      contains: "get_router_client_with_failover"
    - path: "scripts/deploy.sh"
      provides: "Pre-start validation call"
      contains: "validate-deployment.sh"
  key_links:
    - from: "src/wanctl/autorate_continuous.py"
      to: "router_client.py"
      via: "get_router_client_with_failover import"
      pattern: "from wanctl\\.router_client import.*get_router_client_with_failover"
    - from: "scripts/deploy.sh"
      to: "scripts/validate-deployment.sh"
      via: "ssh remote execution"
      pattern: "validate-deployment\\.sh"
---

<objective>
Wire implemented safety features into production code paths

Purpose: TEST-03 (failover) and DEPLOY-03 (validation) are implemented and tested but not active in production. This plan changes 4 files to make these safety features live.
Output: Production code that automatically fails over REST->SSH and validates deployment before daemon start
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1.3-MILESTONE-AUDIT.md

# Key implementation references
@src/wanctl/router_client.py (get_router_client_with_failover factory)
@tests/test_router_client.py (16 failover tests proving behavior)
@scripts/validate-deployment.sh (423-line validation script)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire FailoverRouterClient into production code</name>
  <files>
    src/wanctl/autorate_continuous.py
    src/wanctl/steering/daemon.py
    src/wanctl/steering/cake_stats.py
  </files>
  <action>
    Change 3 call sites from get_router_client() to get_router_client_with_failover():

    1. src/wanctl/autorate_continuous.py:539
       - Current: `self.ssh = get_router_client(config, logger)`
       - Change to: `self.ssh = get_router_client_with_failover(config, logger)`
       - Update import to include get_router_client_with_failover

    2. src/wanctl/steering/daemon.py:475
       - Current: `self.client = get_router_client(config, logger)`
       - Change to: `self.client = get_router_client_with_failover(config, logger)`
       - Update import to include get_router_client_with_failover

    3. src/wanctl/steering/cake_stats.py:53
       - Current: `self.client = get_router_client(config, logger)`
       - Change to: `self.client = get_router_client_with_failover(config, logger)`
       - Update import to include get_router_client_with_failover

    Each file already imports from wanctl.router_client - just add get_router_client_with_failover to the existing import statement.
  </action>
  <verify>
    grep -n "get_router_client_with_failover" src/wanctl/autorate_continuous.py src/wanctl/steering/daemon.py src/wanctl/steering/cake_stats.py
    # Should show 2 matches per file (import + usage)
    # Run tests to ensure no regressions:
    .venv/bin/pytest tests/test_router_client.py tests/test_autorate.py -v
  </verify>
  <done>
    All 3 production entry points use FailoverRouterClient. REST failures will automatically fall back to SSH instead of crashing daemon.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire validate-deployment.sh into deploy script</name>
  <files>scripts/deploy.sh</files>
  <action>
    Add validation call to deploy.sh after deploy_core_files and before print_next_steps.

    Insert after line 565 (verify_deployment "$WAN_NAME"):
    ```bash
    # Run pre-startup validation
    print_step "Running pre-startup validation..."
    if ssh "$TARGET_HOST" "/opt/wanctl/scripts/validate-deployment.sh $TARGET_CONFIG_DIR/${WAN_NAME}.yaml"; then
        print_success "Pre-startup validation passed"
    else
        print_warning "Pre-startup validation found issues - review before starting daemon"
    fi
    ```

    Also deploy the validation script by adding to CORE_FILES list or creating dedicated deployment:
    - Add validate-deployment.sh to scripts deployed to target (around line 556)
    - Ensure it's copied to /opt/wanctl/scripts/ with execute permission

    Add deployment of validation script before verify_deployment call:
    ```bash
    # Deploy validation script
    print_step "Deploying validation script..."
    scp "$PROJECT_ROOT/scripts/validate-deployment.sh" "$TARGET_HOST:/tmp/validate-deployment.sh"
    ssh "$TARGET_HOST" "sudo mkdir -p $TARGET_CODE_DIR/scripts && sudo mv /tmp/validate-deployment.sh $TARGET_CODE_DIR/scripts/validate-deployment.sh && sudo chmod 755 $TARGET_CODE_DIR/scripts/validate-deployment.sh"
    ```
  </action>
  <verify>
    # Verify script contains validation call
    grep -n "validate-deployment.sh" scripts/deploy.sh
    # Should show deployment and execution of validation script

    # Dry-run test (won't modify target but shows what would happen)
    ./scripts/deploy.sh wan1 fake-host --dry-run 2>&1 | head -20 || true
  </verify>
  <done>
    deploy.sh copies validation script to target and runs it before reporting success. Deployment now validates config/connectivity automatically.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify E2E integration and run full test suite</name>
  <files>None (verification only)</files>
  <action>
    Verify the wiring is complete by running full test suite and checking integration points:

    1. Run all router client tests (proves failover behavior):
       .venv/bin/pytest tests/test_router_client.py -v

    2. Run tests that touch autorate_continuous, daemon, cake_stats:
       .venv/bin/pytest tests/test_autorate.py tests/test_steering_daemon.py -v

    3. Run full test suite to catch any regressions:
       .venv/bin/pytest tests/ -v --tb=short

    4. Verify imports work correctly:
       .venv/bin/python -c "from wanctl.autorate_continuous import WANController; print('autorate_continuous: OK')"
       .venv/bin/python -c "from wanctl.steering.daemon import SteeringDaemon; print('steering.daemon: OK')"
       .venv/bin/python -c "from wanctl.steering.cake_stats import CakeStatsReader; print('steering.cake_stats: OK')"

    5. Verify deploy.sh syntax:
       bash -n scripts/deploy.sh && echo "deploy.sh syntax OK"
  </action>
  <verify>
    All tests pass. All imports succeed. deploy.sh has valid syntax.
    Expected: 727 tests passing (same as before - this is wiring, not new tests)
  </verify>
  <done>
    E2E flows verified:
    - REST failover: FailoverRouterClient is used by all production code
    - Deployment validation: validate-deployment.sh called by deploy.sh
    v1.3 integration gaps closed.
  </done>
</task>

</tasks>

<verification>
1. grep shows get_router_client_with_failover in all 3 production files
2. grep shows validate-deployment.sh deployment and execution in deploy.sh
3. All 727 tests pass
4. Python imports succeed without errors
5. deploy.sh has valid bash syntax
</verification>

<success_criteria>
- Production daemon will automatically fail over REST->SSH on API failures
- Deployment process validates config/connectivity before reporting success
- All existing tests continue to pass (no regressions)
- v1.3-MILESTONE-AUDIT.md gaps are closed
</success_criteria>

<output>
After completion, create `.planning/phases/24-wire-integration-gaps/24-01-SUMMARY.md`
</output>
