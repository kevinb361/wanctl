---
phase: 20-phase2b-enablement
plan: 01
type: execute
---

<objective>
Enable Phase2B confidence-based steering in production with dry-run mode.

Purpose: Activate the Phase2BController integration (completed in Phase 15-06) to collect validation data. Dry-run mode logs steering decisions without affecting routing, allowing safe comparison against hysteresis logic.

Output: Production steering config with confidence scoring enabled (dry_run=true), deployed containers logging Phase2B decisions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/15-steeringdaemon-refactoring/15-06-SUMMARY.md

# Source files
@configs/steering.yaml
@configs/steering_config_v2.yaml
@src/wanctl/steering/daemon.py

**Production context:**
- Phase2BController code integrated in Phase 15-06
- `use_confidence_scoring` defaults to False (currently disabled)
- `dry_run` defaults to True when confidence scoring enabled (safe deployment)
- Container: cake-spectrum runs steering daemon
- Config path: /etc/wanctl/steering.yaml

**Prior decision (15-06):**
- dry_run=True as default for safe deployment
- Parallel evaluation: confidence logs decisions, hysteresis controls routing in dry-run
- Validation period: 1 week recommended before setting dry_run=false
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add confidence scoring config to steering.yaml</name>
  <files>configs/steering.yaml</files>
  <action>
Add mode section with `use_confidence_scoring: true` and confidence section to steering.yaml.

Use conservative initial values (copied from steering_config_v2.yaml reference with adjustments for production):
- steer_threshold: 55 (lower than v2's 70 - more sensitive during validation)
- recovery_threshold: 20
- sustain_duration_sec: 2.0 (faster than v2's 20s - matches 50ms cycle interval)
- recovery_sustain_sec: 3.0
- hold_down_duration_sec: 30.0 (shorter than v2's 600s for faster iteration)
- flap_detection enabled with 5-minute window, 4 max toggles, 60s penalty
- dry_run: true (CRITICAL - must be true for validation phase)

Add after thresholds section, before capacity_protection:

```yaml
# Operational mode
mode:
  cake_aware: true
  reset_counters: false
  enable_yellow_state: true
  use_confidence_scoring: true  # Phase 2B: Confidence-based steering

# Phase 2B: Confidence-based steering (DRY-RUN MODE)
# Logs decisions without affecting routing. Monitor logs to validate before
# setting dry_run: false.
confidence:
  steer_threshold: 55
  recovery_threshold: 20
  sustain_duration_sec: 2.0
  recovery_sustain_sec: 3.0
  hold_down_duration_sec: 30.0
  flap_detection_enabled: true
  flap_window_minutes: 5
  max_toggles: 4
  penalty_duration_sec: 60.0
  penalty_threshold_add: 15
  dry_run: true  # VALIDATION MODE - logs only, no routing changes
```
  </action>
  <verify>python -c "import yaml; c = yaml.safe_load(open('configs/steering.yaml')); assert c['mode']['use_confidence_scoring'] == True; assert c['confidence']['dry_run'] == True; print('Config valid')"</verify>
  <done>steering.yaml has mode.use_confidence_scoring=true and confidence.dry_run=true</done>
</task>

<task type="auto">
  <name>Task 2: Document CONFIG_SCHEMA.md with confidence section</name>
  <files>docs/CONFIG_SCHEMA.md</files>
  <action>
Add documentation for the `mode.use_confidence_scoring` and `confidence` section to CONFIG_SCHEMA.md.

Add after the existing `mode` section documentation:

```markdown
#### `mode.use_confidence_scoring` (optional)

- **Type:** boolean
- **Default:** `false`
- **Description:** Enable Phase 2B confidence-based steering. When enabled, requires `confidence` section.

### `confidence` (optional)

Phase 2B confidence-based steering configuration. Only used when `mode.use_confidence_scoring: true`.

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `steer_threshold` | number | 55 | Confidence score (0-100) to trigger steering |
| `recovery_threshold` | number | 20 | Confidence score to recover from steering |
| `sustain_duration_sec` | number | 2.0 | Seconds above threshold before steering |
| `recovery_sustain_sec` | number | 3.0 | Seconds below threshold before recovery |
| `hold_down_duration_sec` | number | 30.0 | Post-steer cooldown period |
| `flap_detection_enabled` | boolean | true | Enable flap detection |
| `flap_window_minutes` | number | 5 | Flap detection window |
| `max_toggles` | number | 4 | Max toggles before penalty |
| `penalty_duration_sec` | number | 60.0 | Flap penalty duration |
| `penalty_threshold_add` | number | 15 | Threshold increase during penalty |
| `dry_run` | boolean | true | Log-only mode (no routing changes) |

**Validation mode:** Set `dry_run: true` (default) to log Phase 2B decisions without affecting routing. Compare logged decisions against hysteresis behavior for validation.

**Production mode:** After validation, set `dry_run: false` to enable confidence-based routing decisions.
```
  </action>
  <verify>grep -q "use_confidence_scoring" docs/CONFIG_SCHEMA.md && grep -q "dry_run" docs/CONFIG_SCHEMA.md</verify>
  <done>CONFIG_SCHEMA.md documents confidence section with dry_run flag</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Updated steering.yaml with Phase2B confidence scoring config (dry_run=true)</what-built>
  <how-to-verify>
1. Review config changes:
   - `cat configs/steering.yaml | grep -A 20 'mode:'`
   - Verify use_confidence_scoring: true
   - Verify dry_run: true (CRITICAL for safe deployment)

2. Deploy to production:
   - Copy config to cake-spectrum: `scp configs/steering.yaml cake-spectrum:/etc/wanctl/steering.yaml`
   - Restart steering daemon: `ssh cake-spectrum 'systemctl restart wanctl-steering'`

3. Verify dry-run logging:
   - `ssh cake-spectrum 'journalctl -u wanctl-steering -f' | grep -i phase2b`
   - Should see: "[PHASE2B] Confidence scoring enabled (dry_run=True)"
   - During congestion events, should see confidence decisions logged

4. Confirm no routing changes:
   - Verify mangle rule state unchanged during dry-run logs
   - `ssh cake-spectrum 'curl -s http://127.0.0.1:9101/health' | jq .steering_state`
  </how-to-verify>
  <resume-signal>Type "approved" when dry-run logs confirmed, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] steering.yaml has mode.use_confidence_scoring=true
- [ ] steering.yaml has confidence.dry_run=true
- [ ] CONFIG_SCHEMA.md documents confidence section
- [ ] All tests pass: `make ci`
- [ ] Production deployment verified with dry-run logs appearing
</verification>

<success_criteria>
- Config changes applied to steering.yaml
- Documentation updated in CONFIG_SCHEMA.md
- Deployed to production in dry-run mode
- Phase2B dry-run logs appearing in steering daemon output
- No routing changes occurring (dry_run=true confirmed)
</success_criteria>

<output>
After completion, create `.planning/phases/20-phase2b-enablement/20-01-SUMMARY.md`:

# Phase 20 Plan 01: Phase2B Enablement Summary

**Phase2B confidence scoring enabled in dry-run mode for production validation**

## Accomplishments

- Added confidence scoring config to steering.yaml
- Documented confidence section in CONFIG_SCHEMA.md
- Deployed to cake-spectrum with dry_run=true
- Verified Phase2B logs appearing without routing changes

## Files Created/Modified

- `configs/steering.yaml` - Added mode and confidence sections
- `docs/CONFIG_SCHEMA.md` - Documented confidence config options

## Decisions Made

- Conservative initial thresholds (steer: 55, recovery: 20)
- 2s sustain duration (faster than reference, matches 50ms cycles)
- 30s hold-down (shorter for faster iteration during validation)

## Next Steps

**Validation period (1 week recommended):**
1. Monitor dry-run logs: `journalctl -u wanctl-steering | grep PHASE2B`
2. Compare confidence decisions vs hysteresis decisions
3. Tune thresholds if too many/few decisions logged
4. After validation: Set `dry_run: false` to enable live routing

**Go-live command (after validation):**
```bash
# Edit /etc/wanctl/steering.yaml on cake-spectrum
# Change: dry_run: false
# Restart: systemctl restart wanctl-steering
```
</output>
