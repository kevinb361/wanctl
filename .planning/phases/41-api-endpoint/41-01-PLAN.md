---
phase: 41-api-endpoint
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wanctl/health_check.py
  - tests/test_health_check_history.py
autonomous: true

must_haves:
  truths:
    - "GET /metrics/history returns JSON with metrics data"
    - "Query params filter results (range, from, to, metrics, wan)"
    - "Pagination works (limit, offset params)"
    - "Invalid params return 400 with error message"
    - "Empty results return 200 with empty data array"
  artifacts:
    - path: "src/wanctl/health_check.py"
      provides: "/metrics/history route handler"
      contains: "_handle_metrics_history"
    - path: "tests/test_health_check_history.py"
      provides: "Endpoint test coverage"
      min_lines: 100
  key_links:
    - from: "src/wanctl/health_check.py"
      to: "storage/reader.py"
      via: "query_metrics(), select_granularity() imports"
      pattern: "from wanctl\\.storage\\.reader import"
    - from: "src/wanctl/health_check.py"
      to: "storage/writer.py"
      via: "DEFAULT_DB_PATH import"
      pattern: "from wanctl\\.storage\\.writer import DEFAULT_DB_PATH"
---

<objective>
Add `/metrics/history` HTTP endpoint to autorate health server (port 9101) for programmatic access to stored metrics.

Purpose: Enables external tools and monitoring systems to query metrics history via HTTP API, completing the v1.7 Metrics History milestone.

Output: Working endpoint with query filtering, pagination, and comprehensive tests.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-api-endpoint/41-RESEARCH.md

# Source files
@src/wanctl/health_check.py
@src/wanctl/storage/reader.py
@src/wanctl/history.py

# Test patterns
@tests/test_health_check.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement /metrics/history endpoint</name>
  <files>src/wanctl/health_check.py</files>
  <action>
Extend HealthCheckHandler to handle `/metrics/history` route:

1. Add imports at top:
   - `from urllib.parse import urlparse, parse_qs`
   - `from datetime import UTC, datetime, timedelta`
   - `import re`
   - `from wanctl.storage.reader import query_metrics, select_granularity`
   - `from wanctl.storage.writer import DEFAULT_DB_PATH`

2. In do_GET(), add route before 404 fallback:
   ```python
   elif self.path.startswith("/metrics/history"):
       self._handle_metrics_history()
   ```

3. Add `_handle_metrics_history()` method that:
   - Parses query params via `_parse_history_params()` helper
   - Returns 400 JSON error on ValueError
   - Resolves time range (default: last 1h)
   - Calls `select_granularity(start_ts, end_ts)`
   - Calls `query_metrics()` with filters
   - Applies pagination (offset, limit) to results in Python
   - Builds JSON response with data array and metadata
   - Sends response via helper method

4. Add `_parse_history_params()` method:
   - Extract query string with `urlparse(self.path).query`
   - Parse with `parse_qs(query_string)`
   - Handle `range` param (e.g., "1h", "30m", "7d") - parse to timedelta
   - Handle `from` and `to` params (ISO 8601 timestamps) - parse to int
   - Handle `metrics` param (comma-separated) - split to list
   - Handle `wan` param (string)
   - Handle `limit` param (int, default 1000, max 10000)
   - Handle `offset` param (int, default 0)
   - Raise ValueError with descriptive message on invalid input

5. Add `_resolve_time_range()` method:
   - If `range` param: `end_ts = now, start_ts = now - duration`
   - Elif `from` param: `start_ts = from, end_ts = to or now`
   - Else: default to last 1 hour

6. Add `_send_json_response(data, status_code=200)` helper:
   - Send response, Content-Type header, JSON body

7. Add `_send_json_error(status_code, message)` helper:
   - Send `{"error": message}` with given status

8. Add `_format_metric(row)` helper:
   - Convert Unix timestamp to ISO 8601: `datetime.fromtimestamp(ts, tz=UTC).isoformat()`
   - Return dict with: timestamp, wan_name, metric_name, value, labels, granularity

Response structure:
```json
{
  "data": [...],
  "metadata": {
    "total_count": N,
    "returned_count": M,
    "granularity": "raw|1m|5m|1h",
    "limit": 1000,
    "offset": 0,
    "query": {
      "start": "ISO8601",
      "end": "ISO8601",
      "metrics": [...] or null,
      "wan": "name" or null
    }
  }
}
```

Duration parsing regex: `r"^(\d+)([smhdw])$"` with units s=1, m=60, h=3600, d=86400, w=604800 (matches history.py pattern).

Use `datetime.fromisoformat()` for ISO 8601 parsing (handles timezone if present, assumes local if missing).
  </action>
  <verify>
Run quick smoke test:
```bash
# Start autorate daemon briefly or test with mock
cd /home/kevin/projects/wanctl
.venv/bin/python -c "
from wanctl.health_check import HealthCheckHandler
# Verify new methods exist
assert hasattr(HealthCheckHandler, '_handle_metrics_history')
assert hasattr(HealthCheckHandler, '_parse_history_params')
print('Methods added successfully')
"
```
  </verify>
  <done>
HealthCheckHandler has _handle_metrics_history method and supporting helpers. Route added to do_GET. Compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for /metrics/history</name>
  <files>tests/test_health_check_history.py</files>
  <action>
Create new test file following patterns from test_health_check.py:

1. Imports:
   - json, socket, time, urllib.request, urllib.error
   - pytest, MagicMock, patch, tmp_path fixture
   - HealthCheckHandler, start_health_server, HealthCheckServer
   - DEFAULT_DB_PATH, MetricsWriter (for test data setup)

2. Helper `find_free_port()` - same as test_health_check.py

3. Fixture `reset_handler_state` - same pattern, reset class-level state

4. Fixture `sample_db(tmp_path)`:
   - Create temp database with MetricsWriter
   - Insert 10+ sample metrics with varying timestamps
   - Return db_path for tests

5. Test classes:

**TestMetricsHistoryEndpoint** (server integration tests):
- `test_returns_json`: GET /metrics/history returns 200 + valid JSON
- `test_default_time_range`: No params defaults to last 1h
- `test_range_param`: `?range=1h` filters correctly
- `test_from_to_params`: `?from=...&to=...` filters correctly
- `test_metrics_filter`: `?metrics=wanctl_rtt_ms,wanctl_state` filters
- `test_wan_filter`: `?wan=spectrum` filters
- `test_pagination_limit`: `?limit=5` returns max 5 results
- `test_pagination_offset`: `?offset=5` skips first 5
- `test_pagination_metadata`: Response includes total_count, returned_count
- `test_empty_results`: Returns 200 with empty data array
- `test_response_metadata_structure`: Verify metadata fields present
- `test_timestamp_format_iso8601`: Data timestamps are ISO 8601 strings

**TestHistoryParamsValidation** (400 error cases):
- `test_invalid_range_format`: `?range=abc` returns 400
- `test_invalid_limit_not_integer`: `?limit=abc` returns 400
- `test_invalid_offset_not_integer`: `?offset=xyz` returns 400
- `test_invalid_from_timestamp`: `?from=not-a-date` returns 400

**TestHistoryHelperMethods** (unit tests for parsing):
- `test_parse_duration_hours`: "1h" -> 3600 seconds
- `test_parse_duration_minutes`: "30m" -> 1800 seconds
- `test_parse_duration_days`: "7d" -> 604800 seconds
- `test_parse_duration_invalid`: "abc" raises ValueError
- `test_parse_iso_timestamp`: "2026-01-25T14:00:00" -> int
- `test_format_metric_iso8601`: Unix timestamp converted correctly

For server tests: Use pattern from test_health_check.py:
- start server on free port
- make HTTP request
- assert response
- server.shutdown() in finally

Mock database path with patch or use tmp database fixture.
  </action>
  <verify>
```bash
cd /home/kevin/projects/wanctl
.venv/bin/pytest tests/test_health_check_history.py -v
```
All tests pass.
  </verify>
  <done>
New test file exists with 15+ tests covering endpoint, validation, and helper methods. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. Run all tests:
   ```bash
   .venv/bin/pytest tests/test_health_check*.py -v
   ```

2. Manual endpoint test (if daemon available):
   ```bash
   curl -s "http://127.0.0.1:9101/metrics/history?range=1h" | python3 -m json.tool
   curl -s "http://127.0.0.1:9101/metrics/history?limit=5" | python3 -m json.tool
   curl -s "http://127.0.0.1:9101/metrics/history?range=abc" # Should return 400
   ```

3. Type check:
   ```bash
   .venv/bin/mypy src/wanctl/health_check.py
   ```
</verification>

<success_criteria>
- GET /metrics/history returns JSON with data and metadata
- Query params (range, from, to, metrics, wan, limit, offset) work correctly
- Invalid params return 400 with descriptive error
- All new tests pass
- No regressions in existing health_check tests
- Type checking passes
</success_criteria>

<output>
After completion, create `.planning/phases/41-api-endpoint/41-01-SUMMARY.md`
</output>
