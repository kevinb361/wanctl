---
phase: 40-cli-tool
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - src/wanctl/history.py
  - pyproject.toml
  - tests/test_history_cli.py
autonomous: true

must_haves:
  truths:
    - "wanctl-history command is available after pip install"
    - "User can query last N time units (--last 1h, 30m, 7d)"
    - "User can query by absolute time range (--from/--to)"
    - "User can filter by metric names (--metrics)"
    - "Output displays as formatted table by default"
    - "Output available as JSON (--json flag)"
    - "Summary statistics shown with --summary flag"
    - "No data returns empty table with message, exit 0"
  artifacts:
    - path: "src/wanctl/history.py"
      provides: "CLI entry point with argument parsing and output formatting"
      exports: ["main"]
      min_lines: 150
    - path: "tests/test_history_cli.py"
      provides: "CLI integration tests"
      min_lines: 100
  key_links:
    - from: "src/wanctl/history.py"
      to: "wanctl.storage.reader"
      via: "query_metrics import"
      pattern: "from wanctl\\.storage.*import.*query_metrics"
    - from: "src/wanctl/history.py"
      to: "argparse"
      via: "CLI argument parsing"
      pattern: "argparse\\.ArgumentParser"
    - from: "pyproject.toml"
      to: "wanctl.history:main"
      via: "entry point registration"
      pattern: 'wanctl-history.*=.*"wanctl\\.history:main"'
---

<objective>
Create wanctl-history CLI tool for querying metrics history.

Purpose: Fulfill requirements CLI-01 through CLI-05 for human and machine access to stored metrics.
Output: `src/wanctl/history.py` with CLI interface, `wanctl-history` command available.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-cli-tool/40-CONTEXT.md
@.planning/phases/40-cli-tool/40-RESEARCH.md
@.planning/phases/40-cli-tool/40-01-SUMMARY.md
@src/wanctl/storage/reader.py
@src/wanctl/calibrate.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create history.py CLI module</name>
  <files>src/wanctl/history.py</files>
  <action>
Create `src/wanctl/history.py` following RESEARCH.md patterns and CONTEXT.md decisions:

1. **Argument parsing (argparse):**
   - `--last DURATION`: Relative time (1h, 30m, 7d, etc.) - parse with regex + timedelta
   - `--from TIMESTAMP`: Start time (ISO 8601 or "YYYY-MM-DD HH:MM")
   - `--to TIMESTAMP`: End time (same formats)
   - `--metrics NAMES`: Comma-separated metric names (filter)
   - `--wan NAME`: Filter by WAN name
   - `--json`: Output as JSON instead of table
   - `--summary`: Show summary statistics instead of raw data
   - `-v/--verbose`: Extra columns (wan, labels, granularity)
   - `--db PATH`: Alternate database path (default from config_base)
   - Default behavior: `--last 1h` when no time args provided

2. **Duration parsing function:**
   ```python
   def parse_duration(value: str) -> timedelta:
       """Parse '1h', '30m', '7d' into timedelta."""
       units = {'s': 1, 'm': 60, 'h': 3600, 'd': 86400, 'w': 604800}
       match = re.match(r'^(\d+)([smhdw])$', value.lower())
       if not match:
           raise argparse.ArgumentTypeError(f"Invalid duration: {value}")
       return timedelta(seconds=int(match.group(1)) * units[match.group(2)])
   ```

3. **Timestamp parsing function:**
   - Accept ISO 8601 (datetime.fromisoformat)
   - Accept "YYYY-MM-DD HH:MM" format
   - Return Unix timestamp (int)

4. **Output formatting:**
   - **Table mode (default):** Use tabulate with "simple" format
     - Default columns: timestamp, metric, value
     - Verbose adds: wan, labels, granularity
     - Timestamps: absolute format "2026-01-25 14:32:05" (local time)
     - Values: adaptive precision (25.5 not 25.500000)
   - **JSON mode:** json.dumps(results, indent=2)
   - **Summary mode:** Group by metric_name, compute min/max/avg/p50/p95/p99
     - State metrics: Show percentages (GREEN: 85%, YELLOW: 10%, etc.)

5. **Formatting helpers:**
   ```python
   def format_timestamp(ts: int) -> str:
       return datetime.fromtimestamp(ts).strftime("%Y-%m-%d %H:%M:%S")

   def format_value(value: float) -> str:
       if value == int(value):
           return str(int(value))
       formatted = f"{value:.3f}".rstrip('0').rstrip('.')
       return formatted
   ```

6. **Main function flow:**
   - Parse args
   - Determine time range (from args or default --last 1h)
   - Select granularity if not specified (use select_granularity)
   - Call query_metrics()
   - If no results: print "No data found for the specified time range.", exit 0
   - Format and output results
   - Return 0 on success

7. **Error handling:**
   - Database not found: "Database not found: {path}. Run wanctl to generate data."
   - Invalid args: argparse handles (shows usage)
   - Empty results: informational message, exit 0 (per CONTEXT.md)

8. **Examples in help epilog:**
   ```
   Examples:
     %(prog)s --last 1h
     %(prog)s --last 24h --metrics wanctl_rtt_ms,wanctl_state
     %(prog)s --from "2026-01-25 14:00" --to "2026-01-25 15:00"
     %(prog)s --last 7d --summary
     %(prog)s --last 1h --json
   ```

Use imports from storage module (query_metrics, compute_summary, select_granularity).
Use DEFAULT_DB_PATH from storage.writer.
  </action>
  <verify>
`.venv/bin/python -m wanctl.history --help` shows all options
  </verify>
  <done>
history.py module parses all CLI arguments and produces formatted output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register entry point and install</name>
  <files>pyproject.toml</files>
  <action>
Add wanctl-history entry point to pyproject.toml:

```toml
[project.scripts]
wanctl = "wanctl.autorate_continuous:main"
wanctl-calibrate = "wanctl.calibrate:main"
wanctl-steering = "wanctl.steering.daemon:main"
wanctl-history = "wanctl.history:main"
```

Then reinstall the package to register the command:
```bash
cd /home/kevin/projects/wanctl && .venv/bin/pip install -e .
```
  </action>
  <verify>
`.venv/bin/wanctl-history --help` shows help text
  </verify>
  <done>
wanctl-history command available in PATH after pip install.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CLI integration tests</name>
  <files>tests/test_history_cli.py</files>
  <action>
Create CLI tests in `tests/test_history_cli.py`:

1. **Argument parsing tests:**
   - test_parse_duration_hours
   - test_parse_duration_minutes
   - test_parse_duration_days
   - test_parse_duration_weeks
   - test_parse_duration_invalid_raises
   - test_parse_timestamp_iso8601
   - test_parse_timestamp_datetime_format
   - test_default_time_range_is_1h

2. **Output format tests (use subprocess or mock):**
   - test_table_output_has_headers
   - test_json_output_is_valid_json
   - test_summary_output_shows_statistics
   - test_verbose_adds_extra_columns
   - test_empty_results_shows_message_exit_0

3. **Integration tests (with temp database):**
   - test_query_last_1h_returns_recent_data
   - test_query_with_metrics_filter
   - test_query_with_wan_filter
   - test_from_to_range_works
   - test_summary_groups_by_metric

4. **Error handling tests:**
   - test_missing_database_shows_helpful_message
   - test_invalid_duration_shows_error

5. **Formatting tests:**
   - test_format_timestamp_local_time
   - test_format_value_adaptive_precision
   - test_state_summary_shows_percentages

Use pytest fixtures:
- tmp_path for temporary database
- Create test data via MetricsWriter
- Use subprocess.run() for CLI tests or mock sys.argv + call main()

For subprocess tests:
```python
import subprocess
result = subprocess.run(
    [".venv/bin/python", "-m", "wanctl.history", "--last", "1h", "--db", str(db_path)],
    capture_output=True, text=True
)
assert result.returncode == 0
```
  </action>
  <verify>`.venv/bin/pytest tests/test_history_cli.py -v`</verify>
  <done>All CLI tests pass. Coverage for argument parsing, output formats, error handling.</done>
</task>

</tasks>

<verification>
```bash
# Command available
.venv/bin/wanctl-history --help

# Test with real database (if exists)
.venv/bin/wanctl-history --last 1h --db /var/lib/wanctl/metrics.db 2>/dev/null || echo "No prod data yet"

# JSON output works
.venv/bin/wanctl-history --last 1h --json --db /tmp/test.db 2>/dev/null | python -m json.tool || echo "Expected: no data"

# All tests pass
.venv/bin/pytest tests/test_history_cli.py -v

# Full test suite still passes
.venv/bin/pytest tests/ -v --tb=short
```
</verification>

<success_criteria>
- `wanctl-history` command available after pip install (CLI-01)
- `--last 1h`, `--from/--to` time queries work (CLI-02)
- `--metrics` filter works (CLI-03)
- Table output (default) and `--json` output work (CLI-04)
- `--summary` shows min/max/avg/p95 statistics (CLI-05)
- Empty results show message, exit 0
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/40-cli-tool/40-02-SUMMARY.md`
</output>
