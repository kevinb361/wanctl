# Phase 9 Plan 2: Merge lockfile.py into lock_utils.py

**Merge LockFile context manager into lock_utils.py for unified lock handling.**

## Objective

Eliminate lockfile.py by moving `LockFile` class and `LockAcquisitionError` into lock_utils.py, consolidating all lock-related code in one module.

## Execution Context

@src/wanctl/lockfile.py (88 lines - source)
@src/wanctl/lock_utils.py (200 lines - target)

## Context

**Current state:**
- `lock_utils.py`: Core lock functions (is_process_alive, read_lock_pid, validate_lock, acquire_lock, validate_and_acquire_lock)
- `lockfile.py`: Context manager `LockFile` and `LockAcquisitionError` exception - imports from lock_utils

**Relationship:**
- lockfile.py is a thin wrapper around lock_utils
- It imports `validate_and_acquire_lock` from lock_utils
- Moving into lock_utils eliminates the extra module

**Import analysis:**
```bash
grep -r "from wanctl.lockfile" src/ tests/
# autorate_continuous.py imports: LockAcquisitionError, LockFile
```

## Tasks

### Task 1: Move LockAcquisitionError and LockFile to lock_utils.py

**File:** src/wanctl/lock_utils.py

1. Read lockfile.py to get exact implementations
2. Add `LockAcquisitionError` exception class to lock_utils.py (after imports, before functions)
3. Add `LockFile` context manager class to lock_utils.py (after functions, at end)
4. Add any missing imports (time module for LockFile.__enter__)
5. Update internal import: `from .lock_utils import validate_and_acquire_lock` → direct call

### Task 2: Update all imports

1. Find all files importing from `wanctl.lockfile`:
   ```bash
   grep -rn "from wanctl.lockfile" src/ tests/
   ```
2. Update each import: `from wanctl.lockfile import ...` → `from wanctl.lock_utils import ...`

### Task 3: Delete lockfile.py and verify

1. Delete src/wanctl/lockfile.py
2. Run tests: `uv run pytest tests/ -v --tb=short`
3. Run linting: `uv run ruff check src/wanctl/lock_utils.py`

## Verification

```bash
# Confirm lockfile.py is deleted
ls src/wanctl/lockfile.py  # Should not exist

# Confirm no remaining imports
grep -rn "wanctl.lockfile" src/ tests/  # Should return empty

# All tests pass
uv run pytest tests/ -v --tb=short
```

## Success Criteria

- [ ] `LockAcquisitionError` moved to lock_utils.py
- [ ] `LockFile` context manager moved to lock_utils.py
- [ ] All imports updated (no references to wanctl.lockfile)
- [ ] lockfile.py deleted
- [ ] All 474 tests pass
- [ ] No linting errors

## Output

- Modified: src/wanctl/lock_utils.py (adds LockAcquisitionError, LockFile)
- Deleted: src/wanctl/lockfile.py
- Modified: Consumer files (import updates)
