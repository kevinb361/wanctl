# Plan 16-01: Fix Phase2B Timer Interval

## Objective

Fix the Phase2B timer decrements to use the actual cycle interval instead of hardcoded 2 seconds. Currently, the TimerManager decrements timers by 2 on each cycle, but the steering daemon cycles at 0.05s (50ms). This causes timers to expire 40x faster than intended.

## Bug Analysis

**Location:** `src/wanctl/steering/steering_confidence.py`

**Affected code:**
- Line 242: `timer_state.degrade_timer -= 2  # Assessment interval is 2s`
- Line 280: `timer_state.hold_down_timer -= 2`
- Line 330: `timer_state.recovery_timer -= 2`

**Actual interval:** `ASSESSMENT_INTERVAL_SECONDS = 0.05` (in daemon.py)

**Impact:** Timer durations are effectively 40x shorter than configured:
- `sustain_duration_sec: 2` expires in ~0.05s instead of 2s
- `hold_down_duration_sec: 30` expires in ~0.75s instead of 30s
- `recovery_sustain_sec: 10` expires in ~0.25s instead of 10s

## Tasks

### Task 1: Add cycle_interval parameter to TimerManager

**File:** `src/wanctl/steering/steering_confidence.py`

1. Add `cycle_interval: float` parameter to `TimerManager.__init__()` (after line 192)
2. Store as `self.cycle_interval`
3. Replace hardcoded `2` with `self.cycle_interval` in:
   - `update_degrade_timer()` line 242
   - `update_hold_down_timer()` line 280
   - `update_recovery_timer()` line 330
4. Update the misleading comment on line 242

### Task 2: Pass cycle_interval from Phase2BController

**File:** `src/wanctl/steering/steering_confidence.py`

1. Add `cycle_interval: float = 0.05` parameter to `Phase2BController.__init__()` (line 500)
2. Pass `cycle_interval` to TimerManager constructor (line 519)

### Task 3: Pass cycle_interval from SteeringDaemon

**File:** `src/wanctl/steering/daemon.py`

1. Pass `cycle_interval=ASSESSMENT_INTERVAL_SECONDS` to Phase2BController (line 626)

### Task 4: Add unit tests

**File:** `tests/test_steering_timers.py` (new)

Add tests:
1. `test_timer_manager_decrement_uses_cycle_interval` - Verify timer decrements by cycle_interval
2. `test_degrade_timer_expiry_timing` - Verify degrade timer expires after correct number of cycles
3. `test_hold_down_timer_expiry_timing` - Verify hold-down timer expires correctly
4. `test_recovery_timer_expiry_timing` - Verify recovery timer expires correctly
5. `test_default_cycle_interval` - Verify Phase2BController defaults to 0.05s

## Verification

```bash
make ci   # All tests pass including new timer tests
```

Manual verification:
1. Deploy to cake-spectrum with dry-run
2. Trigger congestion event
3. Verify log shows timer counting down in ~0.05s increments
4. Verify sustain_duration (2s) takes ~40 cycles to expire

## Success Criteria

- All timer decrements use configurable cycle_interval
- Default cycle_interval is 0.05s (50ms)
- New tests verify timer behavior
- Existing tests pass
- Log output shows correct timer values

## Risk Assessment

**LOW risk:**
- Bug fix with clear scope
- No changes to steering decision logic
- No changes to confidence scoring
- Dry-run mode continues to function

## Files Modified

1. `src/wanctl/steering/steering_confidence.py` - Add cycle_interval to TimerManager and Phase2BController
2. `src/wanctl/steering/daemon.py` - Pass ASSESSMENT_INTERVAL_SECONDS to Phase2BController
3. `tests/test_steering_timers.py` - New test file for timer behavior
