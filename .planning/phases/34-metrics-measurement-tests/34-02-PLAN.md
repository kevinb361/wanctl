---
phase: 34-metrics-measurement-tests
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_rtt_measurement.py
autonomous: true

must_haves:
  truths:
    - "rtt_measurement.py has >=90% test coverage"
    - "parse_ping_output handles all edge cases (empty, no matches, fallback)"
    - "All 4 RTTAggregationStrategy values tested"
    - "Timeout and error paths in ping_host tested"
    - "ping_hosts_concurrent timeout handling tested"
  artifacts:
    - path: "tests/test_rtt_measurement.py"
      provides: "Comprehensive RTT measurement tests"
      min_lines: 250
  key_links:
    - from: "tests/test_rtt_measurement.py"
      to: "src/wanctl/rtt_measurement.py"
      via: "import and test all paths"
      pattern: "from wanctl.rtt_measurement import"
---

<objective>
Expand test coverage for rtt_measurement.py (67% -> 90%) by testing all uncovered edge cases and code paths.

Purpose: Achieve MEAS-05 and MEAS-06 requirements. RTT measurement is the core input to congestion detection; all edge cases must be tested.

Output: Expanded tests/test_rtt_measurement.py covering all uncovered lines identified in research.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-metrics-measurement-tests/34-RESEARCH.md

@src/wanctl/rtt_measurement.py
@tests/test_rtt_measurement.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parse_ping_output edge case tests</name>
  <files>tests/test_rtt_measurement.py</files>
  <action>
Add new test class TestParsePingOutputEdgeCases to tests/test_rtt_measurement.py:

**Empty and missing data tests:**
- test_empty_string_returns_empty_list: parse_ping_output("") returns []
- test_whitespace_only_returns_empty: parse_ping_output("   \n  ") returns []
- test_no_time_marker_returns_empty: Lines without "time=" return empty list

**Fallback parsing tests (lines 59-68):**
- test_fallback_parsing_no_space_before_ms: "time=12.3ms" (regex fails, fallback succeeds)
- test_fallback_parsing_invalid_value_logs: Invalid float logged if logger provided
- test_fallback_parsing_index_error_handled: Malformed "time=" without value

**Logger integration tests:**
- test_parse_with_logger_logs_failures: Logger.debug called on parse failure
- test_parse_without_logger_no_crash: logger_instance=None works without error

**Multiple samples tests:**
- test_parse_multiple_lines_extracts_all: Multi-line output returns all RTTs
- test_parse_mixed_valid_invalid_lines: Valid lines extracted, invalid skipped
  </action>
  <verify>
.venv/bin/pytest tests/test_rtt_measurement.py::TestParsePingOutputEdgeCases -v --tb=short
  </verify>
  <done>
- TestParsePingOutputEdgeCases class exists with 8+ test methods
- All tests pass
- Lines 46, 50, 60-68 covered
  </done>
</task>

<task type="auto">
  <name>Task 2: Add RTTMeasurement edge case tests</name>
  <files>tests/test_rtt_measurement.py</files>
  <action>
Add new test classes to tests/test_rtt_measurement.py:

**TestAggregationStrategies class:**
- test_average_strategy: AVERAGE returns mean of samples
- test_median_strategy: MEDIAN returns median of samples
- test_min_strategy: MIN returns smallest value
- test_max_strategy: MAX returns largest value
- test_empty_list_raises_value_error: Empty list raises ValueError
- test_single_value_all_strategies: All strategies return same for single value

**TestPingHostEdgeCases class:**
- test_timeout_total_parameter_used: When timeout_total set, used as subprocess timeout
- test_no_rtt_samples_returns_none_logs_warning: Empty RTT list logs warning, returns None
- test_log_sample_stats_logs_debug: log_sample_stats=True logs min/max/median
- test_generic_exception_logged: Non-timeout exception caught and logged
- test_returncode_nonzero_logs_warning: Failed ping logs warning
- test_subprocess_timeout_logs_warning: TimeoutExpired caught and logged

**TestPingHostsConcurrentEdgeCases class:**
- test_concurrent_timeout_logs_debug: concurrent.futures.TimeoutError logged at debug level
- test_none_results_filtered: ping_host returning None excluded from results

**IMPORTANT patterns:**
- Use patch("wanctl.rtt_measurement.subprocess.run") for all subprocess mocks
- Use MagicMock for logger fixture
- Test each aggregation strategy with a known list of values
- Use side_effect for exception testing
- Verify logger calls with assert_called() patterns
  </action>
  <verify>
.venv/bin/pytest tests/test_rtt_measurement.py -v --tb=short
.venv/bin/pytest tests/test_rtt_measurement.py --cov=wanctl.rtt_measurement --cov-report=term-missing | grep "rtt_measurement"
  </verify>
  <done>
- TestAggregationStrategies class exists with 6 test methods
- TestPingHostEdgeCases class exists with 6 test methods
- TestPingHostsConcurrentEdgeCases class exists with 2 test methods
- All tests pass
- rtt_measurement.py coverage >= 90%
  </done>
</task>

</tasks>

<verification>
```bash
# Verify all RTT tests pass
.venv/bin/pytest tests/test_rtt_measurement.py -v

# Verify coverage target met
.venv/bin/pytest tests/test_rtt_measurement.py --cov=wanctl.rtt_measurement --cov-report=term-missing

# Should show >= 90% coverage
```
</verification>

<success_criteria>
- [ ] TestParsePingOutputEdgeCases class added with empty/fallback/logger tests
- [ ] TestAggregationStrategies class added testing all 4 strategies
- [ ] TestPingHostEdgeCases class added testing timeout/error paths
- [ ] TestPingHostsConcurrentEdgeCases class added for concurrent timeout
- [ ] rtt_measurement.py coverage >= 90% (from 67%)
- [ ] All tests pass
- [ ] MEAS-05, MEAS-06 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/34-metrics-measurement-tests/34-02-SUMMARY.md`
</output>
