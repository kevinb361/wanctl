---
phase: 10-utility-consolidation-part-2
plan: 02
type: execute
---

<objective>
Merge rate_limiter.py into rate_utils.py to consolidate rate-related utilities.

Purpose: Combine rate limiting and rate bounds enforcement into a single rate utilities module, following the Phase 9 consolidation pattern.
Output: rate_utils.py containing RateLimiter class, rate_limiter.py deleted.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/10-utility-consolidation-part-2/10-01-SUMMARY.md

# Source files being modified:
@src/wanctl/rate_limiter.py
@src/wanctl/rate_utils.py
@src/wanctl/autorate_continuous.py
@tests/test_rate_limiter.py

**Established pattern from Phase 9:**
- Move all code from smaller module to larger related module
- Update all imports across codebase
- Delete the smaller module
- Verify tests pass
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move RateLimiter class to rate_utils.py</name>
  <files>src/wanctl/rate_utils.py</files>
  <action>
  Move the RateLimiter class from rate_limiter.py to rate_utils.py:
  1. Add required imports at top: `import time` and `from collections import deque`
  2. Add the RateLimiter class after the existing rate bounds functions
  3. Include full docstring and all methods (can_change, record_change, changes_remaining, time_until_available)
  4. Update module docstring to mention rate limiting in addition to bounds enforcement

  Do NOT change any class logic - pure code movement.
  </action>
  <verify>python -c "from wanctl.rate_utils import RateLimiter; rl = RateLimiter(10, 60); print(rl.can_change())"</verify>
  <done>RateLimiter class exists in rate_utils.py and can_change() returns True</done>
</task>

<task type="auto">
  <name>Task 2: Update imports in autorate_continuous.py and tests</name>
  <files>src/wanctl/autorate_continuous.py, tests/test_rate_limiter.py</files>
  <action>
  Update import statements:

  1. In autorate_continuous.py:
     - Change: `from wanctl.rate_limiter import RateLimiter`
     - To: `from wanctl.rate_utils import RateLimiter`
     - Note: `from wanctl.rate_utils import enforce_rate_bounds` already exists, can combine imports

  2. In tests/test_rate_limiter.py:
     - Change: `from wanctl.rate_limiter import RateLimiter`
     - To: `from wanctl.rate_utils import RateLimiter`

  No other changes needed - class interface unchanged.
  </action>
  <verify>python -c "from wanctl.autorate_continuous import WANController; print('import ok')"</verify>
  <done>Both files import RateLimiter from rate_utils</done>
</task>

<task type="auto">
  <name>Task 3: Delete rate_limiter.py and verify tests</name>
  <files>src/wanctl/rate_limiter.py</files>
  <action>
  1. Delete src/wanctl/rate_limiter.py (113 lines)
  2. Run full test suite to verify no breakage
  3. Confirm no remaining imports of rate_limiter anywhere in codebase

  Use: grep -r "rate_limiter" src/ tests/ to verify no stale imports remain.
  Note: test_rate_limiter.py filename stays (tests the RateLimiter class, now from rate_utils).
  </action>
  <verify>make ci</verify>
  <done>rate_limiter.py deleted, all tests pass, no stale imports</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] RateLimiter class exists in rate_utils.py with full docstring
- [ ] autorate_continuous.py imports RateLimiter from rate_utils
- [ ] test_rate_limiter.py imports RateLimiter from rate_utils
- [ ] rate_limiter.py deleted
- [ ] `grep -r "from wanctl.rate_limiter" src/ tests/` returns no results
- [ ] `make ci` passes (all tests, lint, type check)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No imports of rate_limiter module remain
- rate_limiter.py removed from codebase
- 113 lines of module fragmentation eliminated
- Phase 10 complete (both plans finished)
</success_criteria>

<output>
After completion, create `.planning/phases/10-utility-consolidation-part-2/10-02-SUMMARY.md`
</output>
