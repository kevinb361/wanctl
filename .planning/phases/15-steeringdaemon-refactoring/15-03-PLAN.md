---
phase: 15-steeringdaemon-refactoring
plan: 03
type: execute
---

<objective>
Extract routing control logic from state machine methods into dedicated helper.

Purpose: Separate routing operations (enable/disable steering + transition logging + metrics) from state machine decision logic. Reduces duplication and prepares for S6 unification.
Output: New execute_steering_transition() method with unit tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 7 analysis (S4 recommendation)
@.planning/phases/07-core-algorithm-analysis/07-02-steeringdaemon-findings.md
@docs/CORE-ALGORITHM-ANALYSIS.md

# Source files
@src/wanctl/steering/daemon.py

**Tech stack available:** Python 3.12, pytest
**Established patterns:** Helper extraction with boolean returns
**Constraining decisions:**
- Phase 7: S4 identified as MEDIUM risk (state machine methods must use return value)
- RouterOS control is PROTECTED zone (C2 security fix, W6 retry)
- Metrics recording must be preserved
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create execute_steering_transition() method</name>
  <files>src/wanctl/steering/daemon.py</files>
  <action>
Create new method that consolidates routing control from both state machine methods:

```python
def execute_steering_transition(
    self,
    from_state: str,
    to_state: str,
    enable_steering: bool
) -> bool:
    """
    Execute steering state transition with routing control.

    Handles router enable/disable, transition logging, state update,
    and metrics recording.

    Args:
        from_state: Current state name
        to_state: Target state name
        enable_steering: True to enable steering (degrade), False to disable (recover)

    Returns:
        True if transition succeeded, False if routing failed
    """
```

Method should:
1. Call router.enable_steering() or router.disable_steering() based on flag
2. On failure: log error, return False (stay in current state)
3. On success: call state_mgr.log_transition(), update state["current_state"]
4. Record metrics if config.metrics_enabled
5. Return True

Update _update_state_machine_cake_aware() lines 714-726 and 757-769 to use helper.
Update _update_state_machine_legacy() lines 816-822 and 845-851 to use helper.

Both methods should:
- Call execute_steering_transition() with appropriate args
- Set state_changed = True only if helper returns True
- Reset counter only if helper returns True
  </action>
  <verify>make ci passes (all tests)</verify>
  <done>Routing control extracted, both state machines updated, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for routing transitions</name>
  <files>tests/test_steering_daemon.py</files>
  <action>
Add unit tests for execute_steering_transition() method:

1. Test enable_steering=True calls router.enable_steering()
2. Test enable_steering=False calls router.disable_steering()
3. Test successful transition updates state["current_state"]
4. Test successful transition calls state_mgr.log_transition()
5. Test router failure returns False without state change
6. Test metrics recorded when config.metrics_enabled=True
7. Test metrics not recorded when config.metrics_enabled=False

Mock router with configurable return values.
Verify state changes only on success.
  </action>
  <verify>pytest tests/test_steering_daemon.py -v passes with new tests</verify>
  <done>7+ unit tests added, routing isolation verified, all tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make ci` passes (all tests including new ones)
- [ ] execute_steering_transition() method exists
- [ ] Both state machine methods use the helper (no inline routing)
- [ ] Routing failure behavior preserved (stay in current state)
- [ ] Metrics recording preserved
</verification>

<success_criteria>
- Routing control extracted (~24 lines consolidated)
- Both _update_state_machine_* methods simplified
- All tests pass
- No behavioral changes (router calls, logging, metrics identical)
</success_criteria>

<output>
After completion, create `.planning/phases/15-steeringdaemon-refactoring/15-03-SUMMARY.md`
</output>
