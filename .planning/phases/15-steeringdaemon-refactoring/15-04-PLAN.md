---
phase: 15-steeringdaemon-refactoring
plan: 04
type: execute
---

<objective>
Extract daemon control loop from main() into dedicated function.

Purpose: Improve testability by isolating the event loop (cycle execution + watchdog + failure tracking + sleep) from initialization/cleanup logic.
Output: New run_daemon_loop() function with unit tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 7 analysis (S5 recommendation)
@.planning/phases/07-core-algorithm-analysis/07-02-steeringdaemon-findings.md
@docs/CORE-ALGORITHM-ANALYSIS.md

# Source files
@src/wanctl/steering/daemon.py

**Tech stack available:** Python 3.12, pytest
**Established patterns:** Module-level functions for entry point logic
**Constraining decisions:**
- Phase 7: S5 identified as MEDIUM risk (watchdog tightly coupled)
- Signal handling is PROTECTED zone (W5 fix)
- Shutdown event handling must remain identical
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create run_daemon_loop() function</name>
  <files>src/wanctl/steering/daemon.py</files>
  <action>
Extract lines 1121-1159 from main() into new module-level function:

```python
def run_daemon_loop(
    daemon: SteeringDaemon,
    config: SteeringConfig,
    logger: logging.Logger,
    shutdown_event: threading.Event
) -> int:
    """
    Run continuous daemon loop with watchdog and failure tracking.

    Executes steering cycles until shutdown signal received.
    Manages systemd watchdog notifications based on cycle success.
    Stops watchdog after MAX_CONSECUTIVE_FAILURES to trigger restart.

    Args:
        daemon: Initialized SteeringDaemon instance
        config: Steering configuration (for measurement_interval)
        logger: Logger for status messages
        shutdown_event: Event signaling shutdown request

    Returns:
        Exit code: 0 for graceful shutdown
    """
```

Function should:
1. Initialize consecutive_failures=0, MAX_CONSECUTIVE_FAILURES=3, watchdog_enabled=True
2. Log startup message with cycle interval
3. Log systemd watchdog status
4. While not shutdown_event.is_set():
   - Record cycle_start time
   - Call daemon.run_cycle()
   - Track failures, log warnings
   - Stop watchdog after MAX failures (notify_degraded)
   - Notify watchdog if healthy
   - Sleep for remainder of interval (interruptible via shutdown_event.wait)
5. Log shutdown message, return 0

Update main() to call run_daemon_loop() instead of inline loop.
Keep try/except/finally structure in main() for KeyboardInterrupt and cleanup.
  </action>
  <verify>make ci passes (all tests)</verify>
  <done>Control loop extracted, main() simplified, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for daemon loop</name>
  <files>tests/test_steering_daemon.py</files>
  <action>
Add unit tests for run_daemon_loop() function:

1. Test single successful cycle (no shutdown)
2. Test shutdown_event stops loop
3. Test consecutive failure counting
4. Test watchdog disabled after MAX_CONSECUTIVE_FAILURES
5. Test watchdog notification on success
6. Test degraded notification after failures
7. Test sleep timing (cycle_interval - elapsed)

Mock:
- daemon.run_cycle() with configurable return
- shutdown_event with threading.Event (set after N cycles)
- systemd_utils functions (notify_watchdog, notify_degraded)

Use threading.Timer to set shutdown_event after test conditions met.
  </action>
  <verify>pytest tests/test_steering_daemon.py -v passes with new tests</verify>
  <done>7+ unit tests added, loop behavior verified, all tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make ci` passes (all tests including new ones)
- [ ] run_daemon_loop() function exists at module level
- [ ] main() calls run_daemon_loop() (no inline loop)
- [ ] Watchdog behavior preserved (notify on success, stop after failures)
- [ ] Shutdown handling preserved (immediate response to event)
</verification>

<success_criteria>
- Control loop extracted from main() (~38 lines)
- main() reduced to initialization + cleanup only
- All tests pass
- No behavioral changes (watchdog, shutdown identical)
</success_criteria>

<output>
After completion, create `.planning/phases/15-steeringdaemon-refactoring/15-04-SUMMARY.md`
</output>
