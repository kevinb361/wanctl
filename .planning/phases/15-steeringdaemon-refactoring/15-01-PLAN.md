---
phase: 15-steeringdaemon-refactoring
plan: 01
type: execute
---

<objective>
Extract EWMA smoothing logic from run_cycle() into dedicated method.

Purpose: Improve testability by isolating EWMA update logic (C5 protected zone) from cycle orchestration.
Output: New update_ewma_smoothing() method with unit tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 7 analysis (S1 recommendation)
@.planning/phases/07-core-algorithm-analysis/07-02-steeringdaemon-findings.md
@docs/CORE-ALGORITHM-ANALYSIS.md

# Source files
@src/wanctl/steering/daemon.py

# Phase 14 patterns (extraction approach)
@.planning/phases/14-wancontroller-refactoring/14-01-SUMMARY.md

**Tech stack available:** Python 3.12, pytest
**Established patterns:** Method extraction with tuple returns (Phase 14)
**Constraining decisions:**
- Phase 7: S1 identified as LOW risk, pure math extraction
- EWMA formula PROTECTED (C5 fix): (1-alpha)*current + alpha*new
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create update_ewma_smoothing() method</name>
  <files>src/wanctl/steering/daemon.py</files>
  <action>
Extract lines 918-933 from run_cycle() into new method:

```python
def update_ewma_smoothing(self, delta: float, queued_packets: int) -> tuple[float, float]:
    """
    Update EWMA smoothed values for RTT delta and queue depth.

    PROTECTED: Numeric stability C5 - EWMA alphas validated at config load.
    Formula: (1-alpha)*current + alpha*new. Do not modify without approval.
    See docs/CORE-ALGORITHM-ANALYSIS.md.

    Args:
        delta: Current RTT delta (current_rtt - baseline_rtt)
        queued_packets: Current CAKE queue depth in packets

    Returns:
        tuple[float, float]: (rtt_delta_ewma, queue_ewma) updated values
    """
```

Method should:
1. Get current EWMA values from state_mgr.state
2. Call ewma_update() for both RTT delta and queue depth
3. Update state with new values
4. Return the new EWMA values

Update run_cycle() to call this method instead of inline EWMA logic.
Preserve the PROTECTED comment marking in run_cycle() where the call is made.
  </action>
  <verify>make ci passes (all 528 tests)</verify>
  <done>EWMA logic extracted, run_cycle() calls update_ewma_smoothing(), tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for EWMA smoothing</name>
  <files>tests/test_steering_daemon.py</files>
  <action>
Add unit tests for update_ewma_smoothing() method:

1. Test normal EWMA update (verify formula applied correctly)
2. Test with zero delta (EWMA should decay toward zero)
3. Test with zero queued_packets (queue EWMA should decay)
4. Test state persistence (state_mgr.state updated with new values)
5. Test return values match state values

Use minimal mocking - only mock state_mgr with dict-based state.
Follow existing test patterns in tests/test_steering_daemon.py.
  </action>
  <verify>pytest tests/test_steering_daemon.py -v passes with new tests</verify>
  <done>5+ unit tests added, all tests pass, EWMA behavior verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make ci` passes (all tests including new ones)
- [ ] update_ewma_smoothing() method exists with PROTECTED comment
- [ ] run_cycle() calls the new method (no inline EWMA logic)
- [ ] New tests cover normal and edge cases
</verification>

<success_criteria>
- EWMA logic extracted from run_cycle() (~15 lines removed)
- New method has PROTECTED zone comment referencing CORE-ALGORITHM-ANALYSIS.md
- All 528+ tests pass
- No behavioral changes (EWMA formula preserved exactly)
</success_criteria>

<output>
After completion, create `.planning/phases/15-steeringdaemon-refactoring/15-01-SUMMARY.md`
</output>
