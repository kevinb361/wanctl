---
phase: 15-steeringdaemon-refactoring
plan: 02
type: execute
---

<objective>
Extract CAKE stats collection logic from run_cycle() into dedicated method.

Purpose: Isolate CAKE stats reading, history management, and failure tracking (W8 fix) for independent testing.
Output: New collect_cake_stats() method with unit tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 7 analysis (S2 recommendation)
@.planning/phases/07-core-algorithm-analysis/07-02-steeringdaemon-findings.md
@docs/CORE-ALGORITHM-ANALYSIS.md

# Source files
@src/wanctl/steering/daemon.py

# Phase 14 patterns
@.planning/phases/14-wancontroller-refactoring/14-02-SUMMARY.md

**Tech stack available:** Python 3.12, pytest
**Established patterns:** Extraction with tuple returns, W8 failure tracking
**Constraining decisions:**
- Phase 7: S2 identified as LOW risk
- W8 fix must be preserved (consecutive failure tracking)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collect_cake_stats() method</name>
  <files>src/wanctl/steering/daemon.py</files>
  <action>
Extract lines 872-906 from run_cycle() into new method:

```python
def collect_cake_stats(self) -> tuple[int, int]:
    """
    Collect CAKE statistics (drops and queued packets).

    Handles CAKE-aware mode check, stats reading, history updates,
    and consecutive failure tracking (W8 fix).

    Returns:
        tuple[int, int]: (cake_drops, queued_packets)
        Returns (0, 0) if CAKE-aware disabled or read fails
    """
```

Method should:
1. Return (0, 0) early if not cake_aware or no cake_reader
2. Read stats from cake_reader
3. On success: reset failure counter, append to history deques
4. On failure: increment failure counter, log warning/error based on count (W8 fix)
5. Return (drops, packets) or (0, 0)

Update run_cycle() to call: `cake_drops, queued_packets = self.collect_cake_stats()`

Preserve all W8 fix logging behavior exactly.
  </action>
  <verify>make ci passes (all tests)</verify>
  <done>CAKE stats logic extracted, W8 failure tracking preserved, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for CAKE stats collection</name>
  <files>tests/test_steering_daemon.py</files>
  <action>
Add unit tests for collect_cake_stats() method:

1. Test CAKE-aware disabled returns (0, 0)
2. Test successful CAKE read returns correct values
3. Test successful read resets failure counter
4. Test history deques updated on success
5. Test first failure logs warning (W8)
6. Test third failure logs error and enters degraded mode (W8)
7. Test failure returns (0, 0)

Mock cake_reader with configurable return values.
Verify logging calls for W8 fix behavior.
  </action>
  <verify>pytest tests/test_steering_daemon.py -v passes with new tests</verify>
  <done>7+ unit tests added, W8 fix behavior verified, all tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make ci` passes (all tests including new ones)
- [ ] collect_cake_stats() method exists with proper docstring
- [ ] run_cycle() calls the new method (no inline CAKE logic)
- [ ] W8 fix preserved (failure counter + conditional logging)
- [ ] New tests verify W8 behavior
</verification>

<success_criteria>
- CAKE stats logic extracted from run_cycle() (~35 lines removed)
- W8 consecutive failure tracking preserved exactly
- All tests pass
- No behavioral changes
</success_criteria>

<output>
After completion, create `.planning/phases/15-steeringdaemon-refactoring/15-02-SUMMARY.md`
</output>
