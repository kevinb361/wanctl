---
phase: 38-storage-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wanctl/storage/__init__.py
  - src/wanctl/storage/schema.py
  - src/wanctl/storage/writer.py
  - tests/test_storage_schema.py
  - tests/test_storage_writer.py
autonomous: true

must_haves:
  truths:
    - "SQLite database created at /var/lib/wanctl/metrics.db on first write"
    - "Metrics schema uses Prometheus-compatible naming (wanctl_rtt_ms, etc.)"
    - "MetricsWriter is thread-safe singleton"
    - "WAL mode enabled for concurrent read/write"
  artifacts:
    - path: "src/wanctl/storage/__init__.py"
      provides: "Module exports"
      exports: ["MetricsWriter", "METRICS_SCHEMA"]
    - path: "src/wanctl/storage/schema.py"
      provides: "Schema constants and table creation"
      contains: "CREATE TABLE IF NOT EXISTS metrics"
    - path: "src/wanctl/storage/writer.py"
      provides: "Thread-safe MetricsWriter singleton"
      exports: ["MetricsWriter"]
    - path: "tests/test_storage_writer.py"
      provides: "Writer tests"
      min_lines: 100
  key_links:
    - from: "src/wanctl/storage/writer.py"
      to: "src/wanctl/storage/schema.py"
      via: "import METRICS_SCHEMA"
      pattern: "from.*schema.*import"
---

<objective>
Create the storage module with SQLite schema and MetricsWriter for persisting time-series metrics.

Purpose: Establish the foundation for metrics history storage that Phase 39 will use to record daemon metrics.
Output: New storage module with schema, thread-safe writer singleton, and comprehensive tests.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.7-ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/38-storage-foundation/38-RESEARCH.md
@src/wanctl/metrics.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage module with schema</name>
  <files>
    src/wanctl/storage/__init__.py
    src/wanctl/storage/schema.py
    tests/test_storage_schema.py
  </files>
  <action>
Create the storage module directory and files:

1. `src/wanctl/storage/__init__.py`:
   - Export MetricsWriter, METRICS_SCHEMA, STORED_METRICS
   - Standard module docstring

2. `src/wanctl/storage/schema.py`:
   - METRICS_SCHEMA constant with CREATE TABLE statement
   - Table: metrics(id, timestamp INTEGER, wan_name TEXT, metric_name TEXT, value REAL, labels TEXT, granularity TEXT DEFAULT 'raw')
   - Indexes: idx_metrics_timestamp, idx_metrics_wan_metric_time, idx_metrics_granularity_time
   - STORED_METRICS dict mapping Prometheus-compatible names to descriptions (wanctl_rtt_ms, wanctl_rtt_baseline_ms, wanctl_rtt_delta_ms, wanctl_rate_download_mbps, wanctl_rate_upload_mbps, wanctl_state, wanctl_steering_enabled)
   - create_tables(conn) function to execute schema

3. `tests/test_storage_schema.py`:
   - Test create_tables creates all tables
   - Test indexes exist
   - Test STORED_METRICS has expected keys
   - Use in-memory SQLite (:memory:) for tests
  </action>
  <verify>.venv/bin/pytest tests/test_storage_schema.py -v</verify>
  <done>Schema module exists with Prometheus-compatible metric names, create_tables works, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Implement MetricsWriter singleton</name>
  <files>
    src/wanctl/storage/writer.py
    tests/test_storage_writer.py
  </files>
  <action>
Implement the thread-safe MetricsWriter singleton:

1. `src/wanctl/storage/writer.py`:
   - MetricsWriter class with singleton pattern using __new__ and class lock
   - Default db_path: Path("/var/lib/wanctl/metrics.db")
   - _get_connection() method that:
     * Creates parent directory if needed
     * Connects with timeout=30.0, check_same_thread=False, autocommit=False
     * Enables PRAGMA journal_mode=WAL
     * Enables PRAGMA synchronous=NORMAL
     * Sets row_factory=sqlite3.Row
     * Calls create_tables on first connection
   - write_metric(timestamp, wan_name, metric_name, value, labels=None) method
     * Uses internal write lock for thread safety
     * Inserts single metric row
   - write_metrics_batch(metrics: list[tuple]) method
     * Efficient batch insert using executemany
   - close() method to close connection
   - Context manager support (__enter__, __exit__)

2. `tests/test_storage_writer.py`:
   - Test singleton pattern (same instance returned)
   - Test write_metric inserts data
   - Test write_metrics_batch inserts multiple rows
   - Test WAL mode is enabled (query PRAGMA journal_mode)
   - Test thread safety with concurrent writes (use ThreadPoolExecutor)
   - Test context manager usage
   - Use tmp_path fixture for test database (not :memory: to test file creation)
   - Reset singleton between tests (add _reset_instance classmethod for testing)

Important: Add _reset_instance() classmethod for test isolation. Pattern from existing test fixtures.
  </action>
  <verify>.venv/bin/pytest tests/test_storage_writer.py -v</verify>
  <done>MetricsWriter singleton works, thread-safe, WAL enabled, tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Verify full integration and update exports</name>
  <files>
    src/wanctl/storage/__init__.py
  </files>
  <action>
1. Update `src/wanctl/storage/__init__.py` with complete exports:
   - from .schema import METRICS_SCHEMA, STORED_METRICS, create_tables
   - from .writer import MetricsWriter
   - __all__ = ["MetricsWriter", "METRICS_SCHEMA", "STORED_METRICS", "create_tables"]

2. Run full test suite for storage module

3. Run mypy on storage module to verify type hints
  </action>
  <verify>
.venv/bin/pytest tests/test_storage_*.py -v
.venv/bin/mypy src/wanctl/storage/
  </verify>
  <done>Storage module complete with schema and writer, all tests pass, types verified</done>
</task>

</tasks>

<verification>
- [ ] `src/wanctl/storage/` directory exists with __init__.py, schema.py, writer.py
- [ ] METRICS_SCHEMA defines table with timestamp, wan_name, metric_name, value, labels, granularity
- [ ] STORED_METRICS contains Prometheus-compatible names (wanctl_rtt_ms, etc.)
- [ ] MetricsWriter is singleton, thread-safe, uses WAL mode
- [ ] All tests pass: .venv/bin/pytest tests/test_storage_*.py -v
- [ ] Types verified: .venv/bin/mypy src/wanctl/storage/
</verification>

<success_criteria>
- Storage module created with schema and writer
- Prometheus-compatible metric naming (DATA-05)
- SQLite database can be created and written to (STOR-01 partial)
- Thread-safe singleton pattern for concurrent daemon access
- Test coverage >90% for new module
</success_criteria>

<output>
After completion, create `.planning/phases/38-storage-foundation/38-01-SUMMARY.md`
</output>
