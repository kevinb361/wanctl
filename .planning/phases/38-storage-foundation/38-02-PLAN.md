---
phase: 38-storage-foundation
plan: 02
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - src/wanctl/storage/downsampler.py
  - src/wanctl/storage/retention.py
  - src/wanctl/storage/__init__.py
  - src/wanctl/config_base.py
  - tests/test_storage_downsampler.py
  - tests/test_storage_retention.py
autonomous: true

must_haves:
  truths:
    - "Retention period configurable in config.yaml with 7-day default"
    - "Old data automatically cleaned on daemon startup"
    - "Downsampling reduces granularity as data ages (1s -> 1m -> 5m -> 1h)"
    - "Cleanup and downsampling use batch processing to avoid blocking"
  artifacts:
    - path: "src/wanctl/storage/downsampler.py"
      provides: "Downsampling logic"
      exports: ["downsample_metrics"]
    - path: "src/wanctl/storage/retention.py"
      provides: "Retention cleanup"
      exports: ["cleanup_old_metrics"]
    - path: "src/wanctl/config_base.py"
      provides: "Config with storage.retention_days"
      contains: "retention_days"
  key_links:
    - from: "src/wanctl/storage/retention.py"
      to: "sqlite3"
      via: "batch DELETE"
      pattern: "DELETE FROM metrics"
    - from: "src/wanctl/storage/downsampler.py"
      to: "sqlite3"
      via: "aggregation INSERT"
      pattern: "INSERT INTO metrics.*SELECT.*AVG"
---

<objective>
Implement downsampling and retention logic for metrics storage, with config integration.

Purpose: Complete the storage foundation by adding data lifecycle management that keeps the database size bounded and provides appropriate granularity at different time ranges.
Output: Downsampler and retention modules with config integration and comprehensive tests.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.7-ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/38-storage-foundation/38-RESEARCH.md
@.planning/phases/38-storage-foundation/38-01-SUMMARY.md
@src/wanctl/config_base.py
@src/wanctl/storage/schema.py
@src/wanctl/storage/writer.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement retention cleanup</name>
  <files>
    src/wanctl/storage/retention.py
    tests/test_storage_retention.py
  </files>
  <action>
Implement retention cleanup with batch processing:

1. `src/wanctl/storage/retention.py`:
   - DEFAULT_RETENTION_DAYS = 7
   - BATCH_SIZE = 10000 (rows per transaction to avoid long locks)
   - cleanup_old_metrics(conn, retention_days=7, batch_size=10000) -> int
     * Calculate cutoff timestamp: int(time.time()) - (retention_days * 86400)
     * Loop deleting in batches using subquery with LIMIT
     * Return total rows deleted
     * Use with conn: for auto-commit/rollback
   - vacuum_if_needed(conn, deleted_rows, threshold=100000) -> bool
     * Run VACUUM if deleted_rows exceeds threshold
     * Return whether vacuum was run

2. `tests/test_storage_retention.py`:
   - Test cleanup_old_metrics deletes old data
   - Test cleanup_old_metrics preserves recent data
   - Test batch processing (insert >BATCH_SIZE rows, verify multiple batches)
   - Test vacuum_if_needed triggers above threshold
   - Use tmp_path fixture and real database file
   - Insert test data with timestamps in past (time.time() - days * 86400)
  </action>
  <verify>.venv/bin/pytest tests/test_storage_retention.py -v</verify>
  <done>Retention cleanup works with batch processing, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Implement downsampling logic</name>
  <files>
    src/wanctl/storage/downsampler.py
    tests/test_storage_downsampler.py
  </files>
  <action>
Implement downsampling with configurable thresholds:

1. `src/wanctl/storage/downsampler.py`:
   - DOWNSAMPLE_THRESHOLDS constant:
     * raw -> 1m: after 1 hour (3600 seconds)
     * 1m -> 5m: after 1 day (86400 seconds)
     * 5m -> 1h: after 7 days (604800 seconds)
   - Aggregation functions by metric type:
     * RTT metrics (wanctl_rtt_*): AVG
     * Rate metrics (wanctl_rate_*): AVG
     * State metrics (wanctl_state): MODE (most common value)
     * Boolean metrics (wanctl_steering_enabled): MODE
   - downsample_to_granularity(conn, from_granularity, to_granularity, bucket_seconds, cutoff) -> int
     * INSERT aggregated data with new granularity
     * DELETE original data that was aggregated
     * Return rows created
   - downsample_metrics(conn) -> dict[str, int]
     * Run all applicable downsampling based on current time
     * Return dict of {"raw->1m": N, "1m->5m": M, "5m->1h": O}

2. `tests/test_storage_downsampler.py`:
   - Test raw->1m downsampling (60 raw rows -> 1 minute bucket)
   - Test 1m->5m downsampling
   - Test 5m->1h downsampling
   - Test aggregation is AVG for RTT metrics
   - Test data older than threshold is downsampled
   - Test data newer than threshold is preserved
   - Use tmp_path fixture with test data at various ages
  </action>
  <verify>.venv/bin/pytest tests/test_storage_downsampler.py -v</verify>
  <done>Downsampling works for all granularity levels, tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Add config integration and update exports</name>
  <files>
    src/wanctl/config_base.py
    src/wanctl/storage/__init__.py
  </files>
  <action>
1. Add storage config to `src/wanctl/config_base.py`:
   - Add to config schema (look for existing validate_field patterns):
     * storage.retention_days: int, optional, default=7, min=1, max=365
     * storage.db_path: str, optional, default="/var/lib/wanctl/metrics.db"
   - Add validation in appropriate function (likely validate_config or similar)
   - Follow existing patterns for optional fields with defaults

2. Update `src/wanctl/storage/__init__.py`:
   - Add exports for retention and downsampler:
     * from .retention import cleanup_old_metrics, vacuum_if_needed, DEFAULT_RETENTION_DAYS
     * from .downsampler import downsample_metrics, DOWNSAMPLE_THRESHOLDS
   - Update __all__

3. Run full test suite to verify no regressions:
   - .venv/bin/pytest tests/test_storage_*.py -v
   - .venv/bin/pytest tests/test_config*.py -v (to verify config changes work)
  </action>
  <verify>
.venv/bin/pytest tests/test_storage_*.py tests/test_config*.py -v
.venv/bin/mypy src/wanctl/storage/ src/wanctl/config_base.py
  </verify>
  <done>Config integration complete, all exports updated, full test suite passes</done>
</task>

</tasks>

<verification>
- [ ] cleanup_old_metrics deletes data older than retention_days
- [ ] Cleanup uses batch processing (10000 rows per transaction)
- [ ] Downsampling converts raw->1m->5m->1h at correct thresholds
- [ ] storage.retention_days configurable in config.yaml (default 7)
- [ ] storage.db_path configurable in config.yaml
- [ ] All tests pass: .venv/bin/pytest tests/test_storage_*.py -v
- [ ] Types verified: .venv/bin/mypy src/wanctl/storage/
</verification>

<success_criteria>
- STOR-02: Configurable retention period (default 7 days)
- STOR-03: Automatic downsampling (1s -> 1m -> 5m -> 1h)
- STOR-04: Cleanup of expired data (ready for daemon startup hook)
- Batch processing prevents blocking daemon cycles
- Test coverage >90% for new modules
</success_criteria>

<output>
After completion, create `.planning/phases/38-storage-foundation/38-02-SUMMARY.md`
</output>
