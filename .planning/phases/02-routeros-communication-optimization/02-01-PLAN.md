---
phase: 02-interval-optimization
plan: 01
type: execute
---

<objective>
Test 250ms cycle interval for improved congestion response while maintaining stability.

Purpose: Validate 2x faster response (500ms → 250ms) maintains stability before pushing to more aggressive intervals. This is the first step toward 50-100ms target.
Output: 250ms interval deployed, stability validated over 24-48h, findings documented for next interval reduction.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/FASTER_RESPONSE_INTERVAL.md
@src/wanctl/autorate_continuous.py
@configs/spectrum.yaml
@configs/att.yaml
@configs/steering_config_v2.yaml

**Current state (from Phase 1):**
- Cycle execution: 30-41ms
- Cycle interval: 500ms
- Congestion detection: 8 samples × 500ms = 4 seconds (was 4s at 2s interval)
- Recovery: 60 samples × 500ms = 30 seconds
- CPU utilization: ~10%

**Target for 250ms:**
- Congestion detection: 16 samples × 250ms = 4 seconds (preserve time constant)
- Recovery: 120 samples × 250ms = 30 seconds (preserve time constant)
- Expected CPU: ~20% (2x polling rate)

**Mathematical principle (from FASTER_RESPONSE_INTERVAL.md):**
When interval decreases Nx, alpha decreases ~Nx to preserve wall-clock time constants.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Calculate and apply 250ms interval parameters</name>
  <files>src/wanctl/autorate_continuous.py, configs/spectrum.yaml, configs/att.yaml, configs/steering_config_v2.yaml</files>
  <action>
Update cycle interval and all dependent parameters for 250ms operation:

1. **Autorate interval:** CYCLE_INTERVAL_SECONDS = 0.25 (from 0.5)

2. **EWMA alphas (preserve time constants via 2x reduction):**
   - Spectrum: alpha_baseline: 0.0025 (from 0.005), alpha_load: 0.025 (from 0.05)
   - ATT: alpha_baseline: 0.001875 (from 0.00375), alpha_load: 0.025 (from 0.05)

3. **Steering thresholds (preserve time-based intent via 2x sample counts):**
   - interval_seconds: 0.25 (from 0.5)
   - red_samples_required: 16 (from 8) - maintains 4 second activation
   - green_samples_required: 120 (from 60) - maintains 30 second recovery
   - history_size: 480 (from 240) - maintains 2 minute history window

4. **Steering daemon MAX_HISTORY_SAMPLES:** 480 (from 240) in src/wanctl/steering/daemon.py

**Mathematical verification:**
- Baseline smoothing: 400 samples × 0.25s = 100 seconds (preserved)
- Load smoothing: 40 samples × 0.25s = 10 seconds (preserved)
- RED activation: 16 × 0.25s = 4 seconds (preserved)
- GREEN recovery: 120 × 0.25s = 30 seconds (preserved)

**What to avoid:** Do NOT change sustain_duration_sec or recovery_sustain_sec in steering config - these are already in wall-clock seconds and auto-adjust.
  </action>
  <verify>
1. `python3 -m py_compile src/wanctl/autorate_continuous.py` passes
2. `python3 -m py_compile src/wanctl/steering/daemon.py` passes
3. Config files are valid YAML (no syntax errors)
4. All alpha values are < 1.0
5. All sample counts are integers
  </verify>
  <done>
- Interval set to 0.25 in autorate
- EWMA alphas reduced by 2x (time constants preserved)
- Steering thresholds doubled (time-based intent preserved)
- History sizes doubled (2-min window preserved)
- All files compile without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy 250ms configuration to production</name>
  <files>Deployment via systemd</files>
  <action>
Deploy updated configuration to production containers:

1. Copy updated files to /etc/wanctl/ on both containers:
   - spectrum.yaml → cake-spectrum:/etc/wanctl/
   - att.yaml → cake-att:/etc/wanctl/
   - steering_config_v2.yaml → cake-spectrum:/etc/wanctl/

2. Copy updated Python files to /opt/wanctl/ on both containers:
   - autorate_continuous.py → both containers
   - steering/daemon.py → cake-spectrum

3. Restart services to apply changes:
   - `ssh cake-spectrum 'sudo systemctl restart wanctl@spectrum wanctl-steering'`
   - `ssh cake-att 'sudo systemctl restart wanctl@att'`

4. Verify services started successfully:
   - `ssh cake-spectrum 'systemctl status wanctl@spectrum wanctl-steering'`
   - `ssh cake-att 'systemctl status wanctl@att'`

**What to avoid:** Do NOT use systemctl --no-reload. We need full reload to pick up parameter changes.
  </action>
  <verify>
1. `systemctl status` shows active (running) for all services
2. No errors in `journalctl -u wanctl@spectrum -n 20`
3. No errors in `journalctl -u wanctl@att -n 20`
4. No errors in `journalctl -u wanctl-steering -n 20`
5. Log entries show 250ms cycle timing (look for cycle completion messages)
  </verify>
  <done>
- All services restarted successfully
- No startup errors in logs
- Cycle timing reflects 250ms interval
- Both autorate and steering daemons operational
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>250ms cycle interval deployed to production</what-built>
  <how-to-verify>
Monitor for 24-48 hours and check stability metrics:

1. **Baseline RTT stability (CRITICAL):**
   - `ssh cake-spectrum 'journalctl -u wanctl@spectrum --since "24 hours ago" | grep baseline'`
   - Confirm: baseline_rtt should NOT drift >5ms during load
   - Look for: "Baseline frozen" messages during congestion (delta <3ms)

2. **No oscillation (flapping):**
   - `ssh cake-spectrum 'journalctl -u wanctl@spectrum --since "24 hours ago" | grep -E "(download_rate|upload_rate)" | tail -50'`
   - Confirm: No rapid up/down cycles in queue limits
   - Pattern to avoid: Multiple rate changes within 1-2 minutes

3. **Router CPU load:**
   - `ssh 10.10.99.1` (or use REST API)
   - Check `/system resource print` - CPU should be <30%
   - Verify: 4x polling rate (250ms vs 1000ms original) is sustainable

4. **State transitions working correctly:**
   - `ssh cake-spectrum 'journalctl -u wanctl-steering --since "24 hours ago" | grep -E "(GREEN|YELLOW|RED)"'`
   - Confirm: Transitions follow 16-sample RED, 120-sample GREEN patterns
   - Timing: RED activation ~4s after congestion, recovery ~30s after improvement

5. **No measurement noise triggering false alarms:**
   - Review logs for spurious congestion detections
   - Small RTT variance should not cause state changes

6. **Overall system health:**
   - Run: `./scripts/soak-monitor.sh`
   - No error count increases
   - Services remain stable
  </how-to-verify>
  <resume-signal>
Type one of:
- "approved" - 250ms stable, ready for 100ms test
- "issues: [description]" - stability concerns found, need adjustment
- "rollback" - unstable, revert to 500ms
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document 250ms findings</name>
  <files>docs/INTERVAL_TESTING_250MS.md</files>
  <action>
Create analysis document capturing 250ms test results:

**Structure:**
1. **Test Parameters:** Interval, alpha values, thresholds, test duration
2. **Stability Results:**
   - Baseline RTT drift: [measurements]
   - Oscillation incidents: [count, details]
   - Router CPU impact: [before/after]
   - False positives: [count, details]
3. **Performance Impact:**
   - Congestion detection time: [actual vs expected 4s]
   - Recovery time: [actual vs expected 30s]
   - Comparison to 500ms baseline
4. **Key Observations:** Any unexpected behavior, edge cases discovered
5. **Recommendation:** Proceed to 100ms or finalize at 250ms?

Include specific log excerpts demonstrating stability or issues.

**What to avoid:** Don't speculate - use actual measured data from the 24-48h test period.
  </action>
  <verify>
1. Document exists at docs/INTERVAL_TESTING_250MS.md
2. Contains all 5 sections with actual data
3. Includes log excerpts as evidence
4. Has clear recommendation for next step
  </verify>
  <done>
- Test results documented with actual measurements
- Evidence from logs included
- Clear recommendation provided
- Ready for decision on 100ms testing
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] 250ms parameters calculated correctly (time constants preserved)
- [ ] Configuration deployed to both WANs
- [ ] 24-48h stability monitoring completed
- [ ] No baseline drift >5ms under load
- [ ] No oscillation/flapping observed
- [ ] Router CPU <30%
- [ ] Findings documented in INTERVAL_TESTING_250MS.md
</verification>

<success_criteria>
- 250ms interval operational in production
- Stability validated over 24-48 hours
- Baseline RTT remains stable (no drift >5ms)
- No oscillation or flapping
- Router CPU impact acceptable (<30%)
- Documentation complete with recommendation for 100ms testing
</success_criteria>

<output>
After completion, create `.planning/phases/02-interval-optimization/02-01-SUMMARY.md`:

# Phase 2 Plan 1: 250ms Interval Testing Summary

**250ms interval tested and validated, [X]x faster congestion response achieved**

## Accomplishments

- Calculated 250ms parameters with preserved time constants
- Deployed to production (Spectrum + ATT WANs)
- Validated stability over [duration]
- Documented findings in INTERVAL_TESTING_250MS.md

## Files Created/Modified

- `src/wanctl/autorate_continuous.py` - CYCLE_INTERVAL_SECONDS = 0.25
- `configs/spectrum.yaml` - EWMA alphas reduced 2x
- `configs/att.yaml` - EWMA alphas reduced 2x
- `configs/steering_config_v2.yaml` - Thresholds and history doubled
- `src/wanctl/steering/daemon.py` - MAX_HISTORY_SAMPLES = 480
- `docs/INTERVAL_TESTING_250MS.md` - Test results and analysis

## Decisions Made

- [Approved/Rollback]: 250ms stability [passed/failed]
- Next step: [Proceed to 100ms / Finalize at 250ms / Revert to 500ms]

## Issues Encountered

[Stability issues found, or "None - 250ms stable"]

## Next Step

[If stable: "Ready for 02-02-PLAN.md (100ms interval test)"]
[If unstable: "Adjust parameters or revert to 500ms"]
</output>
