---
phase: 12-routerosrest-refactoring
plan: 02
type: execute
---

<objective>
Consolidate ID lookup methods in RouterOSREST to reduce code duplication.

Purpose: DRY up nearly identical `_find_queue_id` and `_find_mangle_rule_id` methods.
Output: Generic ID lookup method, simplified specific lookup methods.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source file being refactored:
@src/wanctl/routeros_rest.py

# Prior plan in this phase:
@.planning/phases/12-routerosrest-refactoring/12-01-SUMMARY.md

**Established patterns:**
- Parser extraction: separate format-specific parsing from orchestration
- Helper methods: focused single-purpose functions
- Generic methods: parameterized behavior over copy-paste

**Constraining decisions:**
- Phase 11: Established helper extraction pattern
- Plan 12-01: Established parsing helpers pattern for this class
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generic resource ID lookup method</name>
  <files>src/wanctl/routeros_rest.py</files>
  <action>
  Create `_find_resource_id()` method that generalizes the ID lookup pattern:

  ```python
  def _find_resource_id(
      self,
      endpoint: str,
      filter_key: str,
      filter_value: str,
      cache: Dict[str, str],
      use_cache: bool = True,
      timeout: Optional[int] = None
  ) -> Optional[str]:
      """Find RouterOS resource ID by filter key/value.

      Generic method for looking up resource IDs with caching support.
      Used by queue and mangle rule lookups.

      Args:
          endpoint: REST API endpoint (e.g., "queue/tree", "ip/firewall/mangle")
          filter_key: Filter parameter name (e.g., "name", "comment")
          filter_value: Value to filter by
          cache: Cache dict to use for this resource type
          use_cache: Whether to check/update cache (default True)
          timeout: Request timeout in seconds

      Returns:
          Resource ID (e.g., "*1") or None if not found
      """
  ```

  Implementation should:
  1. Check cache first if use_cache=True
  2. Make GET request to endpoint with filter params
  3. Extract .id from first result
  4. Cache result if found and use_cache=True
  5. Return ID or None
  6. Handle RequestException with logging

  Place after existing `_handle_*` methods, before `_find_queue_id`.
  </action>
  <verify>uv run ruff check src/wanctl/routeros_rest.py && uv run python -c "from wanctl.routeros_rest import RouterOSREST; print('Import OK')"</verify>
  <done>Generic `_find_resource_id()` method created with full docstring</done>
</task>

<task type="auto">
  <name>Task 2: Refactor specific ID lookup methods</name>
  <files>src/wanctl/routeros_rest.py</files>
  <action>
  Refactor `_find_queue_id` and `_find_mangle_rule_id` to use `_find_resource_id`:

  1. `_find_queue_id` (line ~455) - Simplify to:
     ```python
     def _find_queue_id(self, queue_name: str, use_cache: bool = True, timeout: Optional[int] = None) -> Optional[str]:
         """Find queue tree ID by name.

         Args:
             queue_name: Name of the queue
             use_cache: Whether to use cached ID (default True)
             timeout: Request timeout in seconds

         Returns:
             Queue ID (e.g., "*1") or None if not found
         """
         return self._find_resource_id(
             endpoint="queue/tree",
             filter_key="name",
             filter_value=queue_name,
             cache=self._queue_id_cache,
             use_cache=use_cache,
             timeout=timeout
         )
     ```

  2. `_find_mangle_rule_id` (line ~498) - Simplify to:
     ```python
     def _find_mangle_rule_id(self, comment: str, use_cache: bool = True, timeout: Optional[int] = None) -> Optional[str]:
         """Find mangle rule ID by comment.

         Args:
             comment: Comment of the rule
             use_cache: Whether to use cached ID (default True)
             timeout: Request timeout in seconds

         Returns:
             Rule ID or None if not found
         """
         return self._find_resource_id(
             endpoint="ip/firewall/mangle",
             filter_key="comment",
             filter_value=comment,
             cache=self._mangle_id_cache,
             use_cache=use_cache,
             timeout=timeout
         )
     ```

  Preserve existing public API and behavior. The specific methods remain as thin wrappers for backwards compatibility and clear semantics.
  </action>
  <verify>uv run pytest tests/ -x -q && uv run ruff check src/wanctl/routeros_rest.py</verify>
  <done>Both ID lookup methods simplified to use generic method, 474 tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `uv run ruff check src/wanctl/routeros_rest.py` passes
- [ ] `uv run pytest tests/ -x -q` shows 474 tests pass
- [ ] `_find_resource_id()` is generic and reusable
- [ ] `_find_queue_id` and `_find_mangle_rule_id` are thin wrappers
- [ ] Cache behavior preserved (queue and mangle caches still work)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No behavioral changes (pure refactoring)
- ~60 lines of duplicate code eliminated
- Phase 12 complete
</success_criteria>

<output>
After completion, create `.planning/phases/12-routerosrest-refactoring/12-02-SUMMARY.md`
</output>
