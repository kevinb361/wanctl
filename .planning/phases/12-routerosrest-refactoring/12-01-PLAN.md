---
phase: 12-routerosrest-refactoring
plan: 01
type: execute
---

<objective>
Extract command parsing helpers from RouterOSREST to reduce code duplication.

Purpose: DRY up repeated regex parsing patterns across command handlers.
Output: New parsing helper methods, cleaner handler code.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source file being refactored:
@src/wanctl/routeros_rest.py

# Prior refactoring patterns:
@.planning/phases/11-refactor-long-functions/11-03-SUMMARY.md

**Established patterns:**
- Parser extraction: separate format-specific parsing from orchestration
- Helper methods: focused single-purpose functions
- Orchestrator pattern: main method calls helpers

**Constraining decisions:**
- Phase 11: Established helper extraction pattern for parsing logic
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create parsing helper methods</name>
  <files>src/wanctl/routeros_rest.py</files>
  <action>
  1. Move `import re` from inside methods (lines 262, 325, 375, 411) to module-level imports at top of file
  2. Create `_parse_find_name(cmd: str) -> Optional[str]` helper:
     - Extract queue name from `[find name="..."]` pattern
     - Return None if pattern not found
     - Include docstring explaining purpose
  3. Create `_parse_find_comment(cmd: str) -> Optional[str]` helper:
     - Extract comment from `[find comment="..."]` pattern
     - Return None if pattern not found
     - Include docstring explaining purpose
  4. Create `_parse_parameters(cmd: str) -> Dict[str, str]` helper:
     - Extract key=value pairs (queue=, max-limit=) from command
     - Return dict of parameter name -> value
     - Include docstring explaining purpose

  Place helpers after `_execute_single_command` method (around line 248) to keep parsing logic grouped.
  </action>
  <verify>uv run ruff check src/wanctl/routeros_rest.py && uv run python -c "from wanctl.routeros_rest import RouterOSREST; print('Import OK')"</verify>
  <done>Three parsing helpers created, module-level import re, no syntax errors</done>
</task>

<task type="auto">
  <name>Task 2: Update handlers to use parsing helpers</name>
  <files>src/wanctl/routeros_rest.py</files>
  <action>
  Update these methods to use the new parsing helpers:

  1. `_handle_queue_tree_set` (line ~250):
     - Replace inline regex for name extraction with `_parse_find_name(cmd)`
     - Replace inline regex for parameters with `_parse_parameters(cmd)`
     - Remove `import re` (now at module level)

  2. `_handle_queue_reset_counters` (line ~312):
     - Replace inline regex for name extraction with `_parse_find_name(cmd)`
     - Handle fallback to alternative format if needed
     - Remove `import re`

  3. `_handle_queue_tree_print` (line ~365):
     - Replace inline regex for name extraction with existing pattern or helper
     - Remove `import re`

  4. `_handle_mangle_rule` (line ~401):
     - Replace inline regex for comment extraction with `_parse_find_comment(cmd)`
     - Remove `import re`

  Preserve all existing error handling and logging behavior.
  </action>
  <verify>uv run pytest tests/ -x -q && uv run ruff check src/wanctl/routeros_rest.py</verify>
  <done>All 4 handlers use parsing helpers, no duplicate regex patterns, 474 tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `uv run ruff check src/wanctl/routeros_rest.py` passes
- [ ] `uv run pytest tests/ -x -q` shows 474 tests pass
- [ ] No `import re` inside any method (only at module level)
- [ ] All 4 handlers use parsing helpers
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No behavioral changes (pure refactoring)
- Code duplication reduced
</success_criteria>

<output>
After completion, create `.planning/phases/12-routerosrest-refactoring/12-01-SUMMARY.md`
</output>
