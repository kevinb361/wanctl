# Plan 17-01: Config Documentation & Baseline Bounds

## Objective

Document undocumented EWMA and baseline RTT bounds parameters in CONFIG_SCHEMA.md, and add baseline_rtt_bounds validation to autorate for consistency with steering daemon.

## Current State

| Parameter | Steering | Autorate | Documented |
|-----------|----------|----------|------------|
| `rtt_ewma_alpha` | ✓ (default 0.3) | N/A | Partial (line 280) |
| `queue_ewma_alpha` | ✓ (default 0.4) | N/A | Partial (line 281) |
| `alpha_baseline` | N/A | ✓ (default 0.02) | ✓ (line 137) |
| `alpha_load` | N/A | ✓ (default 0.20) | ✓ (line 138) |
| `baseline_rtt_bounds` | ✓ (10-60ms) | ✗ Missing | ✗ Not documented |

## Tasks

### Task 1: Document baseline_rtt_bounds in CONFIG_SCHEMA.md

Add to the Steering `thresholds` section:

```yaml
thresholds:
  baseline_rtt_bounds:
    min: 10  # Minimum valid baseline RTT (ms)
    max: 60  # Maximum valid baseline RTT (ms)
```

Include:
- Purpose: Security bounds to reject corrupted/invalid baseline RTT values
- Default values: 10-60ms
- Rationale: Typical ISP latencies are 20-50ms; <10ms suggests LAN, >60ms suggests routing issues

### Task 2: Add baseline_rtt_bounds to autorate

**File:** `src/wanctl/autorate_continuous.py`

1. Add constants at top of file (after line ~73):
   ```python
   MIN_SANE_BASELINE_RTT = 10.0  # milliseconds
   MAX_SANE_BASELINE_RTT = 60.0  # milliseconds
   ```

2. Add config schema entry (after line ~127):
   ```python
   {"path": "continuous_monitoring.thresholds.baseline_rtt_bounds.min",
    "type": float, "required": False},
   {"path": "continuous_monitoring.thresholds.baseline_rtt_bounds.max",
    "type": float, "required": False},
   ```

3. Load bounds in AutorateConfig (around line ~218):
   ```python
   bounds = thresh.get('baseline_rtt_bounds', {})
   self.baseline_rtt_min = bounds.get('min', MIN_SANE_BASELINE_RTT)
   self.baseline_rtt_max = bounds.get('max', MAX_SANE_BASELINE_RTT)
   ```

4. Validate in `_update_baseline_if_idle()` (around line ~715):
   ```python
   if not (self.baseline_rtt_min <= new_baseline <= self.baseline_rtt_max):
       logger.warning(f"Baseline RTT {new_baseline:.1f}ms outside bounds [{self.baseline_rtt_min}-{self.baseline_rtt_max}], ignoring")
       return
   ```

### Task 3: Add unit tests for baseline bounds validation

**File:** `tests/test_autorate_baseline_bounds.py` (new)

Tests:
1. `test_baseline_bounds_default_values` - Verify defaults are 10-60ms
2. `test_baseline_bounds_custom_values` - Verify custom bounds from config
3. `test_baseline_below_min_rejected` - Baseline <10ms is rejected
4. `test_baseline_above_max_rejected` - Baseline >60ms is rejected
5. `test_baseline_within_bounds_accepted` - Valid baseline is accepted

### Task 4: Update example configs with comments

**Files:** `configs/spectrum.yaml`, `configs/steering.yaml`

Add commented examples showing the optional parameters:
```yaml
thresholds:
  # EWMA smoothing (optional, defaults shown)
  # rtt_ewma_alpha: 0.3      # RTT smoothing factor (0-1)
  # queue_ewma_alpha: 0.4    # Queue depth smoothing factor (0-1)

  # Baseline RTT security bounds (optional)
  # baseline_rtt_bounds:
  #   min: 10  # Reject baseline below 10ms (probably LAN)
  #   max: 60  # Reject baseline above 60ms (probably corrupted)
```

## Verification

```bash
.venv/bin/python -m pytest tests/test_autorate_baseline_bounds.py -v
.venv/bin/python -m pytest tests/ -v  # Full suite
```

## Success Criteria

- CONFIG_SCHEMA.md documents all EWMA and bounds parameters
- autorate validates baseline RTT against configurable bounds
- New tests verify bounds validation behavior
- Example configs show optional parameters

## Risk Assessment

**LOW risk:**
- Optional config parameters with safe defaults
- No changes to existing behavior unless user explicitly configures
- Validation only logs warning and ignores bad values (no crash)

## Files Modified

1. `docs/CONFIG_SCHEMA.md` - Add baseline_rtt_bounds documentation
2. `src/wanctl/autorate_continuous.py` - Add bounds validation
3. `tests/test_autorate_baseline_bounds.py` - New test file
4. `configs/spectrum.yaml` - Add commented examples
5. `configs/steering.yaml` - Add commented examples (if exists)
