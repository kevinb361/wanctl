---
phase: 07-core-algorithm-analysis
plan: 02
type: execute
---

<objective>
Analyze steering/daemon.py structure to identify refactoring opportunities.

Purpose: Produce detailed structural analysis documenting complexity hotspots, extraction candidates, and testability issues to inform Phase 15 implementation.
Output: Interim findings document (07-02-steeringdaemon-findings.md) with risk-assessed refactoring opportunities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
@.planning/phases/06-quick-wins/06-06-SUMMARY.md
@.planning/phases/07-core-algorithm-analysis/07-01-SUMMARY.md

**Key Context:**
- steering/daemon.py: 1,179 lines, 24 functions
- CONCERNS.md explicitly flags state machine (lines ~630-680) as fragile: "Multiple state transitions (good_count, bad_count, state changes) interdependent"
- File handles dual-WAN steering with confidence-based decision making
- ARCHITECTURE.md documents steering cycle: RTT delta → confidence score → sustain timers → state machine → routing decisions
- Phase 7 produces ANALYSIS ONLY - no implementation (Phase 15 requires explicit approval)

**From Phase 6:**
- Signal handlers already at module-level (daemon.py followed pattern before Phase 6)
- Docstrings added to main() and fallback_to_history()
- Established pattern for daemon signal handling (threading.Event)

**From Plan 1:**
- WANController analysis complete
- Look for parallel patterns and shared refactoring opportunities
</context>

<tasks>

<task type="auto">
  <name>Task 1: Analyze steering daemon structure and complexity</name>
  <files>src/wanctl/steering/daemon.py</files>
  <action>
Read steering/daemon.py and perform structural analysis:

1. **Function inventory:** List all functions (24 total) with line counts, parameter counts, complexity indicators
2. **Responsibility mapping:** Document main() control loop, state machine functions, measurement functions, routing control functions
3. **State machine analysis:** Deep dive on update_state_machine (lines ~630-680 per CONCERNS.md) - map state transitions, sustain timers, hysteresis logic
4. **Confidence integration:** Analyze how steering_confidence.py integrates (or doesn't) with main daemon loop - CONCERNS.md notes confidence scoring exists but uses simpler hysteresis
5. **Data flow:** Track RTT measurement → delta calculation → confidence scoring → state machine → RouterOS mangle rule updates
6. **Coupling analysis:** Document dependencies on congestion_assessment, cake_stats, router_client, state_manager
7. **Complexity hotspots:** Flag functions > 50 lines, > 3 parameters, deep nesting, multiple return points
8. **CAKE-aware mode:** Analyze cake_stats integration and fallback behavior
9. **Protected zones:** Identify core steering algorithm logic that MUST NOT change without approval (state transitions, confidence thresholds, timing constants)

Pay special attention to CONCERNS.md flagged areas:
- State machine transitions (fragile, interdependent)
- Hysteresis logic
- Baseline RTT bounds (10-60ms hardcoded)

Document findings in structured format matching Plan 1 structure for consistency.
  </action>
  <verify>Created comprehensive function inventory with complexity metrics, state machine mapping</verify>
  <done>All steering daemon functions documented with structural metrics, responsibility mapping, and fragile areas identified</done>
</task>

<task type="auto">
  <name>Task 2: Document refactoring opportunities with risk assessment</name>
  <files>.planning/phases/07-core-algorithm-analysis/07-02-steeringdaemon-findings.md</files>
  <action>
Based on Task 1 analysis, create 07-02-steeringdaemon-findings.md documenting:

**Section 1: Overview**
- File stats (lines, functions)
- Current architecture summary
- Key responsibilities (steering control loop, state machine, confidence scoring)

**Section 2: Complexity Hotspots**
For each hotspot:
- Function name and location (prioritize update_state_machine at ~630-680)
- Current complexity (lines, nesting, responsibilities)
- Why it's complex
- Impact on maintainability/testability

**Section 3: Refactoring Opportunities**
For each opportunity:
- **Opportunity:** What could be extracted/simplified
- **Current state:** Lines of code, complexity metrics
- **Proposed improvement:** High-level approach
- **Risk level:** LOW/MEDIUM/HIGH
  - LOW: Pure extraction, no algorithm changes, easy to test
  - MEDIUM: Minor logic reorganization, preserves behavior
  - HIGH: Touches state machine, confidence scoring, timing constants, or routing decisions
- **Testability improvement:** How this helps testing
- **Dependencies:** What else needs to change

**Section 4: Confidence Scoring Integration**
Analyze steering_confidence.py vs current hysteresis implementation:
- Current state: What's used vs what exists
- Integration opportunity: Could confidence scoring replace hysteresis?
- Risk assessment: What breaks if integrated?
- Recommendation: Integrate, keep separate, or hybrid approach?

**Section 5: Protected Zones**
Document code that MUST NOT change without explicit approval:
- State transition logic (GOOD ↔ DEGRADED)
- Sustain timers (degrade, hold_down, recovery)
- Confidence thresholds
- Baseline RTT validation bounds
- RouterOS mangle rule enable/disable logic

**Section 6: Recommendations for Phase 15**
- Prioritized list of opportunities (low-risk first)
- Suggested implementation order
- Testing strategy recommendations
- Note dependencies on Phase 14 (if any shared patterns)

Use CONCERNS.md as authoritative source for known fragile areas.
Follow CONVENTIONS.md patterns for any suggested extractions.
  </action>
  <verify>grep "Risk level" 07-02-steeringdaemon-findings.md shows risk assessments, grep "Protected Zones" shows core algorithm boundaries</verify>
  <done>Comprehensive findings document created with risk-assessed refactoring opportunities, confidence integration analysis, and protected zone boundaries</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] 07-02-steeringdaemon-findings.md exists
- [ ] All steering daemon functions inventoried with complexity metrics
- [ ] State machine (lines ~630-680) thoroughly analyzed
- [ ] Confidence scoring integration assessed
- [ ] Each refactoring opportunity has risk level (LOW/MEDIUM/HIGH)
- [ ] Protected zones clearly documented
- [ ] Recommendations prioritized for Phase 15
</verification>

<success_criteria>

- Steering daemon structural analysis complete
- Complexity hotspots identified (especially state machine)
- Refactoring opportunities documented with risk assessment
- Confidence scoring integration evaluated
- Protected zones (core steering algorithm) clearly marked
- Findings ready for synthesis in Plan 3
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-algorithm-analysis/07-02-SUMMARY.md`:

# Phase 7 Plan 2: SteeringDaemon Analysis Summary

**[Substantive one-liner - what was analyzed, key findings on state machine and confidence scoring]**

## Accomplishments

- Analyzed steering daemon structure (X functions, Y total lines)
- Deep analysis of state machine (lines ~630-680) fragility
- Evaluated confidence scoring integration opportunity
- Identified N complexity hotspots
- Documented M refactoring opportunities with risk levels
- Defined protected zones for core steering algorithm

## Files Created/Modified

- `.planning/phases/07-core-algorithm-analysis/07-02-steeringdaemon-findings.md` - Structural analysis and recommendations

## Decisions Made

[Key analytical decisions - confidence scoring integration assessment, state machine refactoring approach, risk categorization]

## Issues Encountered

[Problems during analysis, or "None"]

## Next Step

Ready for 07-03-PLAN.md (Synthesize recommendations into CORE-ALGORITHM-ANALYSIS.md)
</output>
