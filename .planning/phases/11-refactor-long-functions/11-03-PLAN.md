---
phase: 11-refactor-long-functions
plan: 03
type: execute
---

<objective>
Split CakeStatsReader.read_stats() (121 lines) into focused parsing methods.

Purpose: Improve testability by separating JSON parsing, text parsing, and delta calculation into distinct methods.
Output: read_stats() as orchestrator calling 3 focused parser methods.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source file to refactor:
@src/wanctl/steering/cake_stats.py

**Current structure:**
read_stats() (lines 64-185) handles:
1. Queue name validation (C2 fix)
2. RouterOS command execution
3. JSON parsing (REST API format) - lines 94-126
4. Text parsing (SSH CLI format) - lines 127-154
5. Delta calculation from previous stats - lines 156-178

**Refactoring approach:**
Extract parsing logic into dedicated methods:
- _parse_json_response() - JSON/REST parsing
- _parse_text_response() - SSH text parsing
- _calculate_stats_delta() - delta from previous

read_stats() becomes orchestrator that validates, executes command, routes to parser, calculates delta.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract JSON and text parsing methods</name>
  <files>src/wanctl/steering/cake_stats.py</files>
  <action>
Extract parsing logic from read_stats() into two dedicated methods:

1. `_parse_json_response(self, out: str, queue_name: str) -> Optional[CakeStats]`
   - Lines 94-126: JSON/REST API parsing
   - Uses safe_json_loads_with_logging for parsing
   - Handles list or dict response formats
   - Validates response structure
   - Returns CakeStats with cumulative values or None on error

2. `_parse_text_response(self, out: str) -> CakeStats`
   - Lines 127-154: SSH CLI text parsing
   - Uses regex to extract: packets, bytes, dropped, queued-packets, queued-bytes
   - Returns CakeStats with parsed values (defaults to 0 if not found)

Both methods:
- Are private instance methods (prefixed with _)
- Have clear docstrings explaining format handled
- Return CakeStats or None
- Do NOT log at info level (preserve current debug-only logging)
  </action>
  <verify>python -c "from wanctl.steering.cake_stats import CakeStatsReader; print('Import OK')"</verify>
  <done>_parse_json_response() and _parse_text_response() methods created</done>
</task>

<task type="auto">
  <name>Task 2: Extract delta calculation and refactor read_stats()</name>
  <files>src/wanctl/steering/cake_stats.py</files>
  <action>
Extract delta calculation and refactor read_stats():

1. `_calculate_stats_delta(self, current: CakeStats, queue_name: str) -> CakeStats`
   - Lines 156-178: delta calculation from previous stats
   - Handles first read (returns current, stores baseline)
   - Calculates deltas for cumulative counters (packets, bytes, dropped)
   - Preserves instantaneous values (queued_packets, queued_bytes)
   - Updates self.previous_stats[queue_name]
   - Returns delta CakeStats

Refactored read_stats() becomes:
```python
def read_stats(self, queue_name: str) -> Optional[CakeStats]:
    """Read CAKE statistics for a specific queue."""
    # C2 fix: Validate queue_name
    try:
        from ..config_base import BaseConfig
        queue_name = BaseConfig.validate_identifier(queue_name, 'queue_name')
    except ConfigValidationError as e:
        self.logger.error(f"Invalid queue name: {e}")
        return None

    # Execute RouterOS command
    cmd = f'/queue/tree print stats detail where name="{queue_name}"'
    rc, out, err = self.client.run_cmd(cmd, capture=True, timeout=5)

    if rc != 0:
        self.logger.error(f"Failed to read CAKE stats for {queue_name}: {err}")
        return None

    # Parse response based on format
    try:
        if out.strip().startswith('[') or out.strip().startswith('{'):
            current = self._parse_json_response(out, queue_name)
        else:
            current = self._parse_text_response(out)

        if current is None:
            return None

        # Calculate delta from previous
        return self._calculate_stats_delta(current, queue_name)

    except Exception as e:
        self.logger.error(f"Failed to parse CAKE stats: {e}")
        self.logger.debug(f"Raw output: {out[:200]}")
        return None
```

Run full test suite to verify no behavioral changes:
- `make ci` must pass
- CAKE stats parsing behavior unchanged
  </action>
  <verify>make ci</verify>
  <done>read_stats() refactored to ~30 lines, 3 helper methods, all tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] read_stats() reduced from 121 lines to ~30 lines of orchestration
- [ ] 3 helper methods created (_parse_json_response, _parse_text_response, _calculate_stats_delta)
- [ ] `make ci` passes (all tests, type check, lint)
- [ ] CAKE stats parsing behavior unchanged for both JSON and text formats
</verification>

<success_criteria>

- read_stats() is now orchestration-only (~30 lines)
- 3 focused parsing methods with clear responsibilities
- All tests pass
- No type errors or lint warnings
- JSON (REST) and text (SSH) parsing both work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/11-refactor-long-functions/11-03-SUMMARY.md`:

# Phase 11 Plan 03: CAKE Stats Parser Refactoring Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/wanctl/steering/cake_stats.py` - Extracted 3 parser methods

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 11 complete, ready for Phase 12 (RouterOSREST Refactoring)
</output>
