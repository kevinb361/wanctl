---
phase: 08-extract-common-helpers
plan: 03
type: execute
---

<objective>
Split the 134-line _load_specific_fields() method in SteeringConfig into focused helper methods.

Purpose: Improve testability and maintainability by breaking monolithic config loading into logically-grouped helpers (S3 from Phase 7 analysis).
Output: SteeringConfig with ~12 focused helper methods, original functionality preserved.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Previous plans in this phase:
@.planning/phases/08-extract-common-helpers/08-01-SUMMARY.md
@.planning/phases/08-extract-common-helpers/08-02-SUMMARY.md

# Phase 7 recommendation (S3):
@docs/CORE-ALGORITHM-ANALYSIS.md

# Source file:
@src/wanctl/steering/daemon.py (lines 188-317: _load_specific_fields)

**Current structure (134 lines, 15 logical sections):**
- Router transport (lines 190-196)
- Topology (lines 198-206)
- State sources with legacy support (lines 208-217)
- Mangle rule (lines 219-222)
- RTT measurement (lines 224-229)
- CAKE queues with legacy support (lines 231-242)
- Operational mode (lines 244-247)
- Thresholds - legacy RTT (lines 249-256)
- Thresholds - CAKE-aware (lines 258-277)
- Baseline bounds (lines 279-282)
- State persistence (lines 284-286)
- Logging (lines 288-291)
- Lock file (lines 293-295)
- Timeouts (lines 297-301)
- Router dict assembly (lines 303-312)
- Metrics (lines 314-316)

**Constraining decisions:**
- Phase 7 S3: LOW risk refactoring, no algorithm changes
- Preserve all validation calls (validate_identifier, validate_comment, validate_ping_host, validate_alpha)
- Preserve legacy support paths (cake_state_sources.spectrum, cake_queues.spectrum_*)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract connection and topology config helpers</name>
  <files>src/wanctl/steering/daemon.py</files>
  <action>
Add helper methods to SteeringConfig class and call them from _load_specific_fields():

1. _load_router_transport(self) -> None:
   - Extract lines 190-196
   - Sets: router_transport, router_password, router_port, router_verify_ssl
   - Uses self.data['router']

2. _load_topology(self) -> None:
   - Extract lines 198-206
   - Sets: primary_wan, primary_wan_config, alternate_wan, state_good, state_degraded
   - Uses self.data.get('topology', {})

3. _load_state_sources(self) -> None:
   - Extract lines 208-217
   - Sets: primary_state_file
   - Preserves legacy support: cake_state_sources.spectrum -> primary
   - Uses self.data.get('cake_state_sources', {})

4. _load_mangle_config(self) -> None:
   - Extract lines 219-222
   - Sets: mangle_rule_comment
   - Preserves validation: self.validate_comment()

Update _load_specific_fields() to call these helpers in order.
Helpers should be private methods (underscore prefix) placed before _load_specific_fields().
Add brief docstrings to each helper.
  </action>
  <verify>cd /home/kevin/projects/wanctl && python -c "from wanctl.steering.daemon import SteeringConfig; print('Import OK')" && make test</verify>
  <done>4 helper methods extracted, _load_specific_fields calls them, all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Extract measurement and CAKE config helpers</name>
  <files>src/wanctl/steering/daemon.py</files>
  <action>
Add helper methods to SteeringConfig class:

5. _load_rtt_measurement(self) -> None:
   - Extract lines 224-229
   - Sets: measurement_interval, ping_host, ping_count
   - Preserves validation: self.validate_ping_host() (C3 fix)

6. _load_cake_queues(self) -> None:
   - Extract lines 231-242
   - Sets: primary_download_queue, primary_upload_queue
   - Preserves defaults based on primary_wan (depends on _load_topology running first)
   - Preserves legacy support: cake_queues.spectrum_download -> primary_download
   - Preserves validation: self.validate_identifier()

7. _load_operational_mode(self) -> None:
   - Extract lines 244-247
   - Sets: cake_aware, enable_yellow_state
   - Uses self.data.get('mode', {})

Update _load_specific_fields() to call these helpers after Task 1 helpers.
  </action>
  <verify>cd /home/kevin/projects/wanctl && make test && make lint</verify>
  <done>3 more helper methods extracted, 7 total helpers, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Extract thresholds, persistence, and operational config helpers</name>
  <files>src/wanctl/steering/daemon.py</files>
  <action>
Add remaining helper methods to SteeringConfig class:

8. _load_thresholds(self) -> None:
   - Extract lines 249-277 (largest section)
   - Sets: bad_threshold_ms, recovery_threshold_ms, bad_samples, good_samples (legacy)
   - Sets: green_rtt_ms, yellow_rtt_ms, red_rtt_ms, min_drops_red, min_queue_yellow, min_queue_red (CAKE-aware)
   - Sets: rtt_ewma_alpha, queue_ewma_alpha (with validate_alpha - C5 fix)
   - Sets: red_samples_required, green_samples_required

9. _load_baseline_bounds(self) -> None:
   - Extract lines 279-282
   - Sets: baseline_rtt_min, baseline_rtt_max
   - C4 fix: configurable with security defaults

10. _load_state_persistence(self) -> None:
    - Extract lines 284-286
    - Sets: state_file, history_size

11. _load_logging_config(self) -> None:
    - Extract lines 288-291
    - Sets: main_log, debug_log, log_cake_stats

12. _load_lock_config(self) -> None:
    - Extract lines 293-295
    - Sets: lock_file, lock_timeout

13. _load_timeouts(self) -> None:
    - Extract lines 297-301
    - Sets: timeout_ssh_command, timeout_ping, timeout_ping_total

14. _build_router_dict(self) -> None:
    - Extract lines 303-312
    - Sets: self.router dict for CakeStatsReader
    - Depends on all router-related fields being set first

15. _load_metrics_config(self) -> None:
    - Extract lines 314-316
    - Sets: metrics_enabled

Update _load_specific_fields() to be a simple orchestrator calling all 15 helpers in order.
Final _load_specific_fields() should be ~20 lines (helper calls only).
  </action>
  <verify>cd /home/kevin/projects/wanctl && make test && make lint && make type</verify>
  <done>All 15 helper methods extracted, _load_specific_fields() reduced to ~20 lines of orchestration, 134 lines broken into testable units, all tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SteeringConfig has 15 new helper methods (all with docstrings)
- [ ] _load_specific_fields() is ~20 lines (orchestration only)
- [ ] All validation preserved (validate_identifier, validate_comment, validate_ping_host, validate_alpha)
- [ ] Legacy support preserved (cake_state_sources.spectrum, cake_queues.spectrum_*)
- [ ] `make test` passes (474+ tests)
- [ ] `make lint` passes
- [ ] `make type` passes
- [ ] No behavioral changes to config loading
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- _load_specific_fields() reduced from 134 lines to ~20 lines
- 15 focused helper methods with clear single responsibilities
- Config loading behavior unchanged
- Phase 8 complete
</success_criteria>

<output>
After completion, create `.planning/phases/08-extract-common-helpers/08-03-SUMMARY.md`:

# Phase 8 Plan 3: Split Steering Config Loading Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/wanctl/steering/daemon.py` - 15 helper methods extracted from _load_specific_fields()

## Decisions Made

[Any decisions during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 8 complete. Ready for Phase 9: Utility Consolidation - Part 1
</output>
