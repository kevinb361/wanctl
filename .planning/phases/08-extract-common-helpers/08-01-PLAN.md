---
phase: 08-extract-common-helpers
plan: 01
type: execute
---

<objective>
Extract duplicated signal handling patterns to a shared utility module.

Purpose: Eliminate 80+ lines of duplicated signal handling code across three entry points, centralizing shutdown logic for consistent daemon behavior.
Output: New signal_utils.py module, updated entry points using shared utilities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 7 findings (dependency graph):
@.planning/phases/07-core-algorithm-analysis/07-03-SUMMARY.md

# Source files with duplicated patterns:
@src/wanctl/autorate_continuous.py (lines 64-102: signal handling)
@src/wanctl/steering/daemon.py (lines 106-144: signal handling)
@src/wanctl/calibrate.py (lines 62-86: signal handling)

# Existing utility pattern to follow:
@src/wanctl/lock_utils.py

**Established patterns:**
- Utility modules use snake_case (lock_utils.py, logging_utils.py, retry_utils.py)
- Module-level functions with clear docstrings (Google-style per Phase 6)
- threading.Event for shutdown coordination

**Constraining decisions:**
- Phase 6: Signal handlers extracted to module-level (established pattern)
- Phase 7: Signal handling is protected zone for concurrency (W5)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create signal_utils.py with shared signal handling</name>
  <files>src/wanctl/signal_utils.py</files>
  <action>
Create new signal_utils.py module with:

1. Module-level threading.Event (_shutdown_event)
2. Module-level signal handler function (_signal_handler) that sets the event
3. register_signal_handlers() function that registers SIGTERM and SIGINT handlers
4. is_shutdown_requested() function that checks if shutdown event is set
5. wait_for_shutdown(timeout) function for blocking wait with timeout (used by calibrate.py pattern)
6. get_shutdown_event() function to get the event directly (for daemon loops that need event.wait())

Follow existing patterns from steering/daemon.py lines 106-144 (best practice: early registration).
Add Google-style docstrings per Phase 6 conventions.
Include module docstring explaining purpose and usage.

Do NOT use logging in signal handler (deadlock risk per Phase 6 findings).
  </action>
  <verify>python -c "from wanctl.signal_utils import register_signal_handlers, is_shutdown_requested; print('Import OK')"</verify>
  <done>signal_utils.py exists with register_signal_handlers(), is_shutdown_requested(), wait_for_shutdown(), get_shutdown_event() functions</done>
</task>

<task type="auto">
  <name>Task 2: Update daemon entry points to use signal_utils</name>
  <files>src/wanctl/autorate_continuous.py, src/wanctl/steering/daemon.py</files>
  <action>
Update autorate_continuous.py:
1. Remove module-level _shutdown_event, _signal_handler, register_signal_handlers(), is_shutdown_requested() (lines 64-102)
2. Add import: from wanctl.signal_utils import register_signal_handlers, is_shutdown_requested, get_shutdown_event
3. Update main() to call register_signal_handlers() (keep same location for early registration)
4. Update all is_shutdown_requested() calls (should work unchanged)
5. If any code uses _shutdown_event.wait(), replace with get_shutdown_event().wait()

Update steering/daemon.py:
1. Remove module-level _shutdown_event, _signal_handler, register_signal_handlers(), is_shutdown_requested() (lines 106-144)
2. Add import: from wanctl.signal_utils import register_signal_handlers, is_shutdown_requested, get_shutdown_event
3. Update main() to call register_signal_handlers() (keep same location - line 1025)
4. Update all is_shutdown_requested() calls (should work unchanged)
5. If any code uses _shutdown_event.wait(), replace with get_shutdown_event().wait()

Preserve exact shutdown behavior - no functional changes, only source of functions changes.
  </action>
  <verify>cd /home/kevin/projects/wanctl && python -c "from wanctl.autorate_continuous import main; from wanctl.steering.daemon import main; print('Imports OK')" && make test</verify>
  <done>Both daemon entry points use signal_utils, removed ~40 lines from each file, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Update calibrate.py and verify complete integration</name>
  <files>src/wanctl/calibrate.py</files>
  <action>
Update calibrate.py:
1. Remove module-level _shutdown_requested, _signal_handler, register_signal_handlers() (lines 62-86)
2. Add import: from wanctl.signal_utils import register_signal_handlers, is_shutdown_requested
3. Update main() to call register_signal_handlers() (line 887 area)
4. Update any is_shutdown_requested() or _shutdown_requested checks

Note: calibrate.py uses simpler pattern (boolean flag vs Event), but signal_utils should work as drop-in replacement since is_shutdown_requested() returns bool.

Run full test suite to verify no regressions.
  </action>
  <verify>cd /home/kevin/projects/wanctl && make test && python -c "from wanctl.calibrate import main; print('Import OK')"</verify>
  <done>calibrate.py uses signal_utils, all three entry points unified, 474+ tests pass, ~80 lines of duplication eliminated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] signal_utils.py exists with documented functions
- [ ] autorate_continuous.py imports from signal_utils (no local signal handling)
- [ ] steering/daemon.py imports from signal_utils (no local signal handling)
- [ ] calibrate.py imports from signal_utils (no local signal handling)
- [ ] `make test` passes (474+ tests)
- [ ] `make lint` passes
- [ ] `make type` passes
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ~80 lines of duplicated code eliminated
- Signal handling centralized in single module
- No behavioral changes to shutdown logic
</success_criteria>

<output>
After completion, create `.planning/phases/08-extract-common-helpers/08-01-SUMMARY.md`:

# Phase 8 Plan 1: Signal Handling Extraction Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/wanctl/signal_utils.py` - New shared signal handling module
- `src/wanctl/autorate_continuous.py` - Removed local signal handling
- `src/wanctl/steering/daemon.py` - Removed local signal handling
- `src/wanctl/calibrate.py` - Removed local signal handling

## Decisions Made

[Any decisions during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 08-02-PLAN.md (Systemd Utilities Extraction)
</output>
