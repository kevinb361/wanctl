---
phase: 08-extract-common-helpers
plan: 02
type: execute
---

<objective>
Extract duplicated systemd/watchdog integration patterns to a shared utility module.

Purpose: Eliminate ~30 lines of duplicated systemd integration code across two daemons, centralizing watchdog notification for consistent daemon health reporting.
Output: New systemd_utils.py module, updated daemons using shared utilities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Previous plan in this phase:
@.planning/phases/08-extract-common-helpers/08-01-SUMMARY.md

# Source files with duplicated patterns:
@src/wanctl/autorate_continuous.py (lines 23-29: optional import, lines 1337-1346: watchdog)
@src/wanctl/steering/daemon.py (lines 1099-1105: optional import, lines 1141-1147: watchdog)

# Existing utility pattern to follow:
@src/wanctl/signal_utils.py (created in 08-01)

**Established patterns:**
- Optional imports with try/except fallback to None
- Conditional notify calls (if sd_notify is not None)
- Status messages: "WATCHDOG=1", "STATUS=Degraded - ..."
- Watchdog notification only when healthy

**Constraining decisions:**
- Phase 7: Systemd watchdog is part of daemon control loop (S5)
- Both daemons use identical pattern for degraded state handling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create systemd_utils.py with shared watchdog utilities</name>
  <files>src/wanctl/systemd_utils.py</files>
  <action>
Create new systemd_utils.py module with:

1. Module-level optional import of systemd.daemon.notify with try/except fallback
2. is_systemd_available() -> bool: Check if systemd integration is available
3. notify_ready() -> None: Send "READY=1" notification (for Type=notify services)
4. notify_watchdog() -> None: Send "WATCHDOG=1" notification
5. notify_status(status: str) -> None: Send "STATUS={status}" notification
6. notify_stopping() -> None: Send "STOPPING=1" notification
7. notify_degraded(message: str) -> None: Convenience for "STATUS=Degraded - {message}"

All notify functions should be no-ops if systemd is not available (graceful fallback).
Add Google-style docstrings per Phase 6 conventions.
Include module docstring explaining purpose and usage patterns.

Example usage pattern (from existing code):
```python
# Notify watchdog ONLY if healthy
if consecutive_failures == 0:
    notify_watchdog()
else:
    notify_degraded(f"{consecutive_failures} consecutive failures")
```
  </action>
  <verify>python -c "from wanctl.systemd_utils import notify_watchdog, notify_status, is_systemd_available; print('Import OK')"</verify>
  <done>systemd_utils.py exists with notify_watchdog(), notify_status(), notify_degraded(), is_systemd_available() functions</done>
</task>

<task type="auto">
  <name>Task 2: Update both daemons to use systemd_utils</name>
  <files>src/wanctl/autorate_continuous.py, src/wanctl/steering/daemon.py</files>
  <action>
Update autorate_continuous.py:
1. Remove optional systemd import block (lines 23-29)
2. Add import: from wanctl.systemd_utils import notify_watchdog, notify_status, notify_degraded
3. Replace sd_notify("WATCHDOG=1") with notify_watchdog()
4. Replace sd_notify("STATUS=...") with notify_status("...")
5. Replace sd_notify("STATUS=Degraded - ...") with notify_degraded("...")
6. Remove all `if sd_notify:` checks (now handled internally by systemd_utils)

Update steering/daemon.py:
1. Remove optional systemd import block (lines 1099-1105)
2. Add import: from wanctl.systemd_utils import notify_watchdog, notify_status, notify_degraded
3. Replace sd_notify("WATCHDOG=1") with notify_watchdog()
4. Replace sd_notify("STATUS=...") with notify_status("...")
5. Replace sd_notify("STATUS=Degraded - ...") with notify_degraded("...")
6. Remove all `if sd_notify:` checks (now handled internally by systemd_utils)

Preserve exact watchdog behavior - notification only when healthy, status updates on degraded state.
Run full test suite to verify no regressions.
  </action>
  <verify>cd /home/kevin/projects/wanctl && make test && make lint && make type</verify>
  <done>Both daemons use systemd_utils, removed ~15 lines from each file, all tests pass, lint/type clean</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] systemd_utils.py exists with documented functions
- [ ] autorate_continuous.py imports from systemd_utils (no local systemd import)
- [ ] steering/daemon.py imports from systemd_utils (no local systemd import)
- [ ] `make test` passes (474+ tests)
- [ ] `make lint` passes
- [ ] `make type` passes
- [ ] Watchdog behavior unchanged (notify only when healthy)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- ~30 lines of duplicated code eliminated
- Systemd integration centralized in single module
- No behavioral changes to watchdog notifications
</success_criteria>

<output>
After completion, create `.planning/phases/08-extract-common-helpers/08-02-SUMMARY.md`:

# Phase 8 Plan 2: Systemd Utilities Extraction Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `src/wanctl/systemd_utils.py` - New shared systemd utilities module
- `src/wanctl/autorate_continuous.py` - Removed local systemd import/handling
- `src/wanctl/steering/daemon.py` - Removed local systemd import/handling

## Decisions Made

[Any decisions during implementation]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 08-03-PLAN.md (Split Steering Config Loading)
</output>
