---
phase: 22-deployment-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - configs/steering_config_v2.yaml  # DELETE
  - scripts/deploy.sh
  - scripts/validate-deployment.sh   # CREATE
  - docs/STEERING_CONFIG_MISMATCH_ISSUE.md
  - docs/FASTER_RESPONSE_INTERVAL.md
autonomous: true

must_haves:
  truths:
    - "Deploy script exits non-zero when --with-steering and steering.yaml missing"
    - "Validation script checks router reachability before daemon start"
    - "Validation script warns about missing/corrupt state files"
    - "Legacy steering_config_v2.yaml no longer exists"
  artifacts:
    - path: "scripts/validate-deployment.sh"
      provides: "Pre-startup validation checks"
      min_lines: 80
    - path: "scripts/deploy.sh"
      provides: "Fail-fast steering deployment"
      contains: "exit 1.*steering.yaml"
  key_links:
    - from: "scripts/validate-deployment.sh"
      to: "router REST API"
      via: "curl to /rest/system/resource"
      pattern: "curl.*rest/system/resource"
    - from: "scripts/deploy.sh"
      to: "configs/steering.yaml"
      via: "existence check with exit 1"
      pattern: "exit 1"
---

<objective>
Implement deployment safety improvements: cleanup legacy config naming, fail-fast on missing production config, and create pre-startup validation script.

Purpose: Prevent silent deployment failures like the steering_config mismatch incident (2026-01-11)
Output: Hardened deploy script, new validation script, cleaned up config directory
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-deployment-safety/22-RESEARCH.md

# Key files
@scripts/deploy.sh
@scripts/install.sh
@configs/steering.yaml
@docs/STEERING_CONFIG_MISMATCH_ISSUE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up legacy config and update references</name>
  <files>
    configs/steering_config_v2.yaml (DELETE)
    docs/STEERING_CONFIG_MISMATCH_ISSUE.md
    docs/FASTER_RESPONSE_INTERVAL.md
  </files>
  <action>
    1. Delete legacy config file:
       - `rm configs/steering_config_v2.yaml` (duplicate of steering.yaml)

    2. Update docs/STEERING_CONFIG_MISMATCH_ISSUE.md:
       - Change status from "RESOLVED (temporary fix applied 2026-01-11)" to "CLOSED"
       - Add resolution note at top: "Permanent fix applied: steering.yaml is now the canonical config file, legacy names removed."
       - Mark all Week 1/Week 2 action items as complete with date

    3. Update docs/FASTER_RESPONSE_INTERVAL.md:
       - Replace all references to `steering_config_v2.yaml` with `steering.yaml`
       - Lines 101, 115, 144, 275-278 reference the old name

    4. Stage and commit: "chore(deploy): remove legacy steering_config_v2.yaml"
  </action>
  <verify>
    - `ls configs/steering*.yaml` shows only `steering.yaml`
    - `grep -r "steering_config_v2" docs/` returns no matches
    - git status shows expected changes
  </verify>
  <done>
    - Legacy steering_config_v2.yaml deleted
    - Doc references updated to steering.yaml
    - Issue doc marked as closed
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden deploy.sh to fail-fast on missing steering config</name>
  <files>scripts/deploy.sh</files>
  <action>
    Modify deploy_steering_components() function (lines 350-364) to fail-fast when steering config is missing:

    CURRENT BEHAVIOR (lines 350-359):
    ```bash
    # Also deploy steering config if available
    if [[ -f "$PROJECT_ROOT/configs/steering.yaml" ]]; then
        scp "$PROJECT_ROOT/configs/steering.yaml" ...
        print_success "Steering config deployed"
    elif [[ -f "$PROJECT_ROOT/configs/examples/steering.yaml.example" ]]; then
        scp "$PROJECT_ROOT/configs/examples/steering.yaml.example" ...
        print_warning "Using example steering config - customize..."
    fi
    ```

    REQUIRED BEHAVIOR:
    ```bash
    # Deploy steering config - REQUIRED for --with-steering
    if [[ -f "$PROJECT_ROOT/configs/steering.yaml" ]]; then
        scp "$PROJECT_ROOT/configs/steering.yaml" "$TARGET_HOST:/tmp/steering.yaml"
        ssh "$TARGET_HOST" "sudo mv /tmp/steering.yaml $TARGET_CONFIG_DIR/steering.yaml && sudo chown root:wanctl $TARGET_CONFIG_DIR/steering.yaml && sudo chmod 640 $TARGET_CONFIG_DIR/steering.yaml"
        print_success "Steering config deployed"
    else
        print_error "Production steering config not found: configs/steering.yaml"
        print_error "Create configs/steering.yaml before deploying with --with-steering"
        print_error "See configs/examples/steering.yaml.example for template"
        exit 1
    fi
    ```

    Key changes:
    - Remove fallback to example config (lines 355-358)
    - Add explicit exit 1 when steering.yaml missing
    - Add helpful error message pointing to example
  </action>
  <verify>
    - Test fail-fast: `mv configs/steering.yaml configs/steering.yaml.bak && ./scripts/deploy.sh spectrum test-host --with-steering` exits 1 with error
    - Restore: `mv configs/steering.yaml.bak configs/steering.yaml`
    - Review diff shows example fallback removed
  </verify>
  <done>
    - Deploy script exits non-zero when --with-steering used without steering.yaml
    - No silent fallback to example config
    - Error message is actionable
  </done>
</task>

<task type="auto">
  <name>Task 3: Create pre-startup validation script</name>
  <files>scripts/validate-deployment.sh (CREATE)</files>
  <action>
    Create validation script that checks deployment readiness before daemon start.

    Use patterns from scripts/install.sh (lines 618-768):
    - test_router_connection() for REST/SSH reachability
    - discover_queues() for queue existence checks
    - YAML extraction for config parsing

    Script requirements:

    1. Header with usage:
       ```bash
       #!/bin/bash
       # Pre-startup validation for wanctl deployment
       # Usage: validate-deployment.sh [wan-config.yaml] [--steering]
       # Exit codes: 0=pass, 1=blocking errors, 2=warnings only
       ```

    2. Parse config YAML to extract:
       - router.host, router.transport, router.password
       - state_file path
       - (if --steering) cake_state_sources.primary, mangle_rule.comment

    3. Validation checks (in order):
       a. Config file exists and valid YAML
       b. Router reachable (REST or SSH based on transport)
       c. State file path writable (parent dir exists)
       d. (if --steering) Primary WAN state file exists or warn
       e. (if --steering) Queue tree entries exist or warn

    4. Output format:
       ```
       [PASS] Config valid: /etc/wanctl/spectrum.yaml
       [PASS] Router reachable: 10.10.99.1 (REST)
       [WARN] State file not found (will be created): /var/lib/wanctl/spectrum_state.json
       [PASS] All critical checks passed
       ```

    5. Error handling:
       - Critical failures (config missing, router unreachable): exit 1
       - Warnings (state file missing on first run): exit 2
       - All pass: exit 0

    Functions to implement:
    - extract_yaml_value() - python3 one-liner for YAML path extraction
    - validate_config() - check file exists and valid YAML
    - test_router_reachable() - adapted from install.sh:620-700
    - check_state_path() - verify parent dir exists, writable
    - check_steering_deps() - primary WAN state, queue existence

    Make executable: chmod +x scripts/validate-deployment.sh
  </action>
  <verify>
    - `./scripts/validate-deployment.sh configs/spectrum.yaml` runs without error
    - `./scripts/validate-deployment.sh --help` shows usage
    - `./scripts/validate-deployment.sh /nonexistent.yaml` exits 1
    - Script is executable: `test -x scripts/validate-deployment.sh`
  </verify>
  <done>
    - Validation script created at scripts/validate-deployment.sh
    - Checks config, router, state paths
    - Exit codes: 0=pass, 1=critical, 2=warnings
    - Uses existing patterns from install.sh
  </done>
</task>

</tasks>

<verification>
Run comprehensive validation:

```bash
# 1. Legacy cleanup verified
ls configs/steering*.yaml                    # Only steering.yaml
grep -r "steering_config_v2" docs/ || echo "Clean"

# 2. Deploy script fail-fast verified
bash -n scripts/deploy.sh                    # Syntax check
grep -A5 "Production steering config not found" scripts/deploy.sh

# 3. Validation script works
./scripts/validate-deployment.sh configs/spectrum.yaml
./scripts/validate-deployment.sh configs/steering.yaml --steering

# 4. All tests still pass
.venv/bin/pytest tests/ -v --tb=short
```
</verification>

<success_criteria>
- [ ] `configs/steering_config_v2.yaml` deleted
- [ ] All doc references updated to `steering.yaml`
- [ ] `docs/STEERING_CONFIG_MISMATCH_ISSUE.md` marked CLOSED
- [ ] `scripts/deploy.sh` exits 1 when steering.yaml missing
- [ ] `scripts/validate-deployment.sh` exists and is executable
- [ ] Validation script checks: config, router, state paths
- [ ] All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/22-deployment-safety/22-01-SUMMARY.md`
</output>
