---
phase: 27-test-coverage-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - Makefile
  - .gitignore
  - README.md
autonomous: true

must_haves:
  truths:
    - "pytest --cov generates coverage data and terminal report"
    - "make coverage produces HTML report in coverage-report/"
    - "Coverage badge visible in README.md"
    - ".coverage and coverage-report/ are gitignored"
  artifacts:
    - path: "pyproject.toml"
      provides: "[tool.coverage.*] configuration sections"
      contains: "tool.coverage"
    - path: "Makefile"
      provides: "coverage target with HTML generation"
      contains: "coverage:"
    - path: ".gitignore"
      provides: "Coverage artifacts excluded"
      contains: ".coverage"
    - path: "README.md"
      provides: "Coverage badge"
      contains: "coverage"
  key_links:
    - from: "Makefile"
      to: "pytest-cov"
      via: "pytest --cov invocation"
      pattern: "pytest.*--cov"
    - from: "pyproject.toml"
      to: "coverage.py"
      via: "[tool.coverage] config"
      pattern: "\\[tool\\.coverage"
---

<objective>
Configure pytest-cov and establish test coverage measurement infrastructure.

Purpose: Enable coverage tracking to identify undertested code areas and prevent coverage regression.
Output: Working `make coverage` command that produces terminal + HTML reports with badge in README.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/27-test-coverage-setup/27-CONTEXT.md
@pyproject.toml
@.gitignore
@README.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure pytest-cov in pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
Add pytest-cov to dev dependencies and configure coverage.py via [tool.coverage.*] sections.

**Add to [dependency-groups] dev:**
- pytest-cov>=4.1.0

**Add [tool.coverage.run] section:**
- source = ["src", "tests"]
- branch = true (enable branch coverage)
- parallel = true (for future parallel test runs)
- context = "static" (track which test covers which line)
- relative_files = true (portable paths)

**Add [tool.coverage.report] section:**
- show_missing = true (display uncovered line numbers)
- skip_empty = true (skip files with no executable code)
- precision = 1 (one decimal place)
- partial_branches = true (show partially covered branches)

**Add [tool.coverage.html] section:**
- directory = "coverage-report"
- show_contexts = true

**Add [tool.pytest.ini_options] section (if not exists):**
- addopts = "--cov-config=pyproject.toml" (ensure config is loaded)
  </action>
  <verify>
Run: `.venv/bin/uv sync` to install pytest-cov
Run: `.venv/bin/pytest tests/ --cov=src --cov=tests --cov-report=term-missing -q --co` (collect only, verifies config loads)
  </verify>
  <done>pytest-cov installed, coverage config sections present in pyproject.toml</done>
</task>

<task type="auto">
  <name>Task 2: Create Makefile with coverage targets</name>
  <files>Makefile, .gitignore</files>
  <action>
**Create Makefile** with standard Python project targets:

```makefile
.PHONY: test coverage lint type format ci clean

# Run tests without coverage
test:
	.venv/bin/pytest tests/ -v

# Run tests with coverage + HTML report
coverage:
	.venv/bin/pytest tests/ --cov=src --cov=tests --cov-report=term-missing --cov-report=html
	@echo ""
	@echo "HTML report: coverage-report/index.html"

# Linting
lint:
	.venv/bin/ruff check src/ tests/

# Type checking
type:
	.venv/bin/mypy src/wanctl/

# Format code
format:
	.venv/bin/ruff format src/ tests/

# All CI checks (lint, type, test)
ci: lint type test

# Clean build artifacts
clean:
	rm -rf .coverage coverage-report/ *.egg-info/ dist/ build/
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
```

**Update .gitignore** - add coverage artifacts:
- .coverage
- .coverage.*
- coverage-report/
  </action>
  <verify>
Run: `make coverage` - should run tests and generate HTML report
Run: `ls coverage-report/index.html` - should exist
Run: `git status` - .coverage and coverage-report/ should not appear as untracked
  </verify>
  <done>Makefile exists with coverage target, HTML report generated in coverage-report/, artifacts gitignored</done>
</task>

<task type="auto">
  <name>Task 3: Add coverage badge to README.md</name>
  <files>README.md</files>
  <action>
Add a coverage badge after the existing License badge on line 3.

Since this is a local project without CI service, use a static badge that will be manually updated:

```markdown
[![Coverage](https://img.shields.io/badge/coverage-XX%25-brightgreen)](coverage-report/index.html)
```

Replace XX with actual coverage percentage from `make coverage` output.

The badge links to local HTML report (works when browsing locally).

**Badge color logic** (for future updates):
- 90%+ = brightgreen
- 80-89% = green
- 70-79% = yellowgreen
- 60-69% = yellow
- <60% = red
  </action>
  <verify>
Run: `grep -n "coverage" README.md` - should show badge line near top
Visual: Badge appears correctly when viewing README
  </verify>
  <done>Coverage badge displayed in README.md with current percentage</done>
</task>

</tasks>

<verification>
1. `make coverage` runs all tests with coverage measurement
2. Terminal shows coverage table with missing lines
3. `coverage-report/index.html` exists and is browsable
4. `git status` shows no untracked .coverage files
5. README.md displays coverage badge
</verification>

<success_criteria>
- COV-01: pytest-cov configured in pyproject.toml with [tool.coverage.*] sections
- COV-02: `make coverage` generates terminal report with missing lines
- COV-03: HTML report in coverage-report/ directory
- COV-04: Advisory (no threshold enforcement yet - measure first)
- COV-05: Coverage badge visible in README.md
</success_criteria>

<output>
After completion, create `.planning/phases/27-test-coverage-setup/27-01-SUMMARY.md`
</output>
