---
phase: 25-health-endpoint-core
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - tests/test_steering_health.py
autonomous: true

must_haves:
  truths:
    - "Unit tests verify health endpoint behavior"
    - "Tests cover healthy/degraded status transitions"
    - "Tests verify clean shutdown"
    - "Tests verify 404 for unknown paths"
  artifacts:
    - path: "tests/test_steering_health.py"
      provides: "Unit tests for steering health endpoint"
      min_lines: 80
  key_links:
    - from: "tests/test_steering_health.py"
      to: "src/wanctl/steering/health.py"
      via: "import"
      pattern: "from wanctl.steering.health import"
---

<objective>
Add comprehensive unit tests for the steering health endpoint module.

Purpose: Validate all HLTH-* requirements with automated tests.
Output: `tests/test_steering_health.py` with full coverage of health endpoint behavior.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/25-health-endpoint-core/25-01-SUMMARY.md
@src/wanctl/steering/health.py
@tests/test_health_check.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create steering health test suite</name>
  <files>tests/test_steering_health.py</files>
  <action>
Create `tests/test_steering_health.py` mirroring patterns from `tests/test_health_check.py`:

**Test cases (use pytest fixtures):**

1. **test_health_endpoint_returns_json**
   - Start server, GET /health, verify JSON response
   - Assert status, uptime_seconds, version in response

2. **test_health_root_path**
   - Start server, GET /, verify same response as /health

3. **test_health_status_healthy**
   - consecutive_failures = 0, assert status == "healthy"
   - Assert HTTP 200

4. **test_health_status_degraded**
   - consecutive_failures = 3, assert status == "degraded"
   - Assert HTTP 503

5. **test_health_status_threshold**
   - consecutive_failures = 2, assert status == "healthy" (threshold is 3)
   - consecutive_failures = 3, assert status == "degraded"

6. **test_health_uptime_increases**
   - Start server, check uptime, wait 0.1s, check again
   - Assert uptime increased

7. **test_health_version**
   - Verify version matches wanctl.__version__

8. **test_health_404_unknown_path**
   - GET /unknown, assert 404
   - Assert JSON error response

9. **test_health_server_shutdown**
   - Start server, shutdown(), verify thread is not alive

10. **test_update_health_status**
    - Call update_steering_health_status(5)
    - Assert SteeringHealthHandler.consecutive_failures == 5

**Fixture:**
```python
@pytest.fixture
def health_server():
    from wanctl.steering.health import start_steering_health_server, SteeringHealthHandler
    # Reset class state
    SteeringHealthHandler.consecutive_failures = 0
    SteeringHealthHandler.start_time = None
    SteeringHealthHandler.daemon = None

    server = start_steering_health_server(port=9102)
    yield server
    server.shutdown()
```

Use `urllib.request` for HTTP calls (stdlib, matches project pattern).
  </action>
  <verify>
`.venv/bin/pytest tests/test_steering_health.py -v`
  </verify>
  <done>
All 10 test cases pass, covering HLTH-01 through HLTH-06.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite</name>
  <files>tests/test_steering_health.py</files>
  <action>
Run the complete test suite to verify no regressions:

1. Run all tests: `.venv/bin/pytest tests/ -v`
2. Verify test count increased (was 725)
3. Verify no failures or errors

If any existing tests fail, investigate and fix (likely import issues or port conflicts).
  </action>
  <verify>
`.venv/bin/pytest tests/ -v --tb=short`
  </verify>
  <done>
Full test suite passes with new health endpoint tests included. Test count is 725 + ~10 = ~735.
  </done>
</task>

</tasks>

<verification>
- [ ] `tests/test_steering_health.py` exists
- [ ] All new tests pass: `.venv/bin/pytest tests/test_steering_health.py -v`
- [ ] Full test suite passes: `.venv/bin/pytest tests/ -v`
- [ ] Tests cover all HLTH-* requirements
</verification>

<success_criteria>
1. 10+ new tests in test_steering_health.py
2. All new tests pass
3. Full test suite passes (no regressions)
4. Tests verify: JSON format, status codes, uptime, version, 404, shutdown, update function
</success_criteria>

<output>
After completion, create `.planning/phases/25-health-endpoint-core/25-02-SUMMARY.md`
</output>
