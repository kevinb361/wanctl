---
phase: 25-health-endpoint-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/wanctl/steering/health.py
autonomous: true

must_haves:
  truths:
    - "GET http://127.0.0.1:9102/health returns JSON"
    - "Response contains status, uptime_seconds, version"
    - "Returns 200 when healthy, 503 when degraded"
    - "Server runs in daemon thread (does not block)"
  artifacts:
    - path: "src/wanctl/steering/health.py"
      provides: "Health endpoint module"
      exports: ["SteeringHealthHandler", "SteeringHealthServer", "start_steering_health_server"]
      min_lines: 80
  key_links:
    - from: "src/wanctl/steering/health.py"
      to: "wanctl.__version__"
      via: "import"
      pattern: "from wanctl import __version__"
---

<objective>
Create steering daemon health endpoint module with HTTP server, handler, and routes.

Purpose: Enable external monitoring (container orchestration, health probes) to query steering daemon status.
Output: `src/wanctl/steering/health.py` with working HTTP health server.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/25-health-endpoint-core/25-RESEARCH.md
@src/wanctl/health_check.py
@src/wanctl/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create steering health module</name>
  <files>src/wanctl/steering/health.py</files>
  <action>
Create `src/wanctl/steering/health.py` mirroring the pattern in `health_check.py`:

1. **SteeringHealthHandler(BaseHTTPRequestHandler)**:
   - Class-level attributes: `daemon = None`, `start_time = None`, `consecutive_failures = 0`
   - `log_message()`: Suppress HTTP logging (pass)
   - `do_GET()`: Handle GET / and /health with JSON response, 404 for other paths
   - `_get_health_status()`: Return dict with status, uptime_seconds, version

2. **SteeringHealthServer** wrapper class:
   - `__init__(self, server: HTTPServer, thread: threading.Thread)`
   - `shutdown()`: Call `server.shutdown()` then `thread.join(timeout=5.0)`

3. **start_steering_health_server()** function:
   - Args: host="127.0.0.1", port=9102, daemon=None
   - Set class-level attributes on handler
   - Create HTTPServer, start Thread(daemon=True, name="steering-health")
   - Return SteeringHealthServer wrapper

4. **update_steering_health_status(consecutive_failures: int)** helper:
   - Updates SteeringHealthHandler.consecutive_failures

Health status logic:
- status = "healthy" if consecutive_failures < 3 else "degraded"
- uptime_seconds = time.monotonic() - start_time (rounded to 1 decimal)
- version = wanctl.__version__

Use TYPE_CHECKING guard for SteeringDaemon import to avoid circular imports.
  </action>
  <verify>
`python -c "from wanctl.steering.health import SteeringHealthHandler, SteeringHealthServer, start_steering_health_server, update_steering_health_status"`
  </verify>
  <done>
Module imports cleanly, exports all required classes/functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify HTTP functionality</name>
  <files>src/wanctl/steering/health.py</files>
  <action>
Create a minimal test script to verify the health server works:

```python
# Quick verification (run manually, don't commit)
import time
from wanctl.steering.health import start_steering_health_server

server = start_steering_health_server()
time.sleep(0.5)

import urllib.request
try:
    with urllib.request.urlopen("http://127.0.0.1:9102/health", timeout=2) as r:
        print(f"Status: {r.status}")
        print(f"Body: {r.read().decode()}")
finally:
    server.shutdown()
```

Run this in the venv to confirm:
1. Server starts on port 9102
2. GET /health returns 200 with JSON
3. JSON contains status, uptime_seconds, version
4. Server shuts down cleanly
  </action>
  <verify>
`.venv/bin/python -c "
import time
from wanctl.steering.health import start_steering_health_server
server = start_steering_health_server()
time.sleep(0.2)
import urllib.request
import json
with urllib.request.urlopen('http://127.0.0.1:9102/health', timeout=2) as r:
    data = json.load(r)
    assert r.status == 200
    assert 'status' in data
    assert 'uptime_seconds' in data
    assert 'version' in data
    print('Health endpoint verified OK')
server.shutdown()
"`
  </verify>
  <done>
Health server starts, responds with correct JSON, shuts down cleanly.
  </done>
</task>

</tasks>

<verification>
- [ ] `src/wanctl/steering/health.py` exists and imports cleanly
- [ ] HTTP server responds on port 9102
- [ ] GET / returns same response as GET /health
- [ ] Response is valid JSON with required fields
- [ ] Server uses daemon=True thread
- [ ] shutdown() completes within 5 seconds
</verification>

<success_criteria>
1. Module exports SteeringHealthHandler, SteeringHealthServer, start_steering_health_server
2. GET /health returns 200 with JSON: {"status": "healthy", "uptime_seconds": N, "version": "1.1.0"}
3. GET /health returns 503 when consecutive_failures >= 3
4. Server runs in background thread (daemon=True)
5. All existing tests pass: `.venv/bin/pytest tests/ -v`
</success_criteria>

<output>
After completion, create `.planning/phases/25-health-endpoint-core/25-01-SUMMARY.md`
</output>
