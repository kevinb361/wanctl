---
phase: 13-documentation-improvements
plan: 02
type: execute
---

<objective>
Add inline comments to protected algorithm zones identified in Phase 7 analysis.

Purpose: Document the "why" behind critical algorithm sections to preserve production stability during future refactoring (Phases 14-15).
Output: Inline comments explaining protected zones in WANController and SteeringDaemon.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/CORE-ALGORITHM-ANALYSIS.md

**Protected zones from Phase 7 analysis:**

**WANController (autorate_continuous.py):**
- Baseline Update Threshold (lines ~688-702): Prevents baseline drift under load
- Flash Wear Protection (line ~898, ~937-938): Prevents NAND flash wear (100K-1M writes)
- Rate Limiting Logic (lines ~905-917): Prevents RouterOS API overload

**SteeringDaemon (steering/daemon.py):**
- State Transition Logic (lines ~669-847): Core steering algorithm with asymmetric hysteresis
- Baseline RTT Validation (lines ~492-502): Security fix C4, prevents malicious baseline attacks
- EWMA Smoothing (lines ~909-923): Numeric stability C5, production-tuned alphas
- RouterOS Mangle Control (lines ~400-456): Security C2 + reliability W6

@src/wanctl/autorate_continuous.py
@src/wanctl/steering/daemon.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add protected zone comments to WANController</name>
  <files>src/wanctl/autorate_continuous.py</files>
  <action>Add inline comments to three protected zones in WANController:

1. **Baseline Update Threshold** (~line 688-702 in update_ewma):
   Add comment: "# PROTECTED: Baseline only updates when delta < 3ms (idle). Prevents drift under load."

2. **Flash Wear Protection** (~line 898 and ~937-938 in run_cycle):
   Add comment before rate change check: "# PROTECTED: Flash wear protection - only send queue limits when values change. Router NAND has 100K-1M write cycles."

3. **Rate Limiting Logic** (~line 905-917 in run_cycle):
   Add comment: "# PROTECTED: Rate limiting prevents RouterOS API overload (RB5009 limit ~50 req/sec)."

Use existing code style. Keep comments concise (one line each). Reference docs/CORE-ALGORITHM-ANALYSIS.md for details.</action>
  <verify>grep -n "PROTECTED" src/wanctl/autorate_continuous.py</verify>
  <done>Three PROTECTED zone comments added to WANController</done>
</task>

<task type="auto">
  <name>Task 2: Add protected zone comments to SteeringDaemon</name>
  <files>src/wanctl/steering/daemon.py</files>
  <action>Add inline comments to four protected zones in SteeringDaemon:

1. **State Transition Logic** (~line 669-847, both state machine methods):
   Add comment at start of _update_state_machine_cake_aware: "# PROTECTED: Asymmetric hysteresis - quick to enable (8 samples), slow to disable (60 samples). Do not change thresholds without production validation."

2. **Baseline RTT Validation** (~line 492-502 in BaselineLoader):
   Add comment: "# PROTECTED: Security fix C4 - bounds baseline to 10-60ms to prevent malicious state file attacks."

3. **EWMA Smoothing** (~line 909-923 in run_cycle):
   Add comment: "# PROTECTED: Numeric stability C5 - EWMA alphas validated at config load. Formula: (1-alpha)*current + alpha*new"

4. **RouterOS Mangle Control** (~line 400-456 in RouterOSController):
   Add comment at class level: "# PROTECTED: Security C2 (command injection prevention) + Reliability W6 (retry with verification)."

Keep comments concise. Reference docs/CORE-ALGORITHM-ANALYSIS.md.</action>
  <verify>grep -n "PROTECTED" src/wanctl/steering/daemon.py</verify>
  <done>Four PROTECTED zone comments added to SteeringDaemon</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] WANController has 3 PROTECTED comments at correct locations
- [ ] SteeringDaemon has 4 PROTECTED comments at correct locations
- [ ] Comments reference the "why" not the "what"
- [ ] All 474 tests still pass
- [ ] `uv run ruff check` passes (comments don't break linting)
</verification>

<success_criteria>

- All 7 protected zones have inline documentation
- Comments explain WHY these zones are protected (not just what they do)
- Future refactoring (Phases 14-15) has clear guidance on what not to change
- No test failures or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-documentation-improvements/13-02-SUMMARY.md`
</output>
