---
phase: 33-state-infrastructure-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_state_manager.py
autonomous: true

must_haves:
  truths:
    - "state_manager.py coverage >= 90%"
    - "All validator functions tested with boundary values"
    - "StateManager backup recovery paths verified"
    - "SteeringStateManager lock contention handled"
    - "Deque serialization roundtrip works"
  artifacts:
    - path: "tests/test_state_manager.py"
      provides: "Comprehensive state manager tests"
      min_lines: 400
  key_links:
    - from: "tests/test_state_manager.py"
      to: "src/wanctl/state_manager.py"
      via: "imports StateManager, SteeringStateManager, validators"
      pattern: "from wanctl.state_manager import"
---

<objective>
Expand test coverage for state_manager.py from 39% to 90%+.

Purpose: Complete coverage of state persistence, validation, locking, and deque serialization.
Output: Expanded tests/test_state_manager.py with all uncovered paths tested.
</objective>

<execution_context>
@/home/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/home/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-state-infrastructure-tests/33-RESEARCH.md
@src/wanctl/state_manager.py
@tests/test_state_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validator function tests</name>
  <files>tests/test_state_manager.py</files>
  <action>
Add test class `TestValidatorFunctions` covering:

1. `non_negative_int`:
   - Positive int returns unchanged
   - Negative int returns 0
   - String coercion ("10" -> 10)

2. `non_negative_float`:
   - Positive float returns unchanged
   - Negative float returns 0.0

3. `optional_positive_float`:
   - None returns None
   - Valid float in bounds returns float
   - Below min_val raises ValueError
   - Above max_val raises ValueError

4. `bounded_float`:
   - With clamp=True: above max clamped, below min clamped
   - With clamp=False: out of range raises ValueError
   - Valid value in range returns unchanged

5. `string_enum`:
   - Valid enum value returns string
   - Invalid value raises ValueError with "not in allowed set" message

Test boundary values: 0, exactly at bounds, just outside bounds.
  </action>
  <verify>pytest tests/test_state_manager.py -v -k "TestValidator" --tb=short</verify>
  <done>All validator functions tested with edge cases and error paths</done>
</task>

<task type="auto">
  <name>Task 2: Add StateSchema and StateManager edge case tests</name>
  <files>tests/test_state_manager.py</files>
  <action>
Expand `TestStateSchema` with:

1. Schema with tuple validators (default, validator_func):
   ```python
   schema = StateSchema({"alpha": (0.5, bounded_float(0.0, 1.0))})
   ```
2. `validate_field` with type coercion failure (return default)
3. `validate_state` with validation failure logs warning (use caplog)

Expand `TestStateManager` with:

1. `_backup_state_file`:
   - File exists: creates .backup file
   - File doesn't exist: returns False
   - Mock shutil.copy2 failure: returns False, logs error

2. `load` with backup recovery:
   - Corrupt primary, valid backup: recovers from backup
   - Both corrupt: uses defaults, creates .corrupt file
   - Backup validation fails: uses defaults

3. `load` validation failure path (line 390-394)

4. `save` failure path:
   - Mock atomic_write_json to raise
   - Verify returns False, logs error

5. `get` with default from schema (no explicit default provided)
  </action>
  <verify>pytest tests/test_state_manager.py -v -k "TestStateSchema or TestStateManager" --tb=short</verify>
  <done>StateSchema validator tuples and StateManager backup/corruption recovery tested</done>
</task>

<task type="auto">
  <name>Task 3: Add SteeringStateManager comprehensive tests</name>
  <files>tests/test_state_manager.py</files>
  <action>
Add test class `TestSteeringStateManager` covering:

1. Initialization:
   - Default history_maxlen used when None
   - Custom history_maxlen passed through

2. `load` with deque conversion:
   - JSON lists converted to deques on load
   - history_maxlen enforced on deques
   - Non-list values converted to empty deque

3. `load` backup recovery:
   - Corrupt primary, valid backup with deques
   - Both corrupt uses defaults

4. `save` with locking:
   - use_lock=False: direct write without lock
   - use_lock=True: acquires lock, writes, releases
   - BlockingIOError: returns False, logs "locked by another process"
   - Other lock exception: returns False, logs error

5. `save` deque to list conversion:
   - Deques serialized as lists in JSON
   - Roundtrip: save with deques, load, verify deques restored

6. `add_measurement`:
   - Adds to history_rtt and history_delta deques
   - Handles missing deque keys gracefully

7. `log_transition`:
   - Creates transition dict with timestamp, from, to, counts
   - Appends to transitions list
   - Trims to history_maxlen

8. `reset`:
   - Resets to schema defaults
   - Logs reset message

Mock `fcntl.flock` for lock contention tests (Pattern 3 from RESEARCH.md):
```python
with patch("wanctl.state_manager.fcntl.flock") as mock_flock:
    mock_flock.side_effect = BlockingIOError("Lock held")
```
  </action>
  <verify>pytest tests/test_state_manager.py -v -k "TestSteeringStateManager" --tb=short</verify>
  <done>SteeringStateManager lock contention, deque serialization, and history methods tested</done>
</task>

</tasks>

<verification>
Run coverage check for state_manager.py:
```bash
pytest tests/test_state_manager.py --cov=wanctl.state_manager --cov-report=term-missing --cov-fail-under=90
```

Expected: Coverage >= 90% for state_manager.py
</verification>

<success_criteria>
- state_manager.py coverage >= 90%
- All validator functions have explicit tests
- Backup recovery and corruption paths verified
- SteeringStateManager locking behavior tested with mocked fcntl
- Deque serialization roundtrip verified
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/33-state-infrastructure-tests/33-01-SUMMARY.md`
</output>
