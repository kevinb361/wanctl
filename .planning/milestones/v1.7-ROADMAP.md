# v1.7 Metrics History Roadmap

## Overview

Add historical metrics storage and querying to wanctl. SQLite stores time-series data with automatic downsampling and retention. Both daemons record metrics each cycle. CLI and API provide access.

## Phases

- [ ] **Phase 38: Storage Foundation** - SQLite schema, writer, downsampling, retention
- [ ] **Phase 39: Data Recording** - Hook daemons to record metrics each cycle
- [ ] **Phase 40: CLI Tool** - `wanctl-history` command for querying
- [ ] **Phase 41: API Endpoint** - `/metrics/history` on health server

## Phase Details

### Phase 38: Storage Foundation

**Goal**: Establish metrics storage layer with SQLite, downsampling, and retention management
**Depends on**: Nothing (first phase of v1.7)
**Requirements**: STOR-01, STOR-02, STOR-03, STOR-04, DATA-05
**Success Criteria** (what must be TRUE):
  1. SQLite database created at `/var/lib/wanctl/metrics.db` on first write
  2. Metrics schema uses Prometheus-compatible naming (e.g., `wanctl_rtt_ms`)
  3. Retention period configurable in config.yaml with 7-day default
  4. Old data automatically cleaned on daemon startup
  5. Downsampling reduces granularity as data ages (1s -> 1m -> 5m -> 1h)
**Plans**: TBD

Plans:
- [ ] 38-01: SQLite schema design and MetricsWriter implementation
- [ ] 38-02: Downsampling and retention logic

### Phase 39: Data Recording

**Goal**: Both daemons capture metrics each cycle with minimal performance impact
**Depends on**: Phase 38
**Requirements**: DATA-01, DATA-02, DATA-03, DATA-04, INTG-01, INTG-02, INTG-03
**Success Criteria** (what must be TRUE):
  1. Autorate daemon records RTT (current, baseline, delta) and rates each cycle
  2. Steering daemon records its metrics each cycle
  3. State transitions recorded with reason string (e.g., "RTT delta exceeded threshold")
  4. Config snapshot saved on startup and reload
  5. Recording overhead verified <5ms per cycle
**Plans**: TBD

Plans:
- [ ] 39-01: Autorate daemon metrics recording
- [ ] 39-02: Steering daemon metrics recording and config snapshots

### Phase 40: CLI Tool

**Goal**: `wanctl-history` command provides human and machine access to stored metrics
**Depends on**: Phase 39
**Requirements**: CLI-01, CLI-02, CLI-03, CLI-04, CLI-05
**Success Criteria** (what must be TRUE):
  1. `wanctl-history` command available and documented
  2. User can query by time range (`--last 1h`, `--from/--to`)
  3. User can filter by metric type (`--metrics rtt,rate,state`)
  4. Output available as table (default) or JSON (`--json`)
  5. Summary statistics mode shows min/max/avg/p95 (`--summary`)
**Plans**: TBD

Plans:
- [ ] 40-01: CLI argument parsing and MetricsReader
- [ ] 40-02: Output formatters (table, JSON, summary)

### Phase 41: API Endpoint

**Goal**: HTTP endpoint enables programmatic access to metrics history
**Depends on**: Phase 40 (shares MetricsReader)
**Requirements**: API-01, API-02, API-03, API-04
**Success Criteria** (what must be TRUE):
  1. `/metrics/history` endpoint available on autorate health server (port 9101)
  2. Query params supported: `range`, `from`, `to`, `metrics`, `wan`
  3. JSON response includes timestamps, values, and metadata
  4. Pagination via `limit` and `offset` params
**Plans**: TBD

Plans:
- [ ] 41-01: API endpoint implementation and pagination

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 38. Storage Foundation | 0/2 | Not started | - |
| 39. Data Recording | 0/2 | Not started | - |
| 40. CLI Tool | 0/2 | Not started | - |
| 41. API Endpoint | 0/1 | Not started | - |

## Requirement Coverage

| Requirement | Phase | Description |
|-------------|-------|-------------|
| STOR-01 | 38 | SQLite at /var/lib/wanctl/metrics.db |
| STOR-02 | 38 | Configurable retention (default 7 days) |
| STOR-03 | 38 | Automatic downsampling |
| STOR-04 | 38 | Cleanup expired data on startup |
| DATA-01 | 39 | Record RTT metrics each cycle |
| DATA-02 | 39 | Record rate metrics each cycle |
| DATA-03 | 39 | Record state transitions with reason |
| DATA-04 | 39 | Config snapshot on startup/reload |
| DATA-05 | 38 | Prometheus-compatible naming |
| CLI-01 | 40 | wanctl-history command |
| CLI-02 | 40 | Query by time range |
| CLI-03 | 40 | Filter by metric type |
| CLI-04 | 40 | Table and JSON output |
| CLI-05 | 40 | Summary statistics mode |
| API-01 | 41 | /metrics/history endpoint |
| API-02 | 41 | Query params (range, from, to, etc.) |
| API-03 | 41 | JSON response with timestamps |
| API-04 | 41 | Pagination support |
| INTG-01 | 39 | Autorate daemon records metrics |
| INTG-02 | 39 | Steering daemon records metrics |
| INTG-03 | 39 | Performance impact <5ms |

**Coverage:** 21/21 requirements mapped
