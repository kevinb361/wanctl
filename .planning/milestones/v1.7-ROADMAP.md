# v1.7 Metrics History Roadmap (ARCHIVED)

**Status:** SHIPPED 2026-01-25
**Phases:** 38-42 (5 phases, 8 plans)
**Tests:** 237 new tests
**Requirements:** 21/21 satisfied

## Overview

Added historical metrics storage and querying to wanctl. SQLite stores time-series data with automatic downsampling and retention. Both daemons record metrics each cycle. CLI and API provide access. Startup maintenance keeps database bounded.

## Key Deliverables

1. **SQLite Storage Layer** — Thread-safe MetricsWriter singleton with WAL mode, Prometheus-compatible naming
2. **Automatic Downsampling** — raw → 1m → 5m → 1h as data ages for efficient long-range queries
3. **Daemon Integration** — Both daemons record metrics each cycle with <5ms overhead (<2% of 50ms cycle)
4. **CLI Tool** — `wanctl-history` with time range queries, filtering, table/JSON/summary output
5. **HTTP API** — `/metrics/history` endpoint with pagination on port 9101
6. **Startup Maintenance** — Automatic cleanup and downsampling keeps database bounded

## Phases

- [x] **Phase 38: Storage Foundation** — SQLite schema, writer, downsampling, retention (2 plans)
- [x] **Phase 39: Data Recording** — Hook daemons to record metrics each cycle (2 plans)
- [x] **Phase 40: CLI Tool** — `wanctl-history` command for querying (2 plans)
- [x] **Phase 41: API Endpoint** — `/metrics/history` on health server (1 plan)
- [x] **Phase 42: Maintenance Scheduling** — Wire cleanup and downsampling to startup (1 plan, gap closure)

## Phase Results

### Phase 38: Storage Foundation ✓

**Goal**: Establish metrics storage layer with SQLite, downsampling, and retention management
**Requirements**: STOR-01, STOR-02, STOR-03, STOR-04, DATA-05
**Completed**: 2026-01-25
**Plans**: 38-01, 38-02

**Key Results:**
- MetricsWriter singleton with thread-safe WAL mode
- STORED_METRICS dict with 7 Prometheus-compatible names
- Retention cleanup with batch processing (10000 rows/txn)
- Downsampling: raw→1m (1h), 1m→5m (1d), 5m→1h (7d)
- 92 new tests, 94.1% coverage

### Phase 39: Data Recording ✓

**Goal**: Both daemons capture metrics each cycle with minimal performance impact
**Requirements**: DATA-01, DATA-02, DATA-03, DATA-04, INTG-01, INTG-02, INTG-03
**Completed**: 2026-01-25
**Plans**: 39-01, 39-02

**Key Results:**
- Autorate: 6 metrics/cycle (RTT, baseline, delta, rates, state)
- Steering: 5 metrics/cycle (RTT, baseline, delta, enabled, state)
- State transitions with reason strings
- Config snapshots on startup
- <5ms overhead (~1ms avg, <2% of 50ms cycle)
- 32 new tests

### Phase 40: CLI Tool ✓

**Goal**: `wanctl-history` command provides human and machine access to stored metrics
**Requirements**: CLI-01, CLI-02, CLI-03, CLI-04, CLI-05
**Completed**: 2026-01-25
**Plans**: 40-01, 40-02

**Key Results:**
- wanctl-history entry point registered
- Time range queries: --last, --from/--to
- Metric and WAN filtering
- Output modes: table, JSON, summary
- Auto-granularity selection
- 82 new tests (35 reader + 47 CLI)

### Phase 41: API Endpoint ✓

**Goal**: HTTP endpoint enables programmatic access to metrics history
**Requirements**: API-01, API-02, API-03, API-04
**Completed**: 2026-01-25
**Plans**: 41-01

**Key Results:**
- /metrics/history endpoint on port 9101
- Query params: range, from, to, metrics, wan, limit, offset
- JSON response with ISO 8601 timestamps
- Pagination with metadata
- 30 new tests

### Phase 42: Maintenance Scheduling ✓

**Goal**: Wire cleanup and downsampling functions to daemon startup
**Gap Closure**: Tech debt from Phase 38 (functions implemented but not scheduled)
**Completed**: 2026-01-25
**Plans**: 42-01

**Key Results:**
- run_startup_maintenance() orchestrates cleanup + vacuum + downsample
- Wired to both daemons (after record_config_snapshot, before main loop)
- Graceful error handling (logs, doesn't block startup)
- Database stays bounded, downsampled data available
- 12 new tests

## Requirement Coverage

| Requirement | Phase | Description | Status |
|-------------|-------|-------------|--------|
| STOR-01 | 38 | SQLite at /var/lib/wanctl/metrics.db | ✓ Complete |
| STOR-02 | 38 | Configurable retention (default 7 days) | ✓ Complete |
| STOR-03 | 38 | Automatic downsampling | ✓ Complete |
| STOR-04 | 38 | Cleanup expired data on startup | ✓ Complete |
| DATA-01 | 39 | Record RTT metrics each cycle | ✓ Complete |
| DATA-02 | 39 | Record rate metrics each cycle | ✓ Complete |
| DATA-03 | 39 | Record state transitions with reason | ✓ Complete |
| DATA-04 | 39 | Config snapshot on startup/reload | ✓ Complete |
| DATA-05 | 38 | Prometheus-compatible naming | ✓ Complete |
| CLI-01 | 40 | wanctl-history command | ✓ Complete |
| CLI-02 | 40 | Query by time range | ✓ Complete |
| CLI-03 | 40 | Filter by metric type | ✓ Complete |
| CLI-04 | 40 | Table and JSON output | ✓ Complete |
| CLI-05 | 40 | Summary statistics mode | ✓ Complete |
| API-01 | 41 | /metrics/history endpoint | ✓ Complete |
| API-02 | 41 | Query params (range, from, to, etc.) | ✓ Complete |
| API-03 | 41 | JSON response with timestamps | ✓ Complete |
| API-04 | 41 | Pagination support | ✓ Complete |
| INTG-01 | 39 | Autorate daemon records metrics | ✓ Complete |
| INTG-02 | 39 | Steering daemon records metrics | ✓ Complete |
| INTG-03 | 39 | Performance impact <5ms | ✓ Complete |

**Coverage:** 21/21 requirements satisfied (100%)

## Technical Decisions

- SQLite for storage (simple, no external deps, good for time-series)
- Downsampling strategy: 1s → 1m → 5m → 1h as data ages
- Use isolation_level=None for WAL mode (Python 3.12+ compatibility)
- MetricsWriter singleton with _reset_instance for test isolation
- Batch deletion in 10000-row chunks to avoid blocking daemon
- MODE aggregation for state metrics, AVG for RTT/rate
- VACUUM only after 100000+ deletions (expensive operation)
- Read-only connection mode (?mode=ro) for query operations
- Use statistics.quantiles() from stdlib for percentile calculation
- Granularity auto-selection: raw<6h<1m<24h<5m<7d<1h
- CLI default time range: --last 1h when no args
- HTTP API on /metrics/history (existing port 9101)
- Python-side pagination (offset/limit after full query)

## Files Created

**Storage Module (src/wanctl/storage/):**
- `__init__.py` — Module exports
- `schema.py` — METRICS_SCHEMA, STORED_METRICS, create_tables()
- `writer.py` — MetricsWriter singleton
- `retention.py` — cleanup_old_metrics(), vacuum_if_needed()
- `downsampler.py` — downsample_metrics(), DOWNSAMPLE_THRESHOLDS
- `reader.py` — query_metrics(), compute_summary(), select_granularity()
- `config_snapshot.py` — record_config_snapshot()
- `maintenance.py` — run_startup_maintenance()

**CLI (src/wanctl/):**
- `history.py` — wanctl-history entry point

**Tests (12 files, 237 tests):**
- test_storage_schema.py, test_storage_writer.py, test_storage_retention.py
- test_storage_downsampler.py, test_storage_maintenance.py
- test_autorate_metrics_recording.py, test_steering_metrics_recording.py
- test_config_snapshot.py, test_metrics_reader.py, test_history_cli.py
- test_health_check_history.py

---

_Shipped: 2026-01-25_
_Archived: 2026-01-26_
