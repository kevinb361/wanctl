# v1.8 Resilience & Robustness Roadmap

## Overview

v1.8 ensures wanctl behaves correctly when things go wrong. The milestone covers error recovery (router unreachable, connection drops), graceful shutdown (SIGTERM handling, state consistency), and contract tests (mock accuracy against real RouterOS responses).

## Phases

- [x] **Phase 43: Error Detection & Reconnection** - Handle router unreachable and connection drops gracefully
- [ ] **Phase 44: Fail-Safe Behavior** - Ensure rate limits persist and watchdog tolerates transient failures
- [ ] **Phase 45: Graceful Shutdown** - Clean daemon termination with state and connection consistency
- [ ] **Phase 46: Contract Tests** - Golden files for RouterOS response formats with drift detection

## Phase Details

### Phase 43: Error Detection & Reconnection

**Goal**: Controller detects mid-cycle router failures and reconnects without crashing
**Depends on**: Nothing (first phase of v1.8)
**Requirements**: ERRR-01, ERRR-02
**Success Criteria** (what must be TRUE):

1. Controller continues running when router becomes unreachable during a cycle
2. Controller logs clear error messages when router connection fails
3. Controller automatically reconnects when router becomes reachable again
4. No unhandled exceptions propagate from router communication failures
   **Plans**: 3 plans

Plans:

- [x] 43-01-PLAN.md - RouterConnectivityState class and classify_failure_type (TDD)
- [x] 43-02-PLAN.md - Integrate connectivity tracking into WANController and SteeringDaemon
- [x] 43-03-PLAN.md - Update health endpoints with router connectivity reporting

### Phase 44: Fail-Safe Behavior

**Goal**: Rate limits are never removed on error and watchdog handles transient failures gracefully
**Depends on**: Phase 43
**Requirements**: ERRR-03, ERRR-04
**Success Criteria** (what must be TRUE):

1. When router communication fails, existing rate limits remain in place (fail-closed)
2. Controller never sends "remove limit" commands during error conditions
3. Watchdog distinguishes between crash-worthy and transient failures
4. Controller survives multiple consecutive router timeouts without restart
   **Plans**: 2 plans

Plans:

- [ ] 44-01-PLAN.md - PendingRateChange class and fail-closed integration
- [ ] 44-02-PLAN.md - Watchdog distinction and recovery behavior

### Phase 45: Graceful Shutdown

**Goal**: Daemons terminate cleanly with consistent state and no orphaned resources
**Depends on**: Phase 44
**Requirements**: SHUT-01, SHUT-02, SHUT-03, SHUT-04
**Success Criteria** (what must be TRUE):

1. SIGTERM triggers clean shutdown (daemon exits 0, not killed)
2. In-flight router commands either complete or abort without partial state
3. State files are consistent after shutdown (no truncation, no corruption)
4. All router connections are closed before daemon exits
5. Shutdown completes within reasonable timeout (not hung indefinitely)
   **Plans**: TBD

### Phase 46: Contract Tests

**Goal**: Mocks match real RouterOS response formats with documented golden files
**Depends on**: Phase 45
**Requirements**: CNTR-01, CNTR-02, CNTR-03, CNTR-04
**Success Criteria** (what must be TRUE):

1. Golden files document expected REST API response format (queue, mangle, CAKE stats)
2. Golden files document expected SSH command output format
3. Tests fail if mocks return data inconsistent with golden files
4. RouterOS version compatibility is tracked (which versions these formats apply to)
   **Plans**: TBD

## Progress

| Phase                              | Plans Complete | Status      | Completed  |
| ---------------------------------- | -------------- | ----------- | ---------- |
| 43. Error Detection & Reconnection | 3/3            | Complete    | 2026-01-29 |
| 44. Fail-Safe Behavior             | 0/2            | Planned     | -          |
| 45. Graceful Shutdown              | 0/?            | Not started | -          |
| 46. Contract Tests                 | 0/?            | Not started | -          |

---

_Roadmap created: 2026-01-29_
_Milestone: v1.8 Resilience & Robustness_
_Phases: 43-46 (continuing from v1.7 phase 42)_
