# v1.6 Roadmap: Test Coverage 90%

## Overview

Increase test coverage from 45.7% statement / 72% branch to 90%+ with CI enforcement. Phases progress from infrastructure setup through systematic module coverage, ordered by dependency (backends first, then utilities, then control loops).

## Phases

- [ ] **Phase 31: Coverage Infrastructure** - Threshold enforcement and CI integration
- [ ] **Phase 32: Backend Client Tests** - RouterOS REST/SSH client coverage
- [ ] **Phase 33: State & Infrastructure Tests** - State manager and utility modules
- [ ] **Phase 34: Metrics & Measurement Tests** - Metrics, CAKE stats, RTT measurement
- [ ] **Phase 35: Core Controller Tests** - Main autorate control loop coverage
- [ ] **Phase 36: Steering Daemon Tests** - Steering daemon lifecycle and logic
- [ ] **Phase 37: CLI Tool Tests** - Calibrate and profiler tools

## Phase Details

### Phase 31: Coverage Infrastructure

**Goal**: CI fails if coverage drops below 90%, coverage measurement accurate
**Depends on**: Nothing (first phase)
**Requirements**: COV-01, COV-02, COV-03
**Success Criteria** (what must be TRUE):
  1. `pytest --cov` reports fail_under=90 in pyproject.toml
  2. `make ci` exits non-zero when coverage < 90%
  3. Coverage badge in README shows 90% threshold
**Plans**: 1 plan (simple config changes)

Plans:
- [ ] 31-01: Configure coverage threshold and CI enforcement

### Phase 32: Backend Client Tests

**Goal**: RouterOS client backends have comprehensive test coverage
**Depends on**: Phase 31 (coverage measurement active)
**Requirements**: BACK-01, BACK-02, BACK-03, BACK-04, BACK-05, BACK-06
**Success Criteria** (what must be TRUE):
  1. routeros_rest.py coverage >= 90% (from 9%)
  2. routeros_ssh.py coverage >= 90% (from 18%)
  3. backends/base.py coverage >= 90% (from 0%)
  4. All HTTP request/response paths tested with mocks
  5. SSH command execution paths tested with mocks
**Plans**: 2 plans (REST client, SSH client + base)

Plans:
- [ ] 32-01: REST client test coverage (routeros_rest.py)
- [ ] 32-02: SSH client and base class test coverage

### Phase 33: State & Infrastructure Tests

**Goal**: State management and infrastructure utilities have comprehensive coverage
**Depends on**: Phase 31
**Requirements**: STATE-01, STATE-02, STATE-03, STATE-04, INFRA-01, INFRA-02, INFRA-03, INFRA-04, INFRA-05
**Success Criteria** (what must be TRUE):
  1. state_manager.py coverage >= 90% (from 39%)
  2. State persistence save/load verified with file I/O mocks
  3. Concurrent access and locking behavior tested
  4. error_handling.py coverage >= 90% (from 21%)
  5. signal_utils.py, systemd_utils.py, path_utils.py all >= 90%
**Plans**: 2 plans (state management, infrastructure utilities)

Plans:
- [ ] 33-01: State manager test coverage
- [ ] 33-02: Infrastructure utilities test coverage

### Phase 34: Metrics & Measurement Tests

**Goal**: Metrics collection and measurement modules have comprehensive coverage
**Depends on**: Phase 31
**Requirements**: MEAS-01, MEAS-02, MEAS-03, MEAS-04, MEAS-05, MEAS-06
**Success Criteria** (what must be TRUE):
  1. metrics.py coverage >= 90% (from 26%)
  2. steering/cake_stats.py coverage >= 90% (from 24%)
  3. rtt_measurement.py coverage >= 90% (from 67%)
  4. CAKE statistics parsing edge cases tested
  5. RTT measurement failure and edge cases covered
**Plans**: 2 plans (metrics + CAKE stats, RTT measurement)

Plans:
- [ ] 34-01: Metrics and CAKE stats test coverage
- [ ] 34-02: RTT measurement test coverage

### Phase 35: Core Controller Tests

**Goal**: Main autorate control loop has comprehensive test coverage
**Depends on**: Phases 32, 33, 34 (dependencies must be testable first)
**Requirements**: CORE-01, CORE-02, CORE-03, CORE-04, CORE-05
**Success Criteria** (what must be TRUE):
  1. autorate_continuous.py coverage >= 90% (from 33%)
  2. main() entry point paths tested (startup, shutdown, config errors)
  3. Signal handlers (SIGTERM, SIGHUP) tested with mocks
  4. Control loop state transitions verified (GREEN/YELLOW/RED)
  5. Error recovery paths tested (router failures, measurement failures)
**Plans**: 3 plans (entry points + signals, state transitions, error recovery)

Plans:
- [ ] 35-01: Main entry point and signal handler tests
- [ ] 35-02: Control loop state transition tests
- [ ] 35-03: Error recovery path tests

### Phase 36: Steering Daemon Tests

**Goal**: Steering daemon has comprehensive test coverage
**Depends on**: Phases 32, 33, 34 (dependencies must be testable first)
**Requirements**: STEER-01, STEER-02, STEER-03, STEER-04, STEER-05
**Success Criteria** (what must be TRUE):
  1. steering/daemon.py coverage >= 90% (from 44%)
  2. Daemon lifecycle (start/stop/restart) tested
  3. Routing decision logic tested with various inputs
  4. Confidence-based steering paths verified
  5. Congestion assessment integration tested
**Plans**: 2 plans (lifecycle + routing, confidence + congestion)

Plans:
- [ ] 36-01: Daemon lifecycle and routing decision tests
- [ ] 36-02: Confidence-based steering and congestion tests

### Phase 37: CLI Tool Tests

**Goal**: CLI tools have comprehensive test coverage
**Depends on**: Phase 31 (no other dependencies, standalone tools)
**Requirements**: CLI-01, CLI-02, CLI-03, CLI-04
**Success Criteria** (what must be TRUE):
  1. calibrate.py coverage >= 90% (from 0%)
  2. Calibration workflow tested end-to-end with mocks
  3. perf_profiler.py coverage >= 90% (from 0%)
  4. CLI argument parsing tested for all tools
**Plans**: 2 plans (calibrate tool, profiler tool)

Plans:
- [ ] 37-01: Calibrate tool test coverage
- [ ] 37-02: Performance profiler test coverage

## Progress

| Phase | Plans Complete | Status | Completed |
|-------|----------------|--------|-----------|
| 31. Coverage Infrastructure | 0/1 | Not started | - |
| 32. Backend Client Tests | 0/2 | Not started | - |
| 33. State & Infrastructure Tests | 0/2 | Not started | - |
| 34. Metrics & Measurement Tests | 0/2 | Not started | - |
| 35. Core Controller Tests | 0/3 | Not started | - |
| 36. Steering Daemon Tests | 0/2 | Not started | - |
| 37. CLI Tool Tests | 0/2 | Not started | - |

**Total:** 7 phases, 14 plans

## Coverage Mapping

| Category | Requirements | Phase | Count |
|----------|--------------|-------|-------|
| Coverage Infrastructure | COV-01, COV-02, COV-03 | 31 | 3 |
| Backend Client Tests | BACK-01 to BACK-06 | 32 | 6 |
| State Management Tests | STATE-01 to STATE-04 | 33 | 4 |
| Infrastructure Tests | INFRA-01 to INFRA-05 | 33 | 5 |
| Metrics & Measurement Tests | MEAS-01 to MEAS-06 | 34 | 6 |
| Core Controller Tests | CORE-01 to CORE-05 | 35 | 5 |
| Steering Daemon Tests | STEER-01 to STEER-05 | 36 | 5 |
| CLI Tool Tests | CLI-01 to CLI-04 | 37 | 4 |

**Total:** 38 requirements mapped to 7 phases
