---
milestone: v1.3
audited: 2026-01-21T15:30:00Z
status: gaps_found
scores:
  requirements: 8/8
  phases: 3/3
  integration: 2/4
  flows: 2/4
gaps:
  integration:
    - "FailoverRouterClient implemented but not wired into production"
    - "validate-deployment.sh created but not called by deploy flow"
  flows:
    - "REST failover flow breaks at step 2 (no fallback in production)"
    - "Deployment validation flow breaks at step 3 (script never invoked)"
tech_debt:
  - phase: 21-critical-safety-tests
    items:
      - "BaselineRTTManager class tested but not used (inline implementation in WANController)"
      - "No integration test for failover against real RouterOS"
---

# v1.3 Milestone Audit Report

**Milestone:** v1.3 Reliability & Hardening
**Audited:** 2026-01-21T15:30:00Z
**Status:** gaps_found

## Executive Summary

All 8 requirements are satisfied at the unit test level, and all 3 phases passed verification. However, integration checking revealed that **2 key features are implemented but not wired into production**:

1. **FailoverRouterClient** (TEST-03) - Tested but production uses non-failover client
2. **validate-deployment.sh** (DEPLOY-03) - Created but never called

These gaps mean the safety guarantees proven by tests are **not active in production**.

## Requirements Coverage

| Requirement | Phase | Status | Notes |
|-------------|-------|--------|-------|
| TEST-01 | 21 | ✓ Complete | Baseline freeze tested (but see tech debt) |
| TEST-02 | 21 | ✓ Complete | State corruption recovery active in production |
| TEST-03 | 21 | ⚠ Partial | Implemented + tested, NOT wired into production |
| DEPLOY-01 | 22 | ✓ Complete | steering.yaml is canonical name |
| DEPLOY-02 | 22 | ✓ Complete | deploy.sh fails fast on missing config |
| DEPLOY-03 | 22 | ⚠ Partial | Script exists, NOT called by any flow |
| TEST-04 | 23 | ✓ Complete | Rate limiter burst protection proven |
| TEST-05 | 23 | ✓ Complete | Dual fallback safe defaults proven |

**Score:** 6/8 fully complete, 2/8 partial (implemented but not integrated)

## Phase Verification Summary

| Phase | Status | Score | Key Deliverables |
|-------|--------|-------|------------------|
| 21 | passed | 3/3 | Safety invariant tests, FailoverRouterClient |
| 22 | passed | 4/4 | Fail-fast deploy, validation script |
| 23 | passed | 4/4 | Edge case tests |

All phases passed their individual verifications.

## Integration Analysis

### Connected (Working)

| From | To | Via | Status |
|------|----|-----|--------|
| state_utils.py | state_manager.py | safe_json_load_file import | ✓ Active |
| state_utils.py | wan_controller_state.py | safe_json_load_file import | ✓ Active |
| deploy.sh | configs/steering.yaml | existence check | ✓ Active |
| test_rate_limiter.py | rate_utils.py | RateLimiter import | ✓ Active |

### Orphaned (Not Wired)

| Export | Location | Problem |
|--------|----------|---------|
| FailoverRouterClient | router_client.py:119 | Production uses get_router_client(), not get_router_client_with_failover() |
| get_router_client_with_failover | router_client.py:240 | Never called by production code |
| validate-deployment.sh | scripts/ | Not called by deploy.sh, systemd, or install.sh |
| BaselineRTTManager | baseline_rtt_manager.py | Tests exist, but WANController has inline implementation |

## E2E Flow Analysis

### Flow 1: State Corruption Recovery ✓
`corrupted file` → `safe_json_load_file()` → `default returned` → `daemon continues`

**Status:** COMPLETE - Active in production

### Flow 2: Fail-Fast Deployment ✓
`deploy.sh --with-steering` → `steering.yaml check` → `exit 1 if missing`

**Status:** COMPLETE - Active in production

### Flow 3: REST Failover ✗
`REST failure` → `SSH fallback` → `operation completes`

**Status:** BROKEN at step 2
- Production code at `autorate_continuous.py:539` uses `get_router_client()`
- Returns `RouterOSREST` or `RouterOSSSH`, not `FailoverRouterClient`
- REST API failure will crash daemon instead of falling back

### Flow 4: Deployment Validation ✗
`deploy.sh` → `validate-deployment.sh` → `daemon start`

**Status:** BROKEN at step 2
- `validate-deployment.sh` exists (423 lines)
- Never called by `deploy.sh`, systemd, or any automated flow
- Operators must manually run validation

## Critical Gaps

### Gap 1: FailoverRouterClient Not Active

**Impact:** REST API failures crash the daemon instead of falling back to SSH.

**Fix Required:** Change 3 files to use `get_router_client_with_failover()`:
- `src/wanctl/autorate_continuous.py:539`
- `src/wanctl/steering/daemon.py:475`
- `src/wanctl/steering/cake_stats.py:53`

### Gap 2: validate-deployment.sh Not Called

**Impact:** Pre-startup validation exists but isn't automated. Silent failures remain possible.

**Fix Required:** Add validation call to `deploy.sh`:
```bash
ssh "$TARGET_HOST" "/opt/wanctl/scripts/validate-deployment.sh $CONFIG_PATH"
```

Or add to systemd unit's `ExecStartPre`.

## Tech Debt

### Pre-existing (Not introduced by v1.3)

1. **BaselineRTTManager divergence** - Class is tested but `WANController` uses inline implementation. Tests prove invariants for unused code.

### New (From v1.3)

2. **No integration test for failover** - Unit tests with mocks pass, but no test against actual RouterOS or simulator verifies real failover behavior.

## Test Count Verification

| Phase | Tests Added | Total After |
|-------|-------------|-------------|
| 21-01 | +17 | 701 |
| 21-02 | +16 | 717 |
| 22-01 | 0 | 717 |
| 23-01 | +10 | 727 |

**Final count:** 727 tests (verified by pytest)

## Recommendations

### Must Fix Before Milestone Completion

1. **Wire FailoverRouterClient** - 3 lines changed, activates TEST-03 safety in production
2. **Wire validate-deployment.sh** - Add to deploy.sh or systemd, activates DEPLOY-03

### Can Defer to v1.4

3. **Resolve BaselineRTTManager** - Either use the class or move tests to inline implementation
4. **Add failover integration test** - Test against real RouterOS

## Conclusion

v1.3 achieved its goal of closing test coverage gaps and improving deployment safety. All requirements are satisfied at the code level. However, 2 critical integrations are missing:

- **TEST-03 (failover):** Proven by tests, NOT active in production
- **DEPLOY-03 (validation):** Script exists, NOT called automatically

**Recommendation:** Plan gap closure to wire these features before completing milestone.

---

_Audited: 2026-01-21T15:30:00Z_
_Auditor: Claude (gsd-integration-checker)_
